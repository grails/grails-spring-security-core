<html>
    <head>
        <title>Spring Security Core Plugin 1.2 - Reference Documentation</title>
        <link rel="stylesheet" href="../css/main.css" type="text/css" media="screen" title="Style" charset="utf-8"/>
        <link rel="stylesheet" href="../css/pdf.css" type="text/css" media="print" title="PDF" charset="utf-8" />
    </head>
    <body class="body">
        <div id="header">
            <div class="images"><br/><br/>
                <a href="http://grails.org" target="_blank"><img alt="The Grails Framework" src="../img/grails.png" border="0"/></a>
                <span style="right:30px; top:20px; position:absolute;">
                    <a href="../index.html" target="_top">Frames</a> | <a href="index.html" target="_top">No Frames</a><br/><br/>
                    <a href="http://springsource.com" target="_blank"><img alt="SpringSource - A Division of VMware" src="../img/springsource-logo.png" border="0"/></a>
                </span>
            </div>
            <div class="message">spring-security-core</div>
            <h1>Spring Security Core Plugin - Reference Documentation</h1>
            <p><strong>Authors:</strong> Burt Beckwith, Beverley Talbott</p>
            <p><strong>Version:</strong> 1.2</p>
            <em></em>
        </div>

        <div id="toc">
            <h2>Table of Contents</h2>
            <div class="tocItem" style="margin-left:0px"><a href="#1 Introduction to the Spring Security Plugin">1 Introduction to the Spring Security Plugin</a></div><div class="tocItem" style="margin-left:10px"><a href="#1.1 Configuration Settings Now in Config.groovy">1.1 Configuration Settings Now in Config.groovy</a></div><div class="tocItem" style="margin-left:10px"><a href="#1.2 Getting Started">1.2 Getting Started</a></div><div class="tocItem" style="margin-left:0px"><a href="#2 Differences Between the Spring Security and Acegi Plugins">2 Differences Between the Spring Security and Acegi Plugins</a></div><div class="tocItem" style="margin-left:0px"><a href="#3 Migrating from the Acegi Plugin">3 Migrating from the Acegi Plugin</a></div><div class="tocItem" style="margin-left:0px"><a href="#4 Required and Optional Domain Classes">4 Required and Optional Domain Classes</a></div><div class="tocItem" style="margin-left:10px"><a href="#4.1 Person Class">4.1 Person Class</a></div><div class="tocItem" style="margin-left:10px"><a href="#4.2 Authority Class">4.2 Authority Class</a></div><div class="tocItem" style="margin-left:10px"><a href="#4.3 PersonAuthority Class">4.3 PersonAuthority Class</a></div><div class="tocItem" style="margin-left:10px"><a href="#4.4 Requestmap Class">4.4 Requestmap Class</a></div><div class="tocItem" style="margin-left:0px"><a href="#5 Configuring Request Mappings to Secure URLs">5 Configuring Request Mappings to Secure URLs</a></div><div class="tocItem" style="margin-left:10px"><a href="#5.1 Defining Secured Annotations">5.1 Defining Secured Annotations</a></div><div class="tocItem" style="margin-left:10px"><a href="#5.2 Simple Map in Config.groovy">5.2 Simple Map in Config.groovy</a></div><div class="tocItem" style="margin-left:10px"><a href="#5.3 Requestmap Instances Stored in the Database">5.3 Requestmap Instances Stored in the Database</a></div><div class="tocItem" style="margin-left:10px"><a href="#5.4 Using Expressions to Create Descriptive, Fine-Grained Rules">5.4 Using Expressions to Create Descriptive, Fine-Grained Rules</a></div><div class="tocItem" style="margin-left:0px"><a href="#6 Helper Classes">6 Helper Classes</a></div><div class="tocItem" style="margin-left:10px"><a href="#6.1 SecurityTagLib">6.1 SecurityTagLib</a></div><div class="tocItem" style="margin-left:10px"><a href="#6.2 SpringSecurityService">6.2 SpringSecurityService</a></div><div class="tocItem" style="margin-left:10px"><a href="#6.3 SpringSecurityUtils">6.3 SpringSecurityUtils</a></div><div class="tocItem" style="margin-left:0px"><a href="#7 Events">7 Events</a></div><div class="tocItem" style="margin-left:10px"><a href="#7.1 Event Notification">7.1 Event Notification</a></div><div class="tocItem" style="margin-left:10px"><a href="#7.2 Registering an Event Listener">7.2 Registering an Event Listener</a></div><div class="tocItem" style="margin-left:10px"><a href="#7.3 Registering Callback Closures">7.3 Registering Callback Closures</a></div><div class="tocItem" style="margin-left:0px"><a href="#8 User, Authority (Role), and Requestmap Properties">8 User, Authority (Role), and Requestmap Properties</a></div><div class="tocItem" style="margin-left:0px"><a href="#9 Authentication">9 Authentication</a></div><div class="tocItem" style="margin-left:10px"><a href="#9.1 Basic and Digest Authentication">9.1 Basic and Digest Authentication</a></div><div class="tocItem" style="margin-left:10px"><a href="#9.2 Certificate (X509) Login Authentication">9.2 Certificate (X509) Login Authentication</a></div><div class="tocItem" style="margin-left:10px"><a href="#9.3 Remember-Me Cookie">9.3 Remember-Me Cookie</a></div><div class="tocItem" style="margin-left:10px"><a href="#9.4 Ajax Authentication">9.4 Ajax Authentication</a></div><div class="tocItem" style="margin-left:0px"><a href="#10 Authentication Providers">10 Authentication Providers</a></div><div class="tocItem" style="margin-left:0px"><a href="#11 Custom UserDetailsService">11 Custom UserDetailsService</a></div><div class="tocItem" style="margin-left:0px"><a href="#12 Password and Account Protection">12 Password and Account Protection</a></div><div class="tocItem" style="margin-left:10px"><a href="#12.1 Password Encryption">12.1 Password Encryption</a></div><div class="tocItem" style="margin-left:10px"><a href="#12.2 Salted Passwords">12.2 Salted Passwords</a></div><div class="tocItem" style="margin-left:10px"><a href="#12.3 Account Locking and Forcing Password Change">12.3 Account Locking and Forcing Password Change</a></div><div class="tocItem" style="margin-left:0px"><a href="#13 URL Properties">13 URL Properties</a></div><div class="tocItem" style="margin-left:0px"><a href="#14 Hierarchical Roles">14 Hierarchical Roles</a></div><div class="tocItem" style="margin-left:0px"><a href="#15 Switch User">15 Switch User</a></div><div class="tocItem" style="margin-left:0px"><a href="#16 Filters">16 Filters</a></div><div class="tocItem" style="margin-left:0px"><a href="#17 Channel Security">17 Channel Security</a></div><div class="tocItem" style="margin-left:0px"><a href="#18 IP Address Restrictions">18 IP Address Restrictions</a></div><div class="tocItem" style="margin-left:0px"><a href="#19 Session Fixation Prevention">19 Session Fixation Prevention</a></div><div class="tocItem" style="margin-left:0px"><a href="#20 Logout Handlers">20 Logout Handlers</a></div><div class="tocItem" style="margin-left:0px"><a href="#21 Voters">21 Voters</a></div><div class="tocItem" style="margin-left:0px"><a href="#22 Miscellaneous Properties">22 Miscellaneous Properties</a></div><div class="tocItem" style="margin-left:0px"><a href="#23 Tutorials">23 Tutorials</a></div><div class="tocItem" style="margin-left:10px"><a href="#23.1 Using Controller Annotations to Secure URLs">23.1 Using Controller Annotations to Secure URLs</a></div><div class="tocItem" style="margin-left:10px"><a href="#23.2 Migration From the Acegi Plugin">23.2 Migration From the Acegi Plugin</a></div><div class="tocItem" style="margin-left:0px"><a href="#24 Controller MetaClass Methods">24 Controller MetaClass Methods</a></div><div class="tocItem" style="margin-left:0px"><a href="#25 Internationalization">25 Internationalization</a></div>
        </div>
        <div id="content">
            <h1><a name="1 Introduction to the Spring Security Plugin">1 Introduction to the Spring Security Plugin</a></h1>The Spring Security plugin simplifies the integration of  <a href="http://static.springsource.org/spring-security/site/index.html" target="blank">Spring Security</a> (formerly Acegi Security) into Grails applications. The plugin provides sensible defaults with many configuration options for customization. Nearly everything is configurable or replaceable in the plugin and in Spring Security itself, which makes extensive use of interfaces.<p class="paragraph"/>This guide documents configuration defaults and describes how to configure and extend the Spring Security plugin for Grails applications.<p class="paragraph"/><h4>Release History and Acknowledgment</h4>
<ul class="star">
<li>July 31, 2011</li>
<ul class="star">
<li>1.2 release</li>
</ul>
<li>May 23, 2011</li>
<ul class="star">
<li>1.1.3 release</li>
</ul>
<li>February 26, 2011</li>
<ul class="star">
<li>1.1.2 release</li>
</ul>
<li>February 26, 2011</li>
<ul class="star">
<li>1.1.1 release</li>
</ul>
<li>August 8, 2010</li>
<ul class="star">
<li>1.1 release</li>
</ul>
<li>August 1, 2010</li>
<ul class="star">
<li>1.0.1 release</li>
</ul>
<li>July 27, 2010</li>
<ul class="star">
<li>1.0 release</li>
</ul>
<li>July 16, 2010</li>
<ul class="star">
<li>0.4.2 release</li>
</ul>
<li>June 29, 2010</li>
<ul class="star">
<li>0.4.1 release</li>
</ul>
<li>June 21, 2010</li>
<ul class="star">
<li>0.4 release</li>
</ul>
<li>May 12, 2010</li>
<ul class="star">
<li>0.3.1 release</li>
</ul>
<li>May 12, 2010</li>
<ul class="star">
<li>0.3 release</li>
</ul>
<li>May 2, 2010</li>
<ul class="star">
<li>0.2 release</li>
</ul>
<li>April 27, 2010</li>
<ul class="star">
<li>initial 0.1 release</li>
</ul></ul><p class="paragraph"/>This plugin is based on work done for the <a href="http://grails.org/plugin/acegi/" target="blank">Acegi</a> plugin by Tsuyoshi Yamamoto.
<h2><a name="1.1 Configuration Settings Now in Config.groovy">1.1 Configuration Settings Now in Config.groovy</a></h2>Unlike the Acegi plugin, which used its own configuration file, <code>SecurityConfig.groovy</code>, the Spring Security plugin maintains its configuration in the standard <code>Config.groovy</code> file. Default values are in the plugin's <code>grails-app/conf/DefaultSecurityConfig.groovy</code> file, and you add application-specific values to the <code>grails-app/conf/Config.groovy</code> file. The two configurations will be merged, with application values overriding the defaults.<p class="paragraph"/>This structure enables environment-specific configuration such as, for example, fewer structure-restrictive security rules during development than in production. Like any environment-specific configuration parameters, you wrap them in an <code>environments</code> block.<p class="paragraph"/><blockquote class="note">
The plugin's configuration values all start with <code>grails.plugins.springsecurity</code> to distinguish them from similarly named options in Grails and from other plugins. You must specify all property overrides with the <code>grails.plugins.springsecurity</code> suffix. For example, you specify the attribute <code>password.algorithm</code> as:<p class="paragraph"/><div class="code"><pre>grails.plugins.springsecurity.password.algorithm='SHA&#45;512'</pre></div><p class="paragraph"/>in <code>Config.groovy</code>
</blockquote>
<h2><a name="1.2 Getting Started">1.2 Getting Started</a></h2>If you will be migrating from the Acegi to the Spring Security plugin, see <a href="../guide/single.html#3 Migrating from the Acegi Plugin" class="guide">Migrating from the Acegi Plugin</a>.<p class="paragraph"/>Once you install the plugin, you simply run the initialization script, <a href="../ref/Scripts/s2-quickstart.html" class="Scripts">s2-quickstart</a>, and make any required configuration changes in <code>Config.groovy</code>. The plugin registers filters in <code>web.xml</code>, and also configures the Spring beans in the application context that implement various pieces of functionality.  Ivy determines which jar files to use.<p class="paragraph"/>To get started using the Spring Security plugin with your Grails application, see  <a href="../guide/single.html#23 Tutorials" class="guide">Tutorials</a>.<p class="paragraph"/>You do not need to know much about Spring Security to use the plugin, but it can be helpful to understand the underlying implementation. See <a href="http://static.springsource.org/spring-security/site/reference.html" target="blank">the Spring Security documentation</a>.<h1><a name="2 Differences Between the Spring Security and Acegi Plugins">2 Differences Between the Spring Security and Acegi Plugins</a></h1>The Spring Security plugin is a successor to the <a href="http://grails.org/plugin/acegi/" target="blank">Acegi plugin</a>. The sections that follow compare the two.<p class="paragraph"/><h4>Core Similarities and Differences</h4><p class="paragraph"/>The Spring Security plugin retains many core features of the Acegi plugin:
<ul class="star">
<li>Form-based authentication</li>
<li>Storing users, roles, and optionally requestmaps in the database, with access through domain classes</li>
<li>Guarding URLs with annotations, requestmap domain class, or static configuration</li>
<li>Security tags</li>
<li>Security service</li>
<li>Security events</li>
<li>Ajax login</li>
<li>Basic authentication</li>
<li>Switch User</li>
<li>Channel security</li>
<li>IP address restrictions</li>
</ul><p class="paragraph"/>and adds several new features:
<ul class="star">
<li>Digest authentication</li>
<li>Session Fixation Prevention</li>
<li>Salted passwords</li>
<li>Certificate (x509) login</li>
<li>Hierarchical roles</li>
<li>Account locking and forcing password change</li>
</ul><p class="paragraph"/><h4>Features Not Included in the Spring Security Plugin</h4><p class="paragraph"/>The following features are not included in the Spring Security plugin, but are (or will be) available in secondary plugins that extend and depend on the core plugin:
<ul class="star">
<li><a href="http://grails.org/plugin/spring-security-openid" target="blank">OpenID</a></li>
<li><a href="http://grails.org/plugin/spring-security-acl" target="blank">ACL</a></li>
<li><a href="http://grails.org/plugin/spring-security-ldap" target="blank">LDAP</a></li>
<li><a href="http://grails.org/plugin/spring-security-cas" target="blank">CAS</a></li>
<li>User registration</li>
<li>Facebook</li>
<li>NTLM</li>
<li>Kerberos</li>
</ul><p class="paragraph"/><h4>Script Differences</h4><p class="paragraph"/>To initialize the Acegi plugin, you run <code>create-auth-domains</code>. This initialization creates <code>grails-app/conf/SecurityConfig.groovy</code> to allow configuration customization; creates the User, Role, and Requestmap domain classes; and creates the Login and Logout controllers and views. Another Acegi script, <code>generate-manager</code>, creates CRUD pages for the domain classes. (The earlier version of Grails did not scaffold many-to-many relationships well, so these GSPs were necessary.)In addition, a <code>generate-registration</code> script installs a basic user registration controller.<p class="paragraph"/>The Spring Security plugin uses only one script, <a href="../ref/Scripts/s2-quickstart.html" class="Scripts">s2-quickstart</a>. It is similar to <code>create-auth-domains</code> because it creates domain classes and login and logout bcontrollers, but it appends files to <code>grails-app/conf/Config.groovy</code> instead of creating a standalone configuration file. There is no equivalent to <code>generate-manager</code> or <code>generate-registration</code> because an optional UI plugin  generates domain class management screens, an admin console, and forgot password and registration workflows. If you want to create your own CRUD pages, you can use the standard Grails <code>generate-all</code> script. Various sections of this documentation discuss required changes to the generated source files, for example, encrypting passwords before saving or updating a user.<p class="paragraph"/><h4>UserDetails Differences</h4><p class="paragraph"/>The Acegi plugin extends the <code>UserDetails</code> instance and adds an accessor for the person domain class instance that is used to populate the <code>UserDetails</code>. Because the <code>Authentication</code> is kept in the HTTP session and the <code>UserDetails</code> is attached to that, it is easy to access non-security data such as full name, email, and so on without hitting the database.<p class="paragraph"/>However, with this approach, if the domain class has a lot of data, you increase the size of the session payload, which is exacerbated by clustered sessions. Further, any lazy-loaded collections fail to load after retrieving the person from the session because it would have become a detached Hibernate object. This problem is addressed by a call to <code>person.attach()</code> or by reloading by id, for example:<p class="paragraph"/><div class="code"><pre>def userDetails = authenticateService.principal()
def person = userDetails.domainClass
person = Person.get(person.id)</pre></div><p class="paragraph"/>But with this approach, the person class is essentially a very large wrapper around its primary key since that's the real data you're storing.<p class="paragraph"/>To resolve this issue, the Spring Security plugin does not store the domain class but instead stores the id so you can retrieve the person easily:<p class="paragraph"/><div class="code"><pre>def userDetails = springSecurityService.principal
person = Person.get(userDetails.id)</pre></div><p class="paragraph"/>The preceding approach works because the <code>UserDetails</code> implementation is an instance of <code>org.codehaus.groovy.grails.plugins.springsecurity.GrailsUser</code>, which extends the standard Spring Security <a href="http://static.springsource.org/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/core/userdetails/User.html" target="blank">User</a> and adds a <code>getId()</code> method.<p class="paragraph"/>You can further extend this class if you want to store more data along with the authentication to avoid database access. See <a href="../guide/single.html#11 Custom UserDetailsService" class="guide">Custom UserDetailsService</a>.
<h1><a name="3 Migrating from the Acegi Plugin">3 Migrating from the Acegi Plugin</a></h1>If you formerly used the Acegi plugin, change your application configuration settings as follows.<p class="paragraph"/><table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th><strong class="bold">Setting</strong></th><th><strong class="bold">Spring Security Plugin</strong></th><th><strong class="bold">Acegi Plugin</strong></th></tr><tr class="table-odd"><td>Enabled by default</td><td><code>true</code></td><td><code>false</code></td></tr><tr class="table-even"><td>Cache UserDetails by default</td><td><code>false</code></td><td><code>true</code></td></tr><tr class="table-odd"><td>Configuration location</td><td><code>grails-app/conf/Config.groovy</code></td><td><code>grails-app/conf/SecurityConfig.groovy</code></td></tr><tr class="table-even"><td>Security service</td><td><code>springSecurityService</code></td><td><code>authenticateService</code></td></tr></table><p class="paragraph"/>The table shows names of corresponding configuration properties.<p class="paragraph"/><blockquote class="note">
The plugin's configuration values all start with <code>grails.plugins.springsecurity</code> to distinguish them from similarly named options in Grails and from other plugins. You must specify all property overrides with the <code>grails.plugins.springsecurity</code> suffix. For example, you specify the attribute <code>password.algorithm</code> as:<p class="paragraph"/><div class="code"><pre>grails.plugins.springsecurity.password.algorithm='SHA&#45;512'</pre></div><p class="paragraph"/>in <code>Config.groovy</code>
</blockquote><p class="paragraph"/><table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th><strong class="bold">Acegi Plugin</strong></th><th><strong class="bold">Spring Security Plugin</strong></th></tr><tr class="table-odd"><td>active</td><td>active</td></tr><tr class="table-even"><td>loginUserDomainClass</td><td>userLookup.userDomainClassName</td></tr><tr class="table-odd"><td>userName</td><td>userLookup.usernamePropertyName</td></tr><tr class="table-even"><td>enabled</td><td>userLookup.enabledPropertyName</td></tr><tr class="table-odd"><td>password</td><td>userLookup.passwordPropertyName</td></tr><tr class="table-even"><td>relationalAuthorities</td><td>userLookup.authoritiesPropertyName</td></tr><tr class="table-odd"><td>getAuthoritiesMethod</td><td>N/A</td></tr><tr class="table-even"><td>authorityDomainClass</td><td>authority.className</td></tr><tr class="table-odd"><td>authorityField</td><td>authority.nameField</td></tr><tr class="table-even"><td>authenticationFailureUrl</td><td>failureHandler.defaultFailureUrl</td></tr><tr class="table-odd"><td>ajaxAuthenticationFailureUrl</td><td>failureHandler.ajaxAuthFailUrl</td></tr><tr class="table-even"><td>defaultTargetUrl</td><td>successHandler.defaultTargetUrl</td></tr><tr class="table-odd"><td>alwaysUseDefaultTargetUrl</td><td>successHandler.alwaysUseDefault</td></tr><tr class="table-even"><td>filterProcessesUrl</td><td>apf.filterProcessesUrl</td></tr><tr class="table-odd"><td>key</td><td>anon.key</td></tr><tr class="table-even"><td>userAttribute</td><td>anon.userAttribute</td></tr><tr class="table-odd"><td>loginFormUrl</td><td>auth.loginFormUrl</td></tr><tr class="table-even"><td>forceHttps</td><td>auth.forceHttps</td></tr><tr class="table-odd"><td>ajaxLoginFormUrl</td><td>auth.ajaxLoginFormUrl</td></tr><tr class="table-even"><td>afterLogoutUrl</td><td>logout.afterLogoutUrl</td></tr><tr class="table-odd"><td>errorPage</td><td>adh.errorPage</td></tr><tr class="table-even"><td>ajaxErrorPage</td><td>adh.ajaxErrorPage</td></tr><tr class="table-odd"><td>ajaxHeader</td><td>ajaxHeader</td></tr><tr class="table-even"><td>algorithm</td><td>password.algorithm</td></tr><tr class="table-odd"><td>encodeHashAsBase64</td><td>password.encodeHashAsBase64</td></tr><tr class="table-even"><td>cookieName</td><td>rememberMe.cookieName</td></tr><tr class="table-odd"><td>alwaysRemember</td><td>rememberMe.alwaysRemember</td></tr><tr class="table-even"><td>tokenValiditySeconds</td><td>rememberMe.tokenValiditySeconds</td></tr><tr class="table-odd"><td>parameter</td><td>rememberMe.parameter</td></tr><tr class="table-even"><td>rememberMeKey</td><td>rememberMe.key</td></tr><tr class="table-odd"><td>useLogger</td><td>registerLoggerListener</td></tr><tr class="table-even"><td>useRequestMapDomainClass</td><td>securityConfigType = "Requestmap"</td></tr><tr class="table-odd"><td>requestMapClass</td><td>requestMap.className</td></tr><tr class="table-even"><td>requestMapPathField</td><td>requestMap.urlField</td></tr><tr class="table-odd"><td>requestMapConfigAttributeField</td><td>requestMap.configAttributeField</td></tr><tr class="table-even"><td>useControllerAnnotations</td><td>securityConfigType = "Annotation"</td></tr><tr class="table-odd"><td>controllerAnnotationsMatcher</td><td>controllerAnnotations.matcher</td></tr><tr class="table-even"><td>controllerAnnotationsMatchesLowercase</td><td>controllerAnnotations.lowercase</td></tr><tr class="table-odd"><td>controllerAnnotationStaticRules</td><td>controllerAnnotations.staticRules</td></tr><tr class="table-even"><td>controllerAnnotationsRejectIfNoRule</td><td>rejectIfNoRule</td></tr><tr class="table-odd"><td>requestMapString</td><td>N/A - securityConfigType = "InterceptUrlMap" is very similar</td></tr><tr class="table-even"><td>realmName</td><td>basic.realmName</td></tr><tr class="table-odd"><td>basicProcessingFilter</td><td>useBasicAuth</td></tr><tr class="table-even"><td>switchUserProcessingFilter</td><td>useSwitchUserFilter</td></tr><tr class="table-odd"><td>swswitchUserUrl</td><td>switchUser.switchUserUrl</td></tr><tr class="table-even"><td>swexitUserUrl</td><td>switchUser.exitUserUrl</td></tr><tr class="table-odd"><td>swtargetUrl</td><td>switchUser.targetUrl</td></tr><tr class="table-even"><td>useMail</td><td>N/A - registration is supported in the <a href="http://grails.org/plugin/spring-security-ui/" target="blank">UI</a> plugin</td></tr><tr class="table-odd"><td>mailHost</td><td>N/A - registration is supported in the <a href="http://grails.org/plugin/spring-security-ui/" target="blank">UI</a> plugin</td></tr><tr class="table-even"><td>mailUsername</td><td>N/A - registration is supported in the <a href="http://grails.org/plugin/spring-security-ui/" target="blank">UI</a> plugin</td></tr><tr class="table-odd"><td>mailPassword</td><td>N/A - registration is supported in the <a href="http://grails.org/plugin/spring-security-ui/" target="blank">UI</a> plugin</td></tr><tr class="table-even"><td>mailProtocol</td><td>N/A - registration is supported in the <a href="http://grails.org/plugin/spring-security-ui/" target="blank">UI</a> plugin</td></tr><tr class="table-odd"><td>mailFrom</td><td>N/A - registration is supported in the <a href="http://grails.org/plugin/spring-security-ui/" target="blank">UI</a> plugin</td></tr><tr class="table-even"><td>mailPort</td><td>N/A - registration is supported in the <a href="http://grails.org/plugin/spring-security-ui/" target="blank">UI</a> plugin</td></tr><tr class="table-odd"><td>defaultRole</td><td>N/A - registration is supported in the <a href="http://grails.org/plugin/spring-security-ui/" target="blank">UI</a> plugin</td></tr><tr class="table-even"><td>useOpenId</td><td>N/A - supported in the <a href="http://grails.org/plugin/spring-security-openid/" target="blank">OpenID</a> plugin</td></tr><tr class="table-odd"><td>openIdNonceMaxSeconds</td><td>N/A - supported in the <a href="http://grails.org/plugin/spring-security-openid/" target="blank">OpenID</a> plugin</td></tr><tr class="table-even"><td>useLdap</td><td>N/A - supported in the <a href="http://grails.org/plugin/spring-security-ldap/" target="blank">LDAP</a> plugin</td></tr><tr class="table-odd"><td>ldapRetrieveGroupRoles</td><td>N/A - supported in the <a href="http://grails.org/plugin/spring-security-ldap/" target="blank">LDAP</a> plugin</td></tr><tr class="table-even"><td>ldapRetrieveDatabaseRoles</td><td>N/A - supported in the <a href="http://grails.org/plugin/spring-security-ldap/" target="blank">LDAP</a> plugin</td></tr><tr class="table-odd"><td>ldapSearchSubtree</td><td>N/A - supported in the <a href="http://grails.org/plugin/spring-security-ldap/" target="blank">LDAP</a> plugin</td></tr><tr class="table-even"><td>ldapGroupRoleAttribute</td><td>N/A - supported in the <a href="http://grails.org/plugin/spring-security-ldap/" target="blank">LDAP</a> plugin</td></tr><tr class="table-odd"><td>ldapPasswordAttributeName</td><td>N/A - supported in the <a href="http://grails.org/plugin/spring-security-ldap/" target="blank">LDAP</a> plugin</td></tr><tr class="table-even"><td>ldapServer</td><td>N/A - supported in the <a href="http://grails.org/plugin/spring-security-ldap/" target="blank">LDAP</a> plugin</td></tr><tr class="table-odd"><td>ldapManagerDn</td><td>N/A - supported in the <a href="http://grails.org/plugin/spring-security-ldap/" target="blank">LDAP</a> plugin</td></tr><tr class="table-even"><td>ldapManagerPassword</td><td>N/A - supported in the <a href="http://grails.org/plugin/spring-security-ldap/" target="blank">LDAP</a> plugin</td></tr><tr class="table-odd"><td>ldapSearchBase</td><td>N/A - supported in the <a href="http://grails.org/plugin/spring-security-ldap/" target="blank">LDAP</a> plugin</td></tr><tr class="table-even"><td>ldapSearchFilter</td><td>N/A - supported in the <a href="http://grails.org/plugin/spring-security-ldap/" target="blank">LDAP</a> plugin</td></tr><tr class="table-odd"><td>ldapGroupSearchBase</td><td>N/A - supported in the <a href="http://grails.org/plugin/spring-security-ldap/" target="blank">LDAP</a> plugin</td></tr><tr class="table-even"><td>ldapGroupSearchFilter</td><td>N/A - supported in the <a href="http://grails.org/plugin/spring-security-ldap/" target="blank">LDAP</a> plugin</td></tr><tr class="table-odd"><td>ldapUsePassword</td><td>N/A - supported in the <a href="http://grails.org/plugin/spring-security-ldap/" target="blank">LDAP</a> plugin</td></tr><tr class="table-even"><td>useKerberos</td><td>N/A - will be supported in a secondary plugin</td></tr><tr class="table-odd"><td>kerberosLoginConfigFile</td><td>N/A - will be supported in a secondary plugin</td></tr><tr class="table-even"><td>kerberosRealm</td><td>N/A - will be supported in a secondary plugin</td></tr><tr class="table-odd"><td>kerberosKdc</td><td>N/A - will be supported in a secondary plugin</td></tr><tr class="table-even"><td>kerberosRetrieveDatabaseRoles</td><td>N/A - will be supported in a secondary plugin</td></tr><tr class="table-odd"><td>useHttpSessionEventPublisher</td><td>useHttpSessionEventPublisher</td></tr><tr class="table-even"><td>cacheUsers</td><td>cacheUsers</td></tr><tr class="table-odd"><td>useCAS</td><td>N/A - supported in the <a href="http://grails.org/plugin/spring-security-cas/" target="blank">CAS</a> plugin</td></tr><tr class="table-even"><td>cas.casServer</td><td>N/A - supported in the <a href="http://grails.org/plugin/spring-security-cas/" target="blank">CAS</a> plugin</td></tr><tr class="table-odd"><td>cas.casServerPort</td><td>N/A - supported in the <a href="http://grails.org/plugin/spring-security-cas/" target="blank">CAS</a> plugin</td></tr><tr class="table-even"><td>cas.casServerSecure</td><td>N/A - supported in the <a href="http://grails.org/plugin/spring-security-cas/" target="blank">CAS</a> plugin</td></tr><tr class="table-odd"><td>cas.localhostSecure</td><td>N/A - supported in the <a href="http://grails.org/plugin/spring-security-cas/" target="blank">CAS</a> plugin</td></tr><tr class="table-even"><td>cas.failureURL</td><td>N/A - supported in the <a href="http://grails.org/plugin/spring-security-cas/" target="blank">CAS</a> plugin</td></tr><tr class="table-odd"><td>cas.defaultTargetURL</td><td>N/A - supported in the <a href="http://grails.org/plugin/spring-security-cas/" target="blank">CAS</a> plugin</td></tr><tr class="table-even"><td>cas.fullLoginURL</td><td>N/A - supported in the <a href="http://grails.org/plugin/spring-security-cas/" target="blank">CAS</a> plugin</td></tr><tr class="table-odd"><td>cas.fullServiceURL</td><td>N/A - supported in the <a href="http://grails.org/plugin/spring-security-cas/" target="blank">CAS</a> plugin</td></tr><tr class="table-even"><td>cas.authenticationProviderKey</td><td>N/A - supported in the <a href="http://grails.org/plugin/spring-security-cas/" target="blank">CAS</a> plugin</td></tr><tr class="table-odd"><td>cas.userDetailsService</td><td>N/A - supported in the <a href="http://grails.org/plugin/spring-security-cas/" target="blank">CAS</a> plugin</td></tr><tr class="table-even"><td>cas.sendRenew</td><td>N/A - supported in the <a href="http://grails.org/plugin/spring-security-cas/" target="blank">CAS</a> plugin</td></tr><tr class="table-odd"><td>cas.proxyReceptorUrl</td><td>N/A - supported in the <a href="http://grails.org/plugin/spring-security-cas/" target="blank">CAS</a> plugin</td></tr><tr class="table-even"><td>cas.filterProcessesUrl</td><td>N/A - supported in the <a href="http://grails.org/plugin/spring-security-cas/" target="blank">CAS</a> plugin</td></tr><tr class="table-odd"><td>useNtlm</td><td>N/A - will be supported in a secondary plugin</td></tr><tr class="table-even"><td>ntlm.stripDomain</td><td>N/A - will be supported in a secondary plugin</td></tr><tr class="table-odd"><td>ntlm.retryOnAuthFailure</td><td>N/A - will be supported in a secondary plugin</td></tr><tr class="table-even"><td>ntlm.forceIdentification</td><td>N/A - will be supported in a secondary plugin</td></tr><tr class="table-odd"><td>ntlm.defaultDomain</td><td>N/A - will be supported in a secondary plugin</td></tr><tr class="table-even"><td>ntlm.netbiosWINS</td><td>N/A - will be supported in a secondary plugin</td></tr><tr class="table-odd"><td>httpPort</td><td>portMapper.httpPort</td></tr><tr class="table-even"><td>httpsPort</td><td>portMapper.httpsPort</td></tr><tr class="table-odd"><td>secureChannelDefinitionSource</td><td>N/A, use secureChannel.definition</td></tr><tr class="table-even"><td>channelConfig</td><td>secureChannel.definition</td></tr><tr class="table-odd"><td>ipRestrictions</td><td>ipRestrictions</td></tr><tr class="table-even"><td>useFacebook</td><td>N/A - will be supported in the Facebook plugin</td></tr><tr class="table-odd"><td>facebook.filterProcessesUrl</td><td>N/A - will be supported in the Facebook plugin</td></tr><tr class="table-even"><td>facebook.authenticationUrlRoot</td><td>N/A - will be supported in the Facebook plugin</td></tr><tr class="table-odd"><td>facebook.apiKey</td><td>N/A - will be supported in the Facebook plugin</td></tr><tr class="table-even"><td>facebook.secretKey</td><td>N/A - will be supported in the Facebook plugin</td></tr></table>
<h1><a name="4 Required and Optional Domain Classes">4 Required and Optional Domain Classes</a></h1>By default the plugin uses regular Grails domain classes to access its required data. It's easy to create your own user lookup code though, which can access the database or any other source to retrieve user and authority data. See <a href="../guide/single.html#11 Custom UserDetailsService" class="guide">Custom UserDetailsService</a> for how to implement this.<p class="paragraph"/>To use the standard user lookup you'll need at a minimum a 'person' and an 'authority' domain class. In addition, if you want to store URL&#60;-&#62;Role mappings in the database (this is one of multiple approaches for defining the mappings) you need a 'requestmap' domain class. If you use the recommended approach for mapping the many-to-many relationship between 'person' and 'authority,' you also need a domain class to map the join table.<p class="paragraph"/>The <a href="../ref/Scripts/s2-quickstart.html" class="Scripts">s2-quickstart</a> script creates initial domain classes for you. You specify the package and class names, and it creates the corresponding domain classes. After that you can customize them as you like. You can add unlimited fields, methods, and so on, as long as the core security-related functionality remains.
<h2><a name="4.1 Person Class">4.1 Person Class</a></h2>Spring Security uses an <a href="http://static.springsource.org/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/core/Authentication.html" target="blank">Authentication</a> object to determine whether the current user has the right to perform a secured action, such as accessing a URL, manipulating a secured domain object, accessing a secured method, and so on. This object is created during login. Typically overlap occurs between the need for authentication data and the need to represent a user in the application in ways that are unrelated to security. The mechanism for populating the authentication is completely pluggable in Spring Security; you only need to provide an implementation of <a href="http://static.springsource.org/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/core/userdetails/UserDetailsService.html" target="blank">UserDetailsService</a> and implement its one method, <code>loadUserByUsername()</code>.<p class="paragraph"/>By default the plugin uses a Grails 'person' domain class to manage this data. The class name is <code>Person</code>, and <code>username</code>, <code>enabled</code>, <code>password</code> are the default names of the required properties. You can easily <a href="../guide/single.html#11 Custom UserDetailsService" class="guide">plug in your own implementation</a>, and rename the class, package, and fields. In addition, you should define an <code>authorities</code> property to retrieve roles; this can be a public field or a <code>getAuthorities()</code> method, and it can be defined through a traditional GORM many-to-many or a custom mapping.<p class="paragraph"/>Assuming you choose <code>com.mycompany.myapp</code> as your package, and <code>User</code> as your class name, you'll generate this class:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> com.mycompany.myapp<p class="paragraph"/>class User &#123;<p class="paragraph"/>   <span class="java&#45;object">String</span> username
   <span class="java&#45;object">String</span> password
   <span class="java&#45;object">boolean</span> enabled
   <span class="java&#45;object">boolean</span> accountExpired
   <span class="java&#45;object">boolean</span> accountLocked
   <span class="java&#45;object">boolean</span> passwordExpired<p class="paragraph"/>   <span class="java&#45;keyword">static</span> constraints = &#123;
      username blank: <span class="java&#45;keyword">false</span>, unique: <span class="java&#45;keyword">true</span>
      password blank: <span class="java&#45;keyword">false</span>
   &#125;<p class="paragraph"/>   <span class="java&#45;keyword">static</span> mapping = &#123;
      password column: '`password`'
   &#125;<p class="paragraph"/>   Set&#60;Role&#62; getAuthorities() &#123;
      UserRole.findAllByUser(<span class="java&#45;keyword">this</span>).collect &#123; it.role &#125; as Set
   &#125;
&#125;</pre></div><p class="paragraph"/>Optionally, add other properties such as <code>email</code>, <code>firstName</code>, <code>lastName</code>, and convenience methods, and so on:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> com.mycompany.myapp<p class="paragraph"/>class User &#123;<p class="paragraph"/>   <span class="java&#45;object">String</span> username
   <span class="java&#45;object">String</span> password
   <span class="java&#45;object">boolean</span> enabled
   <span class="java&#45;object">String</span> email
   <span class="java&#45;object">String</span> firstName
   <span class="java&#45;object">String</span> lastName<p class="paragraph"/>   <span class="java&#45;keyword">static</span> constraints = &#123;
      username blank: <span class="java&#45;keyword">false</span>, unique: <span class="java&#45;keyword">true</span>
      password blank: <span class="java&#45;keyword">false</span>
   &#125;<p class="paragraph"/>   Set&#60;Role&#62; getAuthorities() &#123;
      UserRole.findAllByUser(<span class="java&#45;keyword">this</span>).collect &#123; it.role &#125; as Set
   &#125;<p class="paragraph"/>   def someMethod &#123;
      &#8230;
   &#125;
&#125;</pre></div><p class="paragraph"/>The <code>getAuthorities()</code> method is analagous to defining <code>static hasMany = &#91;authorities: Authority&#93;</code> in a traditional many-to-many mapping. This way <code>GormUserDetailsService</code> can call <code>user.authorities</code> during login to retrieve the roles without the overhead of a bidirectional many-to-many mapping.<p class="paragraph"/>The class and property names are configurable using these configuration attributes:<p class="paragraph"/><table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th><strong class="bold">Property</strong></th><th><strong class="bold">Default Value</strong></th><th><strong class="bold">Meaning</strong></th></tr><tr class="table-odd"><td>userLookup.userDomainClassName</td><td>'Person'</td><td>User class name</td></tr><tr class="table-even"><td>userLookup.usernamePropertyName</td><td>'username'</td><td>User class username field</td></tr><tr class="table-odd"><td>userLookup.passwordPropertyName</td><td>'password'</td><td>User class password field</td></tr><tr class="table-even"><td>userLookup.authoritiesPropertyName</td><td>'authorities'</td><td>User class role collection field</td></tr><tr class="table-odd"><td>userLookup.enabledPropertyName</td><td>'enabled'</td><td>User class enabled field</td></tr><tr class="table-even"><td>userLookup.accountExpiredPropertyName</td><td>'accountExpired'</td><td>User class account expired field</td></tr><tr class="table-odd"><td>userLookup.accountLockedPropertyName</td><td>'accountLocked'</td><td>User class account locked field</td></tr><tr class="table-even"><td>userLookup.passwordExpiredPropertyName</td><td>'passwordExpired'</td><td>User class password expired field</td></tr><tr class="table-odd"><td>userLookup.authorityJoinClassName</td><td>'PersonAuthority'</td><td>User/Role many-many join class name</td></tr></table>
<h2><a name="4.2 Authority Class">4.2 Authority Class</a></h2>The Spring Security plugin also requires an 'authority' class to represent a user's role(s) in the application. In general this class restricts URLs to users who have been assigned the required access rights. A user can have multiple roles to indicate various access rights in the application, and should have at least one. A basic user who can access only non-restricted resources but can still authenticate is a bit unusual. Spring Security usually functions fine if a user has no granted authorities, but fails in a few places that assume one or more. So if a user authenticates successfully but has no granted roles, the plugin grants the user a 'virtual' role, <code>ROLE_NO_ROLES</code>. Thus the user satisfies Spring Security's requirements but cannot access secure resources, as you would not associate any secure resources with this role.<p class="paragraph"/>Like the 'person' class, the 'authority' class has a default name, <code>Authority</code>, and a default name for its one required property, <code>authority</code>.
If you want to use another existing domain class, it simply has to have a property for name. As with the name of the class, the names of the properties can be whatever you want - they're specified in <code>grails-app/conf/Config.groovy</code>.<p class="paragraph"/>Assuming you choose <code>com.mycompany.myapp</code> as your package, and <code>Role</code> as your class name, you'll generate this class:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> com.mycompany.myapp<p class="paragraph"/>class Role &#123;<p class="paragraph"/>   <span class="java&#45;object">String</span> authority<p class="paragraph"/>   <span class="java&#45;keyword">static</span> mapping = &#123;
      cache <span class="java&#45;keyword">true</span>
   &#125;<p class="paragraph"/>   <span class="java&#45;keyword">static</span> constraints = &#123;
      authority blank: <span class="java&#45;keyword">false</span>, unique: <span class="java&#45;keyword">true</span>
   &#125;
&#125;</pre></div><p class="paragraph"/>The class and property names are configurable using these configuration attributes:<p class="paragraph"/><table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th><strong class="bold">Property</strong></th><th><strong class="bold">Default Value</strong></th><th><strong class="bold">Meaning</strong></th></tr><tr class="table-odd"><td>authority.className</td><td>'Authority'</td><td>Role class name</td></tr><tr class="table-even"><td>authority.nameField</td><td>'authority'</td><td>Role class role name field</td></tr></table>
<h2><a name="4.3 PersonAuthority Class">4.3 PersonAuthority Class</a></h2>The typical approach to mapping the relationship between 'person' and 'authority' is a many-to-many. Users have multiple roles, and roles are shared by multiple users. This approach can be problematic in Grails, because a popular role, for example, <code>ROLE_USER</code>, will be granted to many users in your application. GORM uses collections to manage adding and removing related instances and maps many-to-many relationships bidirectionally. Granting a role to a user requires loading all  existing users who have that role because the collection is a <code>Set</code>. So even though no uniqueness concerns may exist, Hibernate loads them all to enforce uniqueness. The recommended approach in the plugin is to map a domain class to the join table that manages the many-to-many, and using that to grant and revoke roles to users.<p class="paragraph"/>Like the other domain classes, this class is generated for you, so you don't need to deal with the details of mapping it. Assuming you choose <code>com.mycompany.myapp</code> as your package, and <code>User</code> and <code>Role</code> as your class names, you'll generate this class:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> com.testapp<p class="paragraph"/><span class="java&#45;keyword">import</span> org.apache.commons.lang.builder.HashCodeBuilder<p class="paragraph"/>class UserRole <span class="java&#45;keyword">implements</span> Serializable &#123;<p class="paragraph"/>   User user
   Role role<p class="paragraph"/>   <span class="java&#45;object">boolean</span> equals(other) &#123;
      <span class="java&#45;keyword">if</span> (!(other <span class="java&#45;keyword">instanceof</span> UserRole)) &#123;
         <span class="java&#45;keyword">return</span> <span class="java&#45;keyword">false</span>
      &#125;<p class="paragraph"/>      other.user?.id == user?.id &#38;&#38;
         other.role?.id == role?.id
   &#125;<p class="paragraph"/>   <span class="java&#45;object">int</span> hashCode() &#123;
      def builder = <span class="java&#45;keyword">new</span> HashCodeBuilder()
      <span class="java&#45;keyword">if</span> (user) builder.append(user.id)
      <span class="java&#45;keyword">if</span> (role) builder.append(role.id)
      builder.toHashCode()
   &#125;<p class="paragraph"/>   <span class="java&#45;keyword">static</span> UserRole get(<span class="java&#45;object">long</span> userId, <span class="java&#45;object">long</span> roleId) &#123;
      find 'from UserRole where user.id=:userId and role.id=:roleId',
         &#91;userId: userId, roleId: roleId&#93;
   &#125;<p class="paragraph"/>   <span class="java&#45;keyword">static</span> UserRole create(User user, Role role, <span class="java&#45;object">boolean</span> flush = <span class="java&#45;keyword">false</span>) &#123;
      <span class="java&#45;keyword">new</span> UserRole(user: user, role: role).save(flush: flush, insert: <span class="java&#45;keyword">true</span>)
   &#125;<p class="paragraph"/>   <span class="java&#45;keyword">static</span> <span class="java&#45;object">boolean</span> remove(User user, Role role, <span class="java&#45;object">boolean</span> flush = <span class="java&#45;keyword">false</span>) &#123;
      UserRole instance = UserRole.findByUserAndRole(user, role)
      <span class="java&#45;keyword">if</span> (!instance) &#123;
         <span class="java&#45;keyword">return</span> <span class="java&#45;keyword">false</span>
      &#125;<p class="paragraph"/>      instance.delete(flush: flush)
      <span class="java&#45;keyword">true</span>
   &#125;<p class="paragraph"/>   <span class="java&#45;keyword">static</span> void removeAll(User user) &#123;
      executeUpdate 'DELETE FROM UserRole WHERE user=:user', &#91;user: user&#93;
   &#125;<p class="paragraph"/>   <span class="java&#45;keyword">static</span> mapping = &#123;
      id composite: &#91;'role', 'user'&#93;
      version <span class="java&#45;keyword">false</span>
   &#125;
&#125;</pre></div><p class="paragraph"/>The helper methods make it easy to grant or revoke roles. Assuming you have already loaded a user and a role, you grant the role to the user as follows:<p class="paragraph"/><div class="code"><pre>User user = &#8230;
Role role = &#8230;
UserRole.create user, role</pre></div><p class="paragraph"/>Or by using the 3-parameter version to trigger a flush:<p class="paragraph"/><div class="code"><pre>User user = &#8230;
Role role = &#8230;
UserRole.create user, role, <span class="java&#45;keyword">true</span></pre></div><p class="paragraph"/>Revoking a role is similar:<p class="paragraph"/><div class="code"><pre>User user = &#8230;
Role role = &#8230;
UserRole.remove user, role</pre></div><p class="paragraph"/>Or:<p class="paragraph"/><div class="code"><pre>User user = &#8230;
Role role = &#8230;
UserRole.remove user, role, <span class="java&#45;keyword">true</span></pre></div><p class="paragraph"/>The class name is the only configurable attribute:<p class="paragraph"/><table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th><strong class="bold">Property</strong></th><th><strong class="bold">Default Value</strong></th><th><strong class="bold">Meaning</strong></th></tr><tr class="table-odd"><td>userLookup.authorityJoinClassName</td><td>'PersonAuthority'</td><td>User/Role many-many join class name</td></tr></table>
<h2><a name="4.4 Requestmap Class">4.4 Requestmap Class</a></h2>Optionally, use this class to store request mapping entries in the database instead of defining them with annotations or in <code>Config.groovy</code>. This option makes  the class configurable at runtime; you can add, remove and edit rules without restarting your application.<p class="paragraph"/><table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th><strong class="bold">Property</strong></th><th><strong class="bold">Default Value</strong></th><th><strong class="bold">Meaning</strong></th></tr><tr class="table-odd"><td>requestMap.className</td><td>'Requestmap'</td><td>requestmap class name</td></tr><tr class="table-even"><td>requestMap.urlField</td><td>'url'</td><td>URL pattern field name</td></tr><tr class="table-odd"><td>requestMap.configAttributeField</td><td>'configAttribute'</td><td>authority pattern field name</td></tr></table><p class="paragraph"/>Assuming you choose <code>com.mycompany.myapp</code> as your package, and <code>Requestmap</code> as your class name, you'll generate this class:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> com.testapp<p class="paragraph"/>class Requestmap &#123;<p class="paragraph"/>   <span class="java&#45;object">String</span> url
   <span class="java&#45;object">String</span> configAttribute<p class="paragraph"/>   <span class="java&#45;keyword">static</span> mapping = &#123;
      cache <span class="java&#45;keyword">true</span>
   &#125;<p class="paragraph"/>   <span class="java&#45;keyword">static</span> constraints = &#123;
      url blank: <span class="java&#45;keyword">false</span>, unique: <span class="java&#45;keyword">true</span>
      configAttribute blank: <span class="java&#45;keyword">false</span>
   &#125;
&#125;</pre></div><p class="paragraph"/>To use Requestmap entries to guard URLs, see <a href="../guide/single.html#5.3 Requestmap Instances Stored in the Database" class="guide">Requestmap Instances Stored in the Database</a>.
<h1><a name="5 Configuring Request Mappings to Secure URLs">5 Configuring Request Mappings to Secure URLs</a></h1>You can choose among the following approaches to configuring request mappings for secure application URLs. The goal is to map URL patterns to the roles required to access those URLs.
<ul class="star">
<li><a href="../guide/single.html#5.1 Defining Secured Annotations" class="guide"><code>@Secured</code> annotations (default approach)</a></li>
<li><a href="../guide/single.html#5.2 Simple Map in Config.groovy" class="guide">A simple Map in <code>Config.groovy</code></a></li>
<li><a href="../guide/single.html#5.3 Requestmap Instances Stored in the Database" class="guide"><code>Requestmap</code> domain class instances stored in the database</a></li>
</ul><p class="paragraph"/>You can only use one method at a time. You configure it with the <code>securityConfigType</code> attribute; the value has to be an <code>SecurityConfigType</code> enum value or the name of the enum as a String.<p class="paragraph"/><h4>Pessimistic Lockdown</h4>
Most applications are mostly public, with some pages only accessible to authenticated users with various roles. In this case, it makes more sense to leave URLs open by default and restrict access on a case-by-case basis. However, if your application is primarily secure, you can use a pessimistic lockdown approach to deny access to all URLs that do not have an applicable URL-Role configuration.<p class="paragraph"/>To use the pessimistic approach, add this line to <code>grails-app/conf/Config.groovy</code>:<p class="paragraph"/><div class="code"><pre>grails.plugins.springsecurity.rejectIfNoRule = <span class="java&#45;keyword">true</span></pre></div><p class="paragraph"/>Any requested URL that does not have a corresponding rule will be denied to all users.<p class="paragraph"/><h4>URLs and Authorities</h4><p class="paragraph"/>In each approach you configure a mapping for a URL pattern to the role(s) that are required to access those URLs, for example, <code>/admin/user/&#42;&#42;</code> requires <code>ROLE_ADMIN</code>. In addition, you can combine the role(s) with tokens such as IS_AUTHENTICATED_ANONYMOUSLY, IS_AUTHENTICATED_REMEMBERED, and IS_AUTHENTICATED_FULLY. One or more <a href="../guide/single.html#21 Voters" class="guide">Voter</a>s will process any tokens and enforce a rule based on them:
<ul class="star">
<li><code>IS_AUTHENTICATED_ANONYMOUSLY</code></li>
<ul class="star">
<li>signifies that anyone can access this URL. By default the <code>AnonymousAuthenticationFilter</code> ensures an 'anonymous' <code>Authentication</code> with no roles so that every user has an authentication. The token accepts any authentication, even anonymous.</li>
</ul>
<li><code>IS_AUTHENTICATED_REMEMBERED</code></li>
<ul class="star">
<li>requires the user to be authenticated through a remember-me cookie or an explicit login.</li>
</ul>
<li><code>IS_AUTHENTICATED_FULLY</code></li>
<ul class="star">
<li>requires the user to be fully authenticated with an explicit login.</li>
</ul></ul><p class="paragraph"/>With <code>IS_AUTHENTICATED_FULLY</code> you can implement a security scheme whereby users can check a remember-me checkbox during login and be auto-authenticated each time they return to your site, but must still log in with a password for some parts of the site. For example, allow regular browsing and adding items to a shopping cart with only a cookie, but require an explicit login to check out or view purchase history.<p class="paragraph"/>For more information on <code>IS_AUTHENTICATED_FULLY</code>, <code>IS_AUTHENTICATED_REMEMBERED</code>, and <code>IS_AUTHENTICATED_ANONYMOUSLY</code>, see the Javadoc for <a href="http://static.springsource.org/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/access/vote/AuthenticatedVoter.html" target="blank">AuthenticatedVoter</a><p class="paragraph"/><h4>Comparing the Approaches</h4><p class="paragraph"/>Each approach has its advantages and disadvantages. Annotations and the <code>Config.groovy</code> Map are less flexible because they are configured once in the code and you can update them only by restarting the application (in prod mode anyway). In practice this limitation is minor, because security mappings for most applications are unlikely to change at runtime.<p class="paragraph"/>On the other hand, storing <code>Requestmap</code> entries enables runtime-configurability. This approach gives you a core set of rules populated at application startup that you can edit, add to, and delete as needed. However, it separates the security rules from the application code, which is less convenient than having the rules defined in <code>grails-app/conf/Config.groovy</code> or in the applicable controllers using annotations.<p class="paragraph"/>URLs must be mapped in lowercase if you use the <code>Requestmap</code> or <code>grails-app/conf/Config.groovy</code> map approaches. For example, if you have a FooBarController, its urls will be of the form /fooBar/list, /fooBar/create, and so on, but these must be mapped as /foobar/, /foobar/list, /foobar/create. This mapping is handled automatically for you if you use annotations.
<h2><a name="5.1 Defining Secured Annotations">5.1 Defining Secured Annotations</a></h2>You can use an <code>&#64;Secured</code> annotation in your controllers to configure which roles are required for which actions. To use annotations, specify <code>securityConfigType="Annotation"</code>, or leave it unspecified because it's the default:<p class="paragraph"/><div class="code"><pre>grails.plugins.springsecurity.securityConfigType = <span class="java&#45;quote">"Annotation"</span></pre></div><p class="paragraph"/>You can define the annotation at the class level, meaning that the specified roles are required for all actions, or at the action level, or both. If the class and an action are annotated then the action annotation values will be used since they're more specific.<p class="paragraph"/>For example, given this controller:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> com.mycompany.myapp<p class="paragraph"/><span class="java&#45;keyword">import</span> grails.plugins.springsecurity.Secured<p class="paragraph"/>class SecureAnnotatedController &#123;<p class="paragraph"/>   @Secured(&#91;'ROLE_ADMIN'&#93;)
   def index = &#123;
      render 'you have ROLE_ADMIN'
   &#125;<p class="paragraph"/>   @Secured(&#91;'ROLE_ADMIN', 'ROLE_SUPERUSER'&#93;)
   def adminEither = &#123;
      render 'you have ROLE_ADMIN or SUPERUSER'
   &#125;<p class="paragraph"/>   def anybody = &#123;
      render 'anyone can see <span class="java&#45;keyword">this</span>'
   &#125;
&#125;</pre></div><p class="paragraph"/>you need to be authenticated and have <code>ROLE_ADMIN</code> to see <code>/myapp/secureAnnotated</code> (or <code>/myapp/secureAnnotated/index</code>) and be authenticated and have <code>ROLE_ADMIN</code> or <code>ROLE_SUPERUSER</code> to see <code>/myapp/secureAnnotated/adminEither</code>. Any user can access <code>/myapp/secureAnnotated/anybody</code>.<p class="paragraph"/>Often most actions in a controller require similar access rules, so you can also define annotations at the class level:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> com.mycompany.myapp<p class="paragraph"/><span class="java&#45;keyword">import</span> grails.plugins.springsecurity.Secured<p class="paragraph"/>@Secured(&#91;'ROLE_ADMIN'&#93;)
class SecureClassAnnotatedController &#123;<p class="paragraph"/>   def index = &#123;
      render 'index: you have ROLE_ADMIN'
   &#125;<p class="paragraph"/>   def otherAction = &#123;
      render 'otherAction: you have ROLE_ADMIN'
   &#125;<p class="paragraph"/>   @Secured(&#91;'ROLE_SUPERUSER'&#93;)
   def <span class="java&#45;keyword">super</span> = &#123;
      render '<span class="java&#45;keyword">super</span>: you have ROLE_SUPERUSER'
   &#125;
&#125;</pre></div><p class="paragraph"/>Here you need to be authenticated and have <code>ROLE_ADMIN</code> to see <code>/myapp/secureClassAnnotated</code> (or <code>/myapp/secureClassAnnotated/index</code>) or <code>/myapp/secureClassAnnotated/otherAction</code>. However, you must have <code>ROLE_SUPERUSER</code> to access <code>/myapp/secureClassAnnotated/super</code>. The action-scope annotation overrides the class-scope annotation.<p class="paragraph"/><h4>controllerAnnotations.staticRules</h4><p class="paragraph"/>You can also define 'static' mappings that cannot be expressed in the controllers, such as '/&#42;&#42;' or for JavaScript, CSS, or image URLs. Use the <code>controllerAnnotations.staticRules</code> property, for example:<p class="paragraph"/><div class="code"><pre>grails.plugins.springsecurity.controllerAnnotations.staticRules = &#91;
   '/js/admin/&#42;&#42;': &#91;'ROLE_ADMIN'&#93;,
   '/someplugin/&#42;&#42;': &#91;'ROLE_ADMIN'&#93;
&#93;</pre></div><p class="paragraph"/>This example maps all URLs associated with <code>SomePluginController</code>, which has URLs of the form <code>/somePlugin/...</code>, to <code>ROLE_ADMIN</code>; annotations are not an option here because you would not edit plugin code for a change like this.<p class="paragraph"/><blockquote class="note">
When mapping URLs for controllers that are mapped in <code>UrlMappings.groovy</code>, you need to secure the un-url-mapped URLs. For example if you have a FooBarController that you map to <code>/foo/bar/$action</code>, you must register that in <code>controllerAnnotations.staticRules</code> as <code>/foobar/&#42;&#42;</code>. This is different than the mapping you would use for the other two approaches and is necessary because <code>controllerAnnotations.staticRules</code> entries are treated as if they were annotations on the corresponding controller.
</blockquote>
<h2><a name="5.2 Simple Map in Config.groovy">5.2 Simple Map in Config.groovy</a></h2>To use the <code>Config.groovy</code> Map to secure URLs, first specify <code>securityConfigType="InterceptUrlMap"</code>:<p class="paragraph"/><div class="code"><pre>grails.plugins.springsecurity.securityConfigType = <span class="java&#45;quote">"InterceptUrlMap"</span></pre></div><p class="paragraph"/>Define a Map in <code>Config.groovy</code>:<p class="paragraph"/><div class="code"><pre>grails.plugins.springsecurity.interceptUrlMap = &#91;
   '/secure/&#42;&#42;':    &#91;'ROLE_ADMIN'&#93;,
   '/finance/&#42;&#42;':   &#91;'ROLE_FINANCE', 'IS_AUTHENTICATED_FULLY'&#93;,
   '/js/&#42;&#42;':        &#91;'IS_AUTHENTICATED_ANONYMOUSLY'&#93;,
   '/css/&#42;&#42;':       &#91;'IS_AUTHENTICATED_ANONYMOUSLY'&#93;,
   '/images/&#42;&#42;':    &#91;'IS_AUTHENTICATED_ANONYMOUSLY'&#93;,
   '/&#42;':            &#91;'IS_AUTHENTICATED_ANONYMOUSLY'&#93;,
   '/login/&#42;&#42;':     &#91;'IS_AUTHENTICATED_ANONYMOUSLY'&#93;,
   '/logout/&#42;&#42;':    &#91;'IS_AUTHENTICATED_ANONYMOUSLY'&#93;
&#93;</pre></div><p class="paragraph"/>When using this approach, make sure that you order the rules correctly. The first applicable rule is used, so for example if you have a controller that has one set of rules but an action that has stricter access rules, e.g.<p class="paragraph"/><div class="code"><pre>'/secure/&#42;&#42;':              &#91;'ROLE_ADMIN', 'ROLE_SUPERUSER'&#93;,
'/secure/reallysecure/&#42;&#42;': &#91;'ROLE_SUPERUSER'&#93;</pre></div><p class="paragraph"/>then this would fail - it wouldn't restrict access to <code>/secure/reallysecure/list</code> to a user with <code>ROLE_SUPERUSER</code> since the first URL pattern matches, so the second would be ignored. The correct mapping would be<p class="paragraph"/><div class="code"><pre>'/secure/reallysecure/&#42;&#42;': &#91;'ROLE_SUPERUSER'&#93;
'/secure/&#42;&#42;':              &#91;'ROLE_ADMIN', 'ROLE_SUPERUSER'&#93;,</pre></div>
<h2><a name="5.3 Requestmap Instances Stored in the Database">5.3 Requestmap Instances Stored in the Database</a></h2>With this approach you use the <code>Requestmap</code> domain class to store mapping entries in the database. <code>Requestmap</code> has a <code>url</code> property that contains the secured URL pattern and a <code>configAttribute</code> property containing a comma-delimited list of required roles and/or tokens such as <code>IS_AUTHENTICATED_FULLY</code>, <code>IS_AUTHENTICATED_REMEMBERED</code>, and <code>IS_AUTHENTICATED_ANONYMOUSLY</code>.<p class="paragraph"/>To use <code>Requestmap</code> entries, specify <code>securityConfigType="Requestmap"</code>:<p class="paragraph"/><div class="code"><pre>grails.plugins.springsecurity.securityConfigType = <span class="java&#45;quote">"Requestmap"</span></pre></div><p class="paragraph"/>You create <code>Requestmap</code> entries as you create entries in any Grails domain class:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">new</span> Requestmap(url: '/js/&#42;&#42;', configAttribute: 'IS_AUTHENTICATED_ANONYMOUSLY').save()
<span class="java&#45;keyword">new</span> Requestmap(url: '/css/&#42;&#42;', configAttribute: 'IS_AUTHENTICATED_ANONYMOUSLY').save()
<span class="java&#45;keyword">new</span> Requestmap(url: '/images/&#42;&#42;', configAttribute: 'IS_AUTHENTICATED_ANONYMOUSLY').save()
<span class="java&#45;keyword">new</span> Requestmap(url: '/login/&#42;&#42;', configAttribute: 'IS_AUTHENTICATED_ANONYMOUSLY').save()
<span class="java&#45;keyword">new</span> Requestmap(url: '/logout/&#42;&#42;', configAttribute: 'IS_AUTHENTICATED_ANONYMOUSLY').save()
<span class="java&#45;keyword">new</span> Requestmap(url: '/&#42;', configAttribute: 'IS_AUTHENTICATED_ANONYMOUSLY').save()
<span class="java&#45;keyword">new</span> Requestmap(url: '/profile/&#42;&#42;', configAttribute: 'ROLE_USER').save()
<span class="java&#45;keyword">new</span> Requestmap(url: '/admin/&#42;&#42;', configAttribute: 'ROLE_ADMIN').save()
<span class="java&#45;keyword">new</span> Requestmap(url: '/admin/role/&#42;&#42;', configAttribute: 'ROLE_SUPERVISOR').save()
<span class="java&#45;keyword">new</span> Requestmap(url: '/admin/user/&#42;&#42;', configAttribute: 'ROLE_ADMIN,ROLE_SUPERVISOR').save()
<span class="java&#45;keyword">new</span> Requestmap(url: '/j_spring_security_switch_user',
               configAttribute: 'ROLE_SWITCH_USER,IS_AUTHENTICATED_FULLY').save()</pre></div><p class="paragraph"/>The <code>configAttribute</code> value can have a single value or have multiple comma-delimited values. In this example only users with <code>ROLE_ADMIN</code> or <code>ROLE_SUPERVISOR</code> can access <code>/admin/user/&#42;&#42;</code> urls, and only users with <code>ROLE_SWITCH_USER</code> can access the switch-user url (<code>/j_spring_security_switch_user</code>) and in addition must be authenticated fully, i.e. not using a remember-me cookie. Note that when specifying multiple roles, the user must have at least one of them, but when combining <code>IS_AUTHENTICATED_FULLY</code>, <code>IS_AUTHENTICATED_REMEMBERED</code>, or <code>IS_AUTHENTICATED_ANONYMOUSLY</code> with one or more roles means the user must have one of the roles and satisty the <code>IS_AUTHENTICATED</code> rule.<p class="paragraph"/>Unlike the <a href="../guide/single.html#5.2 Simple Map in Config.groovy" class="guide">Config.groovy Map approach</a>, you do not need to revise the <code>Requestmap</code> entry order because the plugin calculates the most specific rule that applies to the current request.<p class="paragraph"/><h4>Requestmap Cache</h4><p class="paragraph"/><code>Requestmap</code> entries are cached for performance, but caching affects runtime configurability. If you create, edit, or delete an instance, the cache must be flushed and repopulated to be consistent with the database. You can call <code>springSecurityService.clearCachedRequestmaps()</code> to do this. For example, if you create a <code>RequestmapController</code> the <code>save</code> action should look like this (and the update and delete actions should similarly call <code>clearCachedRequestmaps()</code>):<p class="paragraph"/><div class="code"><pre>class RequestmapController &#123;<p class="paragraph"/>   def springSecurityService<p class="paragraph"/>   ...<p class="paragraph"/>   def save = &#123;
      def requestmapInstance = <span class="java&#45;keyword">new</span> Requestmap(params)
      <span class="java&#45;keyword">if</span> (!requestmapInstance.save(flush: <span class="java&#45;keyword">true</span>)) &#123;
         render view: 'create', model: &#91;requestmapInstance: requestmapInstance&#93;
         <span class="java&#45;keyword">return</span>
      &#125;<p class="paragraph"/>      springSecurityService.clearCachedRequestmaps()
      flash.message = <span class="java&#45;quote">"$&#123;message(code: '<span class="java&#45;keyword">default</span>.created.message', args: &#91;message(code: 'requestmap.label', <span class="java&#45;keyword">default</span>: 'Requestmap'), requestmapInstance.id&#93;)&#125;"</span>
      redirect action: show, id: requestmapInstance.id
   &#125;
&#125;</pre></div>
<h2><a name="5.4 Using Expressions to Create Descriptive, Fine-Grained Rules">5.4 Using Expressions to Create Descriptive, Fine-Grained Rules</a></h2>Spring Security uses the <a href="http://static.springsource.org/spring/docs/3.0.x/spring-framework-reference/html/expressions.html" target="blank">Spring Expression Language (SpEL)</a>, which allows you to declare the rules for guarding URLs more descriptively than does the traditional approach, and also allows much more fine-grained rules. Where you traditionally would specify a list of role names and/or special tokens (for example, <code>IS_AUTHENTICATED_FULLY</code>), with <a href="http://static.springsource.org/spring-security/site/docs/3.0.x/reference/el-access.html" target="blank">Spring Security&#39;s expression support</a>, you can instead use the embedded scripting language to define simple or complex access rules.<p class="paragraph"/>You can use expressions with any of the previously described approaches to securing application URLs. For example, consider this annotated controller:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> com.yourcompany.yourapp<p class="paragraph"/><span class="java&#45;keyword">import</span> grails.plugins.springsecurity.Secured<p class="paragraph"/>class SecureController &#123;<p class="paragraph"/>   @Secured(&#91;<span class="java&#45;quote">"hasRole('ROLE_ADMIN')"</span>&#93;)
   def someAction = &#123;
      &#8230;
   &#125;<p class="paragraph"/>   @Secured(&#91;<span class="java&#45;quote">"authentication.name == 'ralph'"</span>&#93;)
   def someOtherAction = &#123;
      &#8230;
   &#125;
&#125;</pre></div><p class="paragraph"/>In this example, <code>someAction</code> requires <code>ROLE_ADMIN</code>, and <code>someOtherAction</code> requires that the user be logged in with username 'ralph'.<p class="paragraph"/>The corresponding <code>Requestmap</code> URLs would be<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">new</span> Requestmap(url: <span class="java&#45;quote">"/secure/someAction"</span>,
               configAttribute: <span class="java&#45;quote">"hasRole('ROLE_ADMIN'"</span>).save()<p class="paragraph"/><span class="java&#45;keyword">new</span> Requestmap(url: <span class="java&#45;quote">"/secure/someOtherAction"</span>,
               configAttribute: <span class="java&#45;quote">"authentication.name == 'ralph'"</span>).save()</pre></div><p class="paragraph"/>and the corresponding static mappings would be<p class="paragraph"/><div class="code"><pre>grails.plugins.springsecurity.interceptUrlMap = &#91;
   '/secure/someAction':      &#91;<span class="java&#45;quote">"hasRole('ROLE_ADMIN'"</span>&#93;,
   '/secure/someOtherAction': &#91;<span class="java&#45;quote">"authentication.name == 'ralph'"</span>&#93;
&#93;</pre></div><p class="paragraph"/>The Spring Security docs have a <a href="http://static.springsource.org/spring-security/site/docs/3.0.x/reference/el-access.html#el-common-built-in" target="blank">table listing the standard expressions</a>, which is copied here for reference:<p class="paragraph"/><table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th><strong class="bold">Expression</strong></th><th><strong class="bold">Description</strong></th></tr><tr class="table-odd"><td><code>hasRole(role)</code></td><td>Returns true if the current principal has the specified role.</td></tr><tr class="table-even"><td><code>hasAnyRole(&#91;role1,role2&#93;)</code></td><td>Returns true if the current principal has any of the supplied roles (given as a comma-separated list of strings)</td></tr><tr class="table-odd"><td><code>principal</code></td><td>Allows direct access to the principal object representing the current user</td></tr><tr class="table-even"><td><code>authentication</code></td><td>Allows direct access to the current Authentication object obtained from the SecurityContext</td></tr><tr class="table-odd"><td><code>permitAll</code></td><td>Always evaluates to true</td></tr><tr class="table-even"><td><code>denyAll</code></td><td>Always evaluates to false</td></tr><tr class="table-odd"><td><code>isAnonymous()</code></td><td>Returns true if the current principal is an anonymous user</td></tr><tr class="table-even"><td><code>isRememberMe()</code></td><td>Returns true if the current principal is a remember-me user</td></tr><tr class="table-odd"><td><code>isAuthenticated()</code></td><td>Returns true if the user is not anonymous</td></tr><tr class="table-even"><td><code>isFullyAuthenticated()</code></td><td>Returns true if the user is not an anonymous or a remember-me user</td></tr></table><p class="paragraph"/>In addition, you can use a web-specific expression <code>hasIpAddress</code>. However, you may find it more convenient to separate IP restrictions from role restrictions by using the <a href="../guide/single.html#18 IP Address Restrictions" class="guide">IP address filter</a>.<p class="paragraph"/>To help you migrate traditional configurations to expressions, this table compares various configurations and their corresponding expressions:<p class="paragraph"/><table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th><strong class="bold">Traditional Config</strong></th><th><strong class="bold">Expression</strong></th></tr><tr class="table-odd"><td><code>ROLE_ADMIN</code></td><td><code>hasRole('ROLE_USER')</code></td></tr><tr class="table-even"><td><code>ROLE_USER,ROLE_ADMIN</code></td><td><code>hasAnyRole('ROLE_USER','ROLE_ADMIN')</code></td></tr><tr class="table-odd"><td><code>ROLE_ADMIN,IS_AUTHENTICATED_FULLY</code></td><td><code>hasRole('ROLE_ADMIN') and isFullyAuthenticated()</code></td></tr><tr class="table-even"><td><code>IS_AUTHENTICATED_ANONYMOUSLY</code></td><td><code>permitAll</code></td></tr><tr class="table-odd"><td><code>IS_AUTHENTICATED_REMEMBERED</code></td><td><code>isAnonymous() or isRememberMe()</code></td></tr><tr class="table-even"><td><code>IS_AUTHENTICATED_FULLY</code></td><td><code>isFullyAuthenticated()</code></td></tr></table>
<h1><a name="6 Helper Classes">6 Helper Classes</a></h1>Use the plugin helper classes in your application to avoid dealing with some lower-level details of Spring Security.
<h2><a name="6.1 SecurityTagLib">6.1 SecurityTagLib</a></h2>The plugin includes GSP tags to support conditional display based on whether the user is authenticated, and/or has the required role to perform a particular action. These tags are in the <code>sec</code> namespace and are implemented in <code>grails.plugins.springsecurity.SecurityTagLib</code>.<p class="paragraph"/><h4>ifLoggedIn</h4>
Displays the inner body content if the user is authenticated.<p class="paragraph"/>Example:<p class="paragraph"/><div class="code"><pre>&#60;sec:ifLoggedIn&#62;
Welcome Back!
&#60;/sec:ifLoggedIn&#62;</pre></div><p class="paragraph"/><h4>ifNotLoggedIn</h4>
Displays the inner body content if the user is not authenticated.<p class="paragraph"/>Example:<p class="paragraph"/><div class="code"><pre>&#60;sec:ifNotLoggedIn&#62;
&#60;g:link controller='login' action='auth'&#62;Login&#60;/g:link&#62;
&#60;/sec:ifNotLoggedIn&#62;</pre></div><p class="paragraph"/><h4>ifAllGranted</h4>
Displays the inner body content only if all of the listed roles are granted.<p class="paragraph"/>Example:<p class="paragraph"/><div class="code"><pre>&#60;sec:ifAllGranted roles=<span class="java&#45;quote">"ROLE_ADMIN,ROLE_SUPERVISOR"</span>&#62;secure stuff here&#60;/sec:ifAllGranted&#62;</pre></div><p class="paragraph"/><h4>ifAnyGranted</h4>
Displays the inner body content if at least one of the listed roles are granted.<p class="paragraph"/>Example:<p class="paragraph"/><div class="code"><pre>&#60;sec:ifAnyGranted roles=<span class="java&#45;quote">"ROLE_ADMIN,ROLE_SUPERVISOR"</span>&#62;secure stuff here&#60;/sec:ifAnyGranted&#62;</pre></div><p class="paragraph"/><h4>ifNotGranted</h4>
Displays the inner body content if none of the listed roles are granted.<p class="paragraph"/>Example:<p class="paragraph"/><div class="code"><pre>&#60;sec:ifNotGranted roles=<span class="java&#45;quote">"ROLE_USER"</span>&#62;non&#45;user stuff here&#60;/sec:ifNotGranted&#62;</pre></div><p class="paragraph"/><h4> loggedInUserInfo</h4>
Displays the value of the specified authentication field if logged in. For example, to show the username property:<p class="paragraph"/><div class="code"><pre>&#60;sec:loggedInUserInfo field=<span class="java&#45;quote">"username"</span>/&#62;</pre></div><p class="paragraph"/>If you have customized the authentication to add a <code>fullName</code> property, you access it as follows:<p class="paragraph"/><div class="code"><pre>Welcome Back &#60;sec:loggedInUserInfo field=<span class="java&#45;quote">"fullName"</span>/&#62;</pre></div><p class="paragraph"/><h4> username</h4>
Displays the value of the authentication <code>username</code> field if logged in.<p class="paragraph"/><div class="code"><pre>&#60;sec:ifLoggedIn&#62;
Welcome Back &#60;sec:username/&#62;!
&#60;/sec:ifLoggedIn&#62;
&#60;sec:ifNotLoggedIn&#62;
&#60;g:link controller='login' action='auth'&#62;Login&#60;/g:link&#62;
&#60;/sec:ifNotLoggedIn&#62;</pre></div><p class="paragraph"/><h4>ifSwitched</h4>
Displays the inner body content only if the current user switched from another user. (See also <a href="../guide/single.html#15 Switch User" class="guide">Switch User</a>.)<p class="paragraph"/><div class="code"><pre>&#60;sec:ifLoggedIn&#62;
Logged in as &#60;sec:username/&#62;
&#60;/sec:ifLoggedIn&#62;<p class="paragraph"/>&#60;sec:ifSwitched&#62;
&#60;a href='$&#123;request.contextPath&#125;/j_spring_security_exit_user'&#62;
   Resume as &#60;sec:switchedUserOriginalUsername/&#62;
&#60;/a&#62;
&#60;/sec:ifSwitched&#62;<p class="paragraph"/>&#60;sec:ifNotSwitched&#62;<p class="paragraph"/>   &#60;sec:ifAllGranted roles='ROLE_SWITCH_USER'&#62;<p class="paragraph"/>   &#60;form action='$&#123;request.contextPath&#125;/j_spring_security_switch_user' method='POST'&#62;<p class="paragraph"/>      Switch to user: &#60;input type='text' name='j_username'/&#62;&#60;br/&#62;<p class="paragraph"/>      &#60;input type='submit' value='Switch'/&#62; &#60;/form&#62;<p class="paragraph"/>   &#60;/sec:ifAllGranted&#62;<p class="paragraph"/>&#60;/sec:ifNotSwitched&#62;</pre></div><p class="paragraph"/><h4>ifNotSwitched</h4>
Displays the inner body content only if the current user has not switched from another user.<p class="paragraph"/><h4>switchedUserOriginalUsername</h4>
Renders the original user's username if the current user switched from another user.<p class="paragraph"/><div class="code"><pre>&#60;sec:ifSwitched&#62;
&#60;a href='$&#123;request.contextPath&#125;/j_spring_security_exit_user'&#62;
   Resume as &#60;sec:switchedUserOriginalUsername/&#62;
&#60;/a&#62;
&#60;/sec:ifSwitched&#62;</pre></div><p class="paragraph"/><h4>access</h4><p class="paragraph"/>Renders the body if the specified expression evaluates to <code>true</code> or specified URL is allowed.<p class="paragraph"/><div class="code"><pre>&#60;sec:access expression=<span class="java&#45;quote">"hasRole('ROLE_USER')"</span>&#62;<p class="paragraph"/>You're a user<p class="paragraph"/>&#60;/sec:access&#62;</pre></div><p class="paragraph"/><div class="code"><pre>&#60;sec:access url=<span class="java&#45;quote">"/admin/user"</span>&#62;<p class="paragraph"/>&#60;g:link controller='admin' action='user'&#62;Manage Users&#60;/g:link&#62;<p class="paragraph"/>&#60;/sec:access&#62;</pre></div><p class="paragraph"/>You can also guard access to links generated from controller and action names or named URL mappings instead of hard-coding the values, for example<p class="paragraph"/><div class="code"><pre>&#60;sec:access controller='admin' action='user'&#62;<p class="paragraph"/>&#60;g:link controller='admin' action='user'&#62;Manage Users&#60;/g:link&#62;<p class="paragraph"/>&#60;/sec:access&#62;</pre></div><p class="paragraph"/>or if you have a named URL mapping you can refer to that:<p class="paragraph"/><div class="code"><pre>&#60;sec:access mapping='manageUsers'&#62;<p class="paragraph"/>&#60;g:link mapping='manageUsers'&#62;Manage Users&#60;/g:link&#62;<p class="paragraph"/>&#60;/sec:access&#62;</pre></div><p class="paragraph"/>For even more control of the generated URL (still avoiding hard-coding) you can use <code>createLink</code> to build the URL, for example<p class="paragraph"/><div class="code"><pre>&#60;sec:access url='$&#123;createLink(controller: 'admin', action: 'user', base: <span class="java&#45;quote">"/"</span>)&#125;'&#62;<p class="paragraph"/>&#60;g:link controller='admin' action='user'&#62;Manage Users&#60;/g:link&#62;<p class="paragraph"/>&#60;/sec:access&#62;</pre></div><p class="paragraph"/>Be sure to include the <code>base: "/"</code> attribute in this case to avoid appending the context name to the URL.<p class="paragraph"/><h4>noAccess</h4><p class="paragraph"/>Renders the body if the specified expression evaluates to <code>false</code> or URL isn't allowed.<p class="paragraph"/><div class="code"><pre>&#60;sec:noAccess expression=<span class="java&#45;quote">"hasRole('ROLE_USER')"</span>&#62;<p class="paragraph"/>You're not a user<p class="paragraph"/>&#60;/sec:noAccess&#62;</pre></div>
<h2><a name="6.2 SpringSecurityService">6.2 SpringSecurityService</a></h2><code>grails.plugins.springsecurity.SpringSecurityService</code> provides security utility functions. It is a regular Grails service, so you use dependency injection to inject it into a controller, service, taglib, and so on:<p class="paragraph"/><div class="code"><pre>def springSecurityService</pre></div><p class="paragraph"/><h4>getCurrentUser()</h4>
Retrieves a domain class instance for the currently authenticated user. During authentication a user/person domain class instance is loaded to get the user's password, roles, etc. and the id of the instance is saved. This method uses the id and the domain class to re-load the instance.<p class="paragraph"/>Example:<p class="paragraph"/><div class="code"><pre>class SomeController &#123;<p class="paragraph"/>   def springSecurityService<p class="paragraph"/>   def someAction = &#123;
      def user = springSecurityService.currentUser
      &#8230;
   &#125;
&#125;</pre></div><p class="paragraph"/><h4>isLoggedIn()</h4>
Checks whether there is a currently logged-in user.<p class="paragraph"/>Example:<p class="paragraph"/><div class="code"><pre>class SomeController &#123;<p class="paragraph"/>   def springSecurityService<p class="paragraph"/>   def someAction = &#123;
      <span class="java&#45;keyword">if</span> (springSecurityService.isLoggedIn()) &#123;
         &#8230;
      &#125;
      <span class="java&#45;keyword">else</span> &#123;
         &#8230;
      &#125;
   &#125;
&#125;</pre></div><p class="paragraph"/><h4>getAuthentication()</h4><p class="paragraph"/>Retrieves the current user's <a href="http://static.springsource.org/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/core/Authentication.html" target="blank">Authentication</a>. If authenticated in, this will typically be a <a href="http://static.springsource.org/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/authentication/UsernamePasswordAuthenticationToken.html" target="blank">UsernamePasswordAuthenticationToken</a>.<p class="paragraph"/>If not authenticated and the <a href="http://static.springsource.org/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/web/authentication/AnonymousAuthenticationFilter.html" target="blank">AnonymousAuthenticationFilter</a> is active (true by default) then the anonymous user's authentication will be returned (<a href="http://static.springsource.org/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/authentication/AnonymousAuthenticationToken.html" target="blank">AnonymousAuthenticationToken</a> with username 'anonymousUser' unless overridden).<p class="paragraph"/>
Example:<p class="paragraph"/><div class="code"><pre>class SomeController &#123;<p class="paragraph"/>   def springSecurityService<p class="paragraph"/>   def someAction = &#123;
      def auth = springSecurityService.authentication
      <span class="java&#45;object">String</span> username = auth.username
      def authorities = auth.authorities // a Collection of GrantedAuthority
      <span class="java&#45;object">boolean</span> authenticated = auth.authenticated
      &#8230;
   &#125;
&#125;</pre></div><p class="paragraph"/><h4>getPrincipal()</h4><p class="paragraph"/>Retrieves the currently logged in user's <code>Principal</code>. If authenticated, the principal will be a <code>org.codehaus.groovy.grails.plugins.springsecurity.GrailsUser</code>, unless you  have created a custom <code>UserDetailsService</code>, in which case it will be whatever implementation of <a href="http://static.springsource.org/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/core/userdetails/UserDetails.html" target="blank">UserDetails</a> you use there.<p class="paragraph"/>If not authenticated and the <a href="http://static.springsource.org/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/web/authentication/AnonymousAuthenticationFilter.html" target="blank">AnonymousAuthenticationFilter</a> is active (true by default) then the anonymous user's name will be returned ('anonymousUser' unless overridden).<p class="paragraph"/>Example:<p class="paragraph"/><div class="code"><pre>class SomeController &#123;<p class="paragraph"/>   def springSecurityService<p class="paragraph"/>   def someAction = &#123;
      def principal = springSecurityService.principal
      <span class="java&#45;object">String</span> username = principal.username
      def authorities = principal.authorities // a Collection of GrantedAuthority
      <span class="java&#45;object">boolean</span> enabled = principal.enabled
      &#8230;
   &#125;
&#125;</pre></div><p class="paragraph"/><h4>encodePassword()</h4>
Encrypts a password with the configured encryption scheme. By default the plugin uses SHA-256, but you can configure the scheme with the <code>grails.plugins.springsecurity.password.algorithm</code> attribute in <code>Config.groovy</code>. You can use any message digest algorithm that is supported in your JDK; see <a href="http://java.sun.com/j2se/1.5.0/docs/guide/security/CryptoSpec.html#AppA" target="blank">this Java page</a>.
<blockquote class="warning">
You are <strong class="bold">strongly</strong> discouraged from using MD5 or SHA-1 algorithms because of their well-known vulnerabilities. You should also use a salt for your passwords, which greatly increases the computational complexity of decrypting passwords if your database gets compromised. See <a href="../guide/single.html#12.2 Salted Passwords" class="guide">Salted Passwords</a>.
</blockquote><p class="paragraph"/>Example:<p class="paragraph"/><div class="code"><pre>class PersonController &#123;<p class="paragraph"/>   def springSecurityService<p class="paragraph"/>   def updateAction = &#123;
      def person = Person.get(params.id)<p class="paragraph"/>      params.salt = person.salt
      <span class="java&#45;keyword">if</span> (person.password != params.password) &#123;
         params.password = springSecurityService.encodePassword(password, salt)
         def salt = &#8230; // e.g. randomly generated using some utility method
         params.salt = salt
      &#125;
      person.properties = params
      <span class="java&#45;keyword">if</span> (!person.save(flush: <span class="java&#45;keyword">true</span>)) &#123;
         render view: 'edit', model: &#91;person: person&#93;
         <span class="java&#45;keyword">return</span>
      &#125;
      redirect action: show, id: person.id
   &#125;
&#125;</pre></div><p class="paragraph"/><blockquote class="note">
If you are encoding the password in the User domain class (using <code>beforeInsert</code> and <code>encodePassword</code>) then don't call <code>springSecurityService.encodePassword()</code> in your controller since you'll double-encrypt the password and users won't be able to log in. It's best to encapsulate the password handling logic in the domain class.
</blockquote><p class="paragraph"/><h4>updateRole()</h4>
Updates a role and, if you use <code>Requestmap</code> instances to secure URLs, updates the role name in all affected <code>Requestmap</code> definitions if the name was changed.<p class="paragraph"/>Example:<p class="paragraph"/><div class="code"><pre>class RoleController &#123;<p class="paragraph"/>   def springSecurityService<p class="paragraph"/>   def update = &#123;
      def roleInstance = Role.get(params.id)
      <span class="java&#45;keyword">if</span> (!springSecurityService.updateRole(roleInstance, params)) &#123;
         render view: 'edit', model: &#91;roleInstance: roleInstance&#93;
         <span class="java&#45;keyword">return</span>
      &#125;<p class="paragraph"/>      flash.message = <span class="java&#45;quote">"The role was updated"</span>
      redirect action: show, id: roleInstance.id
   &#125;
&#125;</pre></div><p class="paragraph"/><h4>deleteRole()</h4>
Deletes a role and, if you use <code>Requestmap</code> instances to secure URLs, removes the role from all affected <code>Requestmap</code> definitions. If a <code>Requestmap</code>'s config attribute is only the role name (for example, "/foo/bar/&#42;&#42;=ROLE_FOO"), it is deleted.<p class="paragraph"/>Example:<p class="paragraph"/><div class="code"><pre>class RoleController &#123;<p class="paragraph"/>   def springSecurityService<p class="paragraph"/>   def delete = &#123;
      def roleInstance = Role.get(params.id)
      <span class="java&#45;keyword">try</span> &#123;
         springSecurityService.deleteRole (roleInstance
         flash.message = <span class="java&#45;quote">"The role was deleted"</span>
         redirect action: list
      &#125;
      <span class="java&#45;keyword">catch</span> (DataIntegrityViolationException e) &#123;
         flash.message = <span class="java&#45;quote">"Unable to delete the role"</span>
         redirect action: show, id: params.id
      &#125;
   &#125;
&#125;</pre></div><p class="paragraph"/><h4>clearCachedRequestmaps()</h4>
Flushes the Requestmaps cache and triggers a complete reload. If you use <code>Requestmap</code> instances to secure URLs, the plugin loads and caches all <code>Requestmap</code> instances as a performance optimization. This action saves database activity because the requestmaps are checked for each request. Do not allow the cache to become stale. When you create, edit or delete a <code>Requestmap</code>, flush the cache. Both <code>updateRole()</code> and <code>deleteRole()</code> call clearCachedRequestmaps()for you. Call this method when you create a new <code>Requestmap</code> or do other <code>Requestmap</code> work that affects the cache.<p class="paragraph"/>Example:<p class="paragraph"/><div class="code"><pre>class RequestmapController &#123;<p class="paragraph"/>   def springSecurityService<p class="paragraph"/>   def save = &#123;
      def requestmapInstance = <span class="java&#45;keyword">new</span> Requestmap(params)
      <span class="java&#45;keyword">if</span> (!requestmapInstance.save(flush: <span class="java&#45;keyword">true</span>)) &#123;
         render view: 'create', model: &#91;requestmapInstance: requestmapInstance&#93;
         <span class="java&#45;keyword">return</span>
      &#125;<p class="paragraph"/>      springSecurityService.clearCachedRequestmaps()
      flash.message = <span class="java&#45;quote">"Requestmap created"</span>
      redirect action: show, id: requestmapInstance.id
   &#125;
&#125;</pre></div><p class="paragraph"/><h4>reauthenticate()</h4>
Rebuilds an <a href="http://static.springsource.org/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/core/Authentication.html" target="blank">Authentication</a> for the given username and registers it in the security context. You typically use this method after updating a user's authorities or other data that is cached in the <code>Authentication</code> or <code>Principal</code>. It also removes the user from the user cache to force a refresh at next login.<p class="paragraph"/>Example:<p class="paragraph"/><div class="code"><pre>class UserController &#123;<p class="paragraph"/>   def springSecurityService<p class="paragraph"/>   def update = &#123;
      def userInstance = User.get(params.id)<p class="paragraph"/>      params.salt = person.salt
      <span class="java&#45;keyword">if</span> (params.password) &#123;
         params.password = springSecurityService.encodePassword(params.password, salt)
         def salt = &#8230; // e.g. randomly generated using some utility method
         params.salt = salt
      &#125;
      userInstance.properties = params
      <span class="java&#45;keyword">if</span> (!userInstance.save(flush: <span class="java&#45;keyword">true</span>)) &#123;
         render view: 'edit', model: &#91;userInstance: userInstance&#93;
         <span class="java&#45;keyword">return</span>
      &#125;<p class="paragraph"/>      <span class="java&#45;keyword">if</span> (springSecurityService.loggedIn &#38;&#38;
             springSecurityService.principal.username == userInstance.username) &#123;
         springSecurityService.reauthenticate userInstance.username
      &#125;<p class="paragraph"/>      flash.message = <span class="java&#45;quote">"The user was updated"</span>
      redirect action: show, id: userInstance.id
   &#125;
&#125;</pre></div>
<h2><a name="6.3 SpringSecurityUtils">6.3 SpringSecurityUtils</a></h2><code>org.codehaus.groovy.grails.plugins.springsecurity.SpringSecurityUtils</code> is a utility class with static methods that you can call directly without using dependency injection. It is primarily an internal class but can be called from application code.<p class="paragraph"/><h4>authoritiesToRoles()</h4>
Extracts role names from an array or <code>Collection</code> of <a href="http://static.springsource.org/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/core/GrantedAuthority.html" target="blank">GrantedAuthority</a>.<p class="paragraph"/><h4>getPrincipalAuthorities()</h4>
Retrieves the currently logged-in user's authorities. It is empty (but never <code>null</code>) if the user is not logged in.<p class="paragraph"/><h4>parseAuthoritiesString()</h4>
Splits a comma-delimited String containing role names into a <code>List</code> of <a href="http://static.springsource.org/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/core/GrantedAuthority.html" target="blank">GrantedAuthority</a>.<p class="paragraph"/><h4>ifAllGranted()</h4>
Checks whether the current user has all specified roles (a comma-delimited String of role names). Primarily used by <code>SecurityTagLib.ifAllGranted</code>.<p class="paragraph"/><h4>ifNotGranted()</h4>
Checks whether the current user has none of the specified roles (a comma-delimited String of role names). Primarily used by <code>SecurityTagLib.ifNotGranted</code>.<p class="paragraph"/><h4>ifAnyGranted()</h4>
Checks whether the current user has any of the specified roles (a comma-delimited String of role names). Primarily used by <code>SecurityTagLib.ifAnyGranted</code>.<p class="paragraph"/><h4>getSecurityConfig()</h4>
Retrieves the security part of the <code>Configuration</code> (from <code>grails-app/conf/Config.groovy</code>).<p class="paragraph"/><h4>loadSecondaryConfig()</h4>
Used by dependent plugins to add configuration attributes.<p class="paragraph"/><h4>reloadSecurityConfig()</h4>
Forces a reload of the security configuration.<p class="paragraph"/><h4>isAjax()</h4>
Checks whether the request was triggered by an Ajax call. The standard way is to determine whether <code>X-Requested-With</code> request header is set and has the value <code>XMLHttpRequest</code>. The plugin only checks whether the header is set to any value. In addition, you can configure the name of the header with the <code>grails.plugins.springsecurity.ajaxHeader</code> configuration attribute, but this is not recommended because all major JavaScript toolkits use the standard name.<p class="paragraph"/>You can also force the request to be treated as Ajax by appending <code>&#38;ajax=true</code> to your request query string.<p class="paragraph"/><h4>registerProvider()</h4>
Used by dependent plugins to register an <a href="http://static.springsource.org/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/authentication/AuthenticationProvider.html" target="blank">AuthenticationProvider</a> bean name.<p class="paragraph"/><h4>registerFilter()</h4>
Used by dependent plugins to register a filter bean name in a specified position in the filter chain.<p class="paragraph"/><h4>isSwitched()</h4>
Checks whether the current user switched from another user.<p class="paragraph"/><h4>getSwitchedUserOriginalUsername()</h4>
Gets the original user's username if the current user switched from another user.<p class="paragraph"/><h4>doWithAuth()</h4><p class="paragraph"/>Executes a Closure with the current authentication. The one-parameter version which takes just a Closure assumes that there's an authentication in the HTTP Session and that the Closure is running in a separate thread from the web request, so the <code>SecurityContext</code> and <code>Authentication</code> aren't available to the standard <code>ThreadLocal</code>. This is primarily of use when you explicitly launch a new thread from a controller action or service called in request scope, not from a Quartz job which isn't associated with an authentication in any thread.<p class="paragraph"/>The two-parameter version takes a Closure and a username to authenticate as. This is will authenticate as the specified user and execute the closure with that authentication. It restores the authentication to the one that was active if it exists, or clears the context otherwise. This is similar to run-as and switch-user but is only local to the Closure.
<h1><a name="7 Events">7 Events</a></h1>Spring Security fires application events after various security-related actions such as successful login, unsuccessful login, and so on. Spring Security uses two main event classes, <a href="http://static.springsource.org/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/authentication/event/AbstractAuthenticationEvent.html" target="blank">AbstractAuthenticationEvent</a> and <a href="http://static.springsource.org/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/access/event/AbstractAuthorizationEvent.html" target="blank">AbstractAuthorizationEvent</a>.
<h2><a name="7.1 Event Notification">7.1 Event Notification</a></h2>You can set up event notifications in two ways. The sections that follow describe each approach in more detail.
<ul class="star">
<li>Register an event listener, ignoring events that do not interest you. Spring allows only partial event subscription; you use generics to register the class of events that interest you, and you are notified of that class and all subclasses.</li>
<li>Register one or more callback closures in <code>grails-app/conf/Config.groovy</code> that take advantage of the plugin's <code>org.codehaus.groovy.grails.plugins.springsecurity.SecurityEventListener</code>. The listener does the filtering for you.</li>
</ul><p class="paragraph"/><h4>AuthenticationEventPublisher</h4><p class="paragraph"/>Spring Security publishes events using an <a href="http://static.springsource.org/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/authentication/AuthenticationEventPublisher.html" target="blank">AuthenticationEventPublisher</a> which in turn fire events using the <a href="http://static.springsource.org/spring/docs/3.0.x/javadoc-api/org/springframework/context/ApplicationEventPublisher.html" target="blank">ApplicationEventPublisher</a>. By default no events are fired since the <code>AuthenticationEventPublisher</code> instance registered is a <code>org.codehaus.groovy.grails.plugins.springsecurity.NullAuthenticationEventPublisher</code>. But you can enable event publishing by setting <code>grails.plugins.springsecurity.useSecurityEventListener = true</code> in <code>grails-app/conf/Config.groovy</code>.<p class="paragraph"/>You can use the <code>useSecurityEventListener</code> setting to temporarily disable and enable the callbacks, or enable them per-environment.<p class="paragraph"/><h4>UsernameNotFoundException</h4><p class="paragraph"/>Most authentication exceptions trigger an event with a similar name as described in this table:<p class="paragraph"/><table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th><strong class="bold">Exception</strong></th><th><strong class="bold">Event</strong></th></tr><tr class="table-odd"><td>AccountExpiredException</td><td>AuthenticationFailureExpiredEvent</td></tr><tr class="table-even"><td>AuthenticationServiceException</td><td>AuthenticationFailureServiceExceptionEvent</td></tr><tr class="table-odd"><td>LockedException</td><td>AuthenticationFailureLockedEvent</td></tr><tr class="table-even"><td>CredentialsExpiredException</td><td>AuthenticationFailureCredentialsExpiredEvent</td></tr><tr class="table-odd"><td>DisabledException</td><td>AuthenticationFailureDisabledEvent</td></tr><tr class="table-even"><td>BadCredentialsException</td><td>AuthenticationFailureBadCredentialsEvent</td></tr><tr class="table-odd"><td>UsernameNotFoundException</td><td>AuthenticationFailureBadCredentialsEvent</td></tr><tr class="table-even"><td>ProviderNotFoundException</td><td>AuthenticationFailureProviderNotFoundEvent</td></tr></table><p class="paragraph"/>This holds for all exceptions except <code>UsernameNotFoundException</code> which triggers an <code>AuthenticationFailureBadCredentialsEvent</code> just like a <code>BadCredentialsException</code>. This is a good idea since it doesn't expose extra information - there's no differentiation between a bad password and a missing user. In addition, by default a missing user will trigger a <code>BadCredentialsException</code> for the same reasons. You can configure Spring Security to re-throw the original <code>UsernameNotFoundException</code> instead of converting it to a <code>BadCredentialsException</code> by setting <code>grails.plugins.springsecurity.dao.hideUserNotFoundExceptions = false</code> in <code>grails-app/conf/Config.groovy</code>.<p class="paragraph"/>Fortunately all subclasses of <a href="http://static.springsource.org/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/authentication/event/AbstractAuthenticationFailureEvent.html" target="blank">AbstractAuthenticationFailureEvent</a> have a <code>getException()</code> method that gives you access to the exception that triggered the event, so you can use that to differentiate between a bad password and a missing user (if <code>hideUserNotFoundExceptions=false</code>).
<h2><a name="7.2 Registering an Event Listener">7.2 Registering an Event Listener</a></h2>Enable events with <code>grails.plugins.springsecurity.useSecurityEventListener = true</code> and create one or more Groovy or Java classes, for example:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> com.foo.bar<p class="paragraph"/><span class="java&#45;keyword">import</span> org.springframework.context.ApplicationListener
<span class="java&#45;keyword">import</span> org.springframework.security.authentication.event.AuthenticationSuccessEvent<p class="paragraph"/>class MySecurityEventListener <span class="java&#45;keyword">implements</span> ApplicationListener&#60;AuthenticationSuccessEvent&#62; &#123;<p class="paragraph"/>   void onApplicationEvent(AuthenticationSuccessEvent event) &#123;
      // handle the event
   &#125;
&#125;</pre></div><p class="paragraph"/>Register the class in <code>grails-app/conf/spring/resources.groovy</code>:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> com.foo.bar.MySecurityEventListener<p class="paragraph"/>beans = &#123;
   mySecurityEventListener(MySecurityEventListener)
&#125;</pre></div>
<h2><a name="7.3 Registering Callback Closures">7.3 Registering Callback Closures</a></h2>Alternatively, enable events with <code>grails.plugins.springsecurity.useSecurityEventListener = true</code> and register one or more callback closure(s) in <code>grails-app/conf/Config.groovy</code> and let <code>SecurityEventListener</code> do the filtering.<p class="paragraph"/>Implement the event handlers that you need, for example:<p class="paragraph"/><div class="code"><pre>grails.plugins.springsecurity.useSecurityEventListener = <span class="java&#45;keyword">true</span><p class="paragraph"/>grails.plugins.springsecurity.onInteractiveAuthenticationSuccessEvent = &#123; e, appCtx &#45;&#62;
   // handle InteractiveAuthenticationSuccessEvent
&#125;<p class="paragraph"/>grails.plugins.springsecurity.onAbstractAuthenticationFailureEvent = &#123; e, appCtx &#45;&#62;
   // handle AbstractAuthenticationFailureEvent
&#125;<p class="paragraph"/>grails.plugins.springsecurity.onAuthenticationSuccessEvent = &#123; e, appCtx &#45;&#62;
   // handle AuthenticationSuccessEvent
&#125;<p class="paragraph"/>grails.plugins.springsecurity.onAuthenticationSwitchUserEvent = &#123; e, appCtx &#45;&#62;
   // handle AuthenticationSwitchUserEvent
&#125;<p class="paragraph"/>grails.plugins.springsecurity.onAuthorizationEvent = &#123; e, appCtx &#45;&#62;
   // handle AuthorizationEvent
&#125;</pre></div><p class="paragraph"/>None of these closures are required; if none are configured, nothing will be called. Just implement the event handlers that you need.<p class="paragraph"/><strong class="bold">Note:</strong> When a user authenticates, Spring Security initially fires an <code>AuthenticationSuccessEvent</code>. This event fires before the <code>Authentication</code> is registered in the <code>SecurityContextHolder</code>, which means that the <code>springSecurityService</code> methods that access the logged-in user will not work. Later in the processing a second event is fired, an <code>InteractiveAuthenticationSuccessEvent</code>, and when this happens the <code>SecurityContextHolder</code> will have the <code>Authentication</code>. Depending on your needs, you can implement a callback for either or both events.
<h1><a name="8 User, Authority (Role), and Requestmap Properties">8 User, Authority (Role), and Requestmap Properties</a></h1>Properties you are most likely to be override are the <code>User</code> and <code>Authority</code> (and <code>Requestmap</code> if you use the database to store mappings) class and field names.<p class="paragraph"/><table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th><strong class="bold">Property</strong></th><th><strong class="bold">Default Value</strong></th><th><strong class="bold">Meaning</strong></th></tr><tr class="table-odd"><td>userLookup.userDomainClassName</td><td>'Person'</td><td>User class name.</td></tr><tr class="table-even"><td>userLookup.usernamePropertyName</td><td>'username'</td><td>User class username field.</td></tr><tr class="table-odd"><td>userLookup.passwordPropertyName</td><td>'password'</td><td>User class password field.</td></tr><tr class="table-even"><td>userLookup.authoritiesPropertyName</td><td>'authorities'</td><td>User class role collection field.</td></tr><tr class="table-odd"><td>userLookup.enabledPropertyName</td><td>'enabled'</td><td>User class enabled field.</td></tr><tr class="table-even"><td>userLookup.accountExpiredPropertyName</td><td>'accountExpired'</td><td>User class account expired field.</td></tr><tr class="table-odd"><td>userLookup.accountLockedPropertyName</td><td>'accountLocked'</td><td>User class account locked field.</td></tr><tr class="table-even"><td>userLookup.passwordExpiredPropertyName</td><td>'passwordExpired'</td><td>User class password expired field.</td></tr><tr class="table-odd"><td>userLookup.authorityJoinClassName</td><td>'PersonAuthority'</td><td>User/Role many-many join class name.</td></tr><tr class="table-even"><td>authority.className</td><td>'Authority'</td><td>Role class name.</td></tr><tr class="table-odd"><td>authority.nameField</td><td>'authority'</td><td>Role class role name field.</td></tr><tr class="table-even"><td>requestMap.className</td><td>'Requestmap'</td><td>Requestmap class name.</td></tr><tr class="table-odd"><td>requestMap.urlField</td><td>'url'</td><td>Requestmap class URL pattern field.</td></tr><tr class="table-even"><td>requestMap.configAttributeField</td><td>'configAttribute'</td><td>Requestmap class role/token field.</td></tr></table>
<h1><a name="9 Authentication">9 Authentication</a></h1>The Spring Security plugin supports several approaches to authentication.<p class="paragraph"/>The default approach stores users and roles in your database, and uses an HTML login form which prompts the user for a username and password. The plugin also supports other approaches as described in the sections below, as well as add-on plugins that provide external authentication providers such as <a href="http://grails.org/plugin/spring-security-openid" target="blank">OpenID</a>, <a href="http://grails.org/plugin/spring-security-ldap" target="blank">LDAP</a>, and single sign-on using <a href="http://grails.org/plugin/spring-security-cas" target="blank">CAS</a>
<h2><a name="9.1 Basic and Digest Authentication">9.1 Basic and Digest Authentication</a></h2>To use <a href="http://en.wikipedia.org/wiki/Basic_access_authentication" target="blank">HTTP Basic Authentication</a> in your application, set the <code>useBasicAuth</code> attribute to <code>true</code>. Also change the <code>basic.realmName</code> default value to one that suits your application, for example:<p class="paragraph"/><div class="code"><pre>grails.plugins.springsecurity.useBasicAuth = <span class="java&#45;keyword">true</span>
grails.plugins.springsecurity.basic.realmName = <span class="java&#45;quote">"Ralph's Bait and Tackle"</span></pre></div><p class="paragraph"/><table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th><strong class="bold">Property</strong></th><th><strong class="bold">Default</strong></th><th><strong class="bold">Description</strong></th></tr><tr class="table-odd"><td>useBasicAuth</td><td><code>false</code></td><td>Whether to use basic authentication.</td></tr><tr class="table-even"><td>basic.realmName</td><td>'Grails Realm'</td><td>Realm name displayed in the browser authentication popup.</td></tr></table><p class="paragraph"/>With this authentication in place, users are prompted with the standard browser login dialog instead of being redirected to a login page.<p class="paragraph"/>If you don't want all of your URLs guarded by Basic Auth, you can partition the URL patterns and apply Basic Auth to some, but regular form login to others. For example, if you have a web service that uses Basic Auth for <code>/webservice/&#42;&#42;</code> URLs, you would configure that using the <code>chainMap</code> config attribute:<p class="paragraph"/><div class="code"><pre>grails.plugins.springsecurity.filterChain.chainMap = &#91;
   '/webservice/&#42;&#42;': 'JOINED_FILTERS,&#45;exceptionTranslationFilter',
   '/&#42;&#42;': 'JOINED_FILTERS,&#45;basicAuthenticationFilter,&#45;basicExceptionTranslationFilter'
&#93;</pre></div><p class="paragraph"/>In this example we're using the <code>JOINED_FILTERS</code> keyword instead of explicitly listing the filter names. Specifying <code>JOINED_FILTERS</code> means to use all of the filters that were configured using the various config options. In each case we also specify that we want to exclude one or more filters by prefixing their names with <code>-</code>.<p class="paragraph"/>For the <code>/webservice/&#42;&#42;</code> URLs, we want all filters except for the standard <code>ExceptionTranslationFilter</code> since we want to use just the one configured for Basic Auth. And for the <code>/&#42;&#42;</code> URLs (everything else) we want everything except for the Basic Auth filter and its configured <code>ExceptionTranslationFilter</code>.<p class="paragraph"/><a href="http://en.wikipedia.org/wiki/Digest_access_authentication" target="blank">Digest Authentication</a> is similar to Basic but is more secure because it does not send your password in obfuscated cleartext. Digest resembles Basic in practice - you get the same browser popup dialog when you authenticate. But because the credential transfer is genuinely encrypted (instead of just Base64-encoded as with Basic authentication) you do not need SSL to guard your logins.<p class="paragraph"/><table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th><strong class="bold">Property</strong></th><th><strong class="bold">Default Value</strong></th><th><strong class="bold">Meaning</strong></th></tr><tr class="table-odd"><td>useDigestAuth</td><td><code>false</code></td><td>Whether to use Digest authentication.</td></tr><tr class="table-even"><td>digest.realmName</td><td>'Grails Realm'</td><td>Realm name displayed in the browser popup</td></tr><tr class="table-odd"><td>digest.key</td><td>'changeme'</td><td>Key used to build the nonce for authentication; it should be changed but that's not required.</td></tr><tr class="table-even"><td>digest.nonceValiditySeconds</td><td>300</td><td>How long a nonce stays valid.</td></tr><tr class="table-odd"><td>digest.passwordAlreadyEncoded</td><td><code>false</code></td><td>Whether you are managing the password encryption yourself.</td></tr><tr class="table-even"><td>digest.createAuthenticatedToken</td><td><code>false</code></td><td>If <code>true</code>, creates an authenticated <code>UsernamePasswordAuthenticationToken</code> to avoid loading the user from the database twice. However, this process skips the isAccountNonExpired(), isAccountNonLocked(), isCredentialsNonExpired(), isEnabled() checks, so it is not advised.</td></tr><tr class="table-odd"><td>digest.useCleartextPasswords</td><td><code>false</code></td><td>If <code>true</code>, a cleartext password encoder is used (not recommended). If <code>false</code>, passwords encrypted by <code>DigestAuthPasswordEncoder</code> are stored in the database.</td></tr></table><p class="paragraph"/>Digest authentication has a problem in that by default you store cleartext passwords in your database. This is because the browser encrypts your password along with the username and Realm name, and this is compared to the password encrypted using the same algorithm during authentication. The browser does not know about your <code>MessageDigest</code> algorithm or salt source, so to encrypt them the same way you need to load a cleartext password from the database.<p class="paragraph"/>The plugin does provide an alternative, although it has no configuration options (in particular the digest algorithm cannot be changed). If <code>digest.useCleartextPasswords</code> is <code>false</code> (the default), then the <code>passwordEncoder</code> bean is replaced with an instance of <code>grails.plugins.springsecurity.DigestAuthPasswordEncoder</code>. This encoder uses the same approach as the browser, that is, it combines your password along with your username and Realm name essentially as a salt, and encrypts with MD5. MD5 is not recommended in general, but given the typical size of the salt it is reasonably safe to use.<p class="paragraph"/>The only required attribute is <code>useDigestAuth</code>, which you must set to <code>true</code>, but you probably also want to change the realm name:<p class="paragraph"/><div class="code"><pre>grails.plugins.springsecurity.useDigestAuth = <span class="java&#45;keyword">true</span>
grails.plugins.springsecurity.digest.realmName = <span class="java&#45;quote">"Ralph's Bait and Tackle"</span></pre></div><p class="paragraph"/>Digest authentication cannot be applied to a subset of URLs like Basic authentication can. This is due to the password encoding issues. So you cannot use the <code>chainMap</code> attribute here - all URLs will be guarded.
<h2><a name="9.2 Certificate (X509) Login Authentication">9.2 Certificate (X509) Login Authentication</a></h2>Another authentication mechanism supported by Spring Security is certificate-based, or "mutual authentication". It requires HTTPS, and you must configure the server to require a client certificate (ordinarily only the server provides a certificate). Your username is extracted from the client certificate if it is valid, and you are "pre-authenticated". As long as a corresponding username exists in the database, your authentication succeeds and you are not asked for a password. Your <code>Authentication</code> contains the authorities associated with your username.<p class="paragraph"/>The table describes available configuration options.<p class="paragraph"/><table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th><strong class="bold">Property</strong></th><th><strong class="bold">Default Value</strong></th><th><strong class="bold">Meaning</strong></th></tr><tr class="table-odd"><td>useX509</td><td><code>false</code></td><td>Whether to support certificate-based logins</td></tr><tr class="table-even"><td>x509.continueFilterChainOnUnsuccessfulAuthentication</td><td><code>true</code></td><td>Whether to proceed when an authentication attempt fails to allow other authentication mechanisms to process the request.</td></tr><tr class="table-odd"><td>x509.subjectDnRegex</td><td><code>'CN=(.&#42;?),'</code></td><td>Regular expression (regex) for extracting the username from the certificate's subject name.</td></tr><tr class="table-even"><td>x509.checkForPrincipalChanges</td><td><code>false</code></td><td>Whether to re-extract the username from the certificate and check that it's still the current user when a valid <code>Authentication</code> already exists.</td></tr><tr class="table-odd"><td>x509.invalidateSessionOnPrincipalChange</td><td><code>true</code></td><td>Whether to invalidate the session if the principal changed (based on a <code>checkForPrincipalChanges</code> check).</td></tr></table><p class="paragraph"/>The details of configuring your server for SSL and configuring browser certificates are beyond the scope of this document. If you use Tomcat, see its <a href="http://tomcat.apache.org/tomcat-6.0-doc/ssl-howto.html" target="blank">SSL documentation</a>. To get a test environment working, see the instructions in <a href="http://stackoverflow.com/questions/1180397/tomcat-server-client-self-signed-ssl-certificate" target="blank">this discussion at Stack Overflow</a>.
<h2><a name="9.3 Remember-Me Cookie">9.3 Remember-Me Cookie</a></h2>Spring Security supports creating a remember-me cookie so that users are not required to log in with a username and password for each session. This is optional and is usually implemented as a checkbox on the login form; the default <code>auth.gsp</code> supplied by the plugin has this feature.<p class="paragraph"/><table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th><strong class="bold">Property</strong></th><th><strong class="bold">Default Value</strong></th><th><strong class="bold">Meaning</strong></th></tr><tr class="table-odd"><td>rememberMe.cookieName</td><td>'grails_remember_me'</td><td>remember-me cookie name; should be unique per application.</td></tr><tr class="table-even"><td>rememberMe.alwaysRemember</td><td><code>false</code></td><td>If <code>true</code>, create a remember-me cookie even if no checkbox is on the form.</td></tr><tr class="table-odd"><td>rememberMe.tokenValiditySeconds</td><td>1209600 (14 days)</td><td>Max age of the cookie in seconds.</td></tr><tr class="table-even"><td>rememberMe.parameter</td><td>'_spring_security_remember_me'</td><td>Login form remember-me checkbox name.</td></tr><tr class="table-odd"><td>rememberMe.key</td><td>'grailsRocks'</td><td>Value used to encode cookies; should be unique per application.</td></tr><tr class="table-even"><td>rememberMe.useSecureCookie</td><td>false</td><td>Whether to use a secure cookie or not</td></tr><tr class="table-odd"><td>rememberMe.persistent</td><td><code>false</code></td><td>If <code>true</code>, stores persistent login information in the database.</td></tr><tr class="table-even"><td>rememberMe.persistentToken.domainClassName</td><td>'PersistentLogin'</td><td>Domain class used to manage persistent logins.</td></tr><tr class="table-odd"><td>rememberMe.persistentToken.seriesLength</td><td>16</td><td>Number of characters in the cookie's <code>series</code> attribute.</td></tr><tr class="table-even"><td>rememberMe.persistentToken.tokenLength</td><td>16</td><td>Number of characters in the cookie's <code>token</code> attribute.</td></tr><tr class="table-odd"><td>atr.rememberMeClass</td><td><a href="http://static.springsource.org/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/authentication/RememberMeAuthenticationToken.html" target="blank">RememberMeAuthenticationToken</a></td><td>remember-me authentication class.</td></tr></table><p class="paragraph"/>You are most likely to change these attributes:
<ul class="star">
<li><code>rememberMe.cookieName</code>. Purely aesthetic as most users will not look at their cookies, but you probably want the display name to be application-specific rather than "grails_remember_me".</li>
<li><code>rememberMe.key</code>. Part of a salt when the cookie is encrypted. Changing the default makes it harder to execute brute-force attacks.</li>
<li><code>rememberMe.tokenValiditySeconds</code>. Default is two weeks; set it to what makes sense for your application.</li>
</ul><p class="paragraph"/><h4>Persistent Logins</h4>
The remember-me cookie is very secure, but for an even stronger solution you can use persistent logins that store the username in the database. See the <a href="http://static.springsource.org/spring-security/site/docs/3.0.x/reference/rememberMe.html" target="blank">Spring Security docs</a> for a description of the implementation.<p class="paragraph"/>Persistent login is also useful for authentication schemes like OpenID and Facebook, where you do not manage passwords in your database, but most of the other user information is stored locally. Without a password you cannot use the standard cookie format, so persistent logins enable remember-me cookies in these scenarios.<p class="paragraph"/>To use this feature, run the <a href="../ref/Scripts/s2-create-persistent-token.html" class="Scripts">s2-create-persistent-token</a> script. This will create the domain class, and register its name in <code>grails-app/conf/Config.groovy</code>. It will also enable persistent logins by setting <code>rememberMe.persistent</code> to <code>true</code>.
<h2><a name="9.4 Ajax Authentication">9.4 Ajax Authentication</a></h2>The typical pattern of using web site authentication to access restricted pages involves intercepting access requests for secure pages, redirecting to a login page (possibly off-site, for example when using <a href="http://grails.org/plugin/spring-security-openid" target="blank">OpenID</a> or a Single Sign-on implementation such as <a href="http://grails.org/plugin/spring-security-cas" target="blank">CAS</a>), and redirecting back to the originally-requested page after a successful login. Each page can also have a login link to allow explicit logins at any time.<p class="paragraph"/>Another option is to also have a login link on each page and to use Ajax and DHTML to present a login form within the current page in a popup. The form submits the authentication request through Ajax and displays success or error messages as appropriate.<p class="paragraph"/>The plugin supports Ajax logins, but you need to create your own GSP code. There are only a few necessary changes, and of course the sample code here is pretty basic so you should enhance it for your needs.<p class="paragraph"/>The approach here involves editing your template page(s) to show "You're logged in as ..." text if logged in and a login link if not, along with a hidden login form that is shown using DHTML.<p class="paragraph"/>Here's the updated <code>grails-app/views/layouts/main.gsp</code>:<p class="paragraph"/><div class="code"><pre>&#60;html&#62;<p class="paragraph"/>&#60;head&#62;
&#60;title&#62;&#60;g:layoutTitle <span class="java&#45;keyword">default</span>=<span class="java&#45;quote">"Grails"</span> /&#62;&#60;/title&#62;
&#60;link rel=<span class="java&#45;quote">"stylesheet"</span> href=<span class="java&#45;quote">"$&#123;resource(dir:'css',file:'main.css')&#125;"</span> /&#62;
&#60;link rel=<span class="java&#45;quote">"shortcut icon"</span> type=<span class="java&#45;quote">"image/x&#45;icon"</span>
      href=<span class="java&#45;quote">"$&#123;resource(dir:'images',file:'favicon.ico')&#125;"</span> /&#62;
&#60;g:layoutHead /&#62;
&#60;/head&#62;<p class="paragraph"/>&#60;body&#62;<p class="paragraph"/>   &#60;div id=<span class="java&#45;quote">"spinner"</span> class=<span class="java&#45;quote">"spinner"</span> style=<span class="java&#45;quote">"display:none;"</span>&#62;
      &#60;img src=<span class="java&#45;quote">"$&#123;resource(dir:'images',file:'spinner.gif')&#125;"</span> alt=<span class="java&#45;quote">"Spinner"</span> /&#62;
   &#60;/div&#62;<p class="paragraph"/>   &#60;div id=<span class="java&#45;quote">"grailsLogo"</span> class=<span class="java&#45;quote">"logo"</span>&#62;
      &#60;a href=<span class="java&#45;quote">"http://grails.org"</span>&#62;
         &#60;img src=<span class="java&#45;quote">"$&#123;resource(dir:'images',file:'grails_logo.png')&#125;"</span> alt=<span class="java&#45;quote">"Grails"</span> border=<span class="java&#45;quote">"0"</span> /&#62;
      &#60;/a&#62;<p class="paragraph"/>      &#60;span id='loginLink' style='position: relative; margin&#45;right: 30px; <span class="java&#45;object">float</span>: right'&#62;
      &#60;sec:ifLoggedIn&#62;
         Logged in as &#60;sec:username/&#62; (&#60;g:link controller='logout'&#62;Logout&#60;/g:link&#62;)
      &#60;/sec:ifLoggedIn&#62;
      &#60;sec:ifNotLoggedIn&#62;
         &#60;a href='&#35;' onclick='showLogin(); <span class="java&#45;keyword">return</span> <span class="java&#45;keyword">false</span>;'&#62;Login&#60;/a&#62;
      &#60;/sec:ifNotLoggedIn&#62;
      &#60;/span&#62;<p class="paragraph"/>   &#60;/div&#62;<p class="paragraph"/>   &#60;g:javascript src='application.js' /&#62;
   &#60;g:javascript library='prototype' /&#62;
   &#60;g:javascript src='prototype/scriptaculous.js?load=effects' /&#62;<p class="paragraph"/>   &#60;g:render template='/includes/ajaxLogin'/&#62;<p class="paragraph"/>   &#60;g:layoutBody /&#62;<p class="paragraph"/>   &#60;/body&#62;
&#60;/html&#62;</pre></div><p class="paragraph"/>Note these changes:
<ul class="star">
<li>The prototype and scriptaculous libraries are included for Ajax support and to hide and show the login form.</li>
<li>There is an include of the template <code>/includes/ajaxLogin</code> (see the code below).</li>
<li>There is a &#60;span&#62; positioned in the top-right that shows the username and a logout link when logged in, and a login link otherwise.</li>
</ul><p class="paragraph"/>Here is the content of the login form template (<code>grails-app/views/includes/_ajaxLogin.gsp</code>). The CSS and Javascript are shown inline, but you should extract them to their own static files.<p class="paragraph"/><div class="code"><pre>&#60;style&#62;
&#35;ajaxLogin &#123;
   margin: 15px 0px; padding: 0px;
   text&#45;align: center;
   display: none;
   position: absolute;
&#125;
&#35;ajaxLogin .<span class="java&#45;keyword">inner</span> &#123;
   width: 260px;
   margin:0px auto;
   text&#45;align:left;
   padding:10px;
   border&#45;top:1px dashed &#35;499ede;
   border&#45;bottom:1px dashed &#35;499ede;
   background&#45;color:&#35;EEF;
&#125;
&#35;ajaxLogin .<span class="java&#45;keyword">inner</span> .fheader &#123;
   padding:4px;margin:3px 0px 3px 0;color:&#35;2e3741;font&#45;size:14px;font&#45;weight:bold;
&#125;
&#35;ajaxLogin .<span class="java&#45;keyword">inner</span> .cssform p &#123;
   clear: left;
   margin: 0;
   padding: 5px 0 8px 0;
   padding&#45;left: 105px;
   border&#45;top: 1px dashed gray;
   margin&#45;bottom: 10px;
   height: 1%;
&#125;
&#35;ajaxLogin .<span class="java&#45;keyword">inner</span> .cssform input&#91;type='text'&#93; &#123;
   width: 120px;
&#125;
&#35;ajaxLogin .<span class="java&#45;keyword">inner</span> .cssform label&#123;
   font&#45;weight: bold;
   <span class="java&#45;object">float</span>: left;
   margin&#45;left: &#45;105px;
   width: 100px;
&#125;
&#35;ajaxLogin .<span class="java&#45;keyword">inner</span> .login_message &#123;color:red;&#125;
&#35;ajaxLogin .<span class="java&#45;keyword">inner</span> .text_ &#123;width:120px;&#125;
&#35;ajaxLogin .<span class="java&#45;keyword">inner</span> .chk &#123;height:12px;&#125;
.errorMessage &#123; color: red; &#125;
&#60;/style&#62;<p class="paragraph"/>&#60;div id='ajaxLogin'&#62;
   &#60;div class='<span class="java&#45;keyword">inner</span>'&#62;
   &#60;div class='fheader'&#62;Please Login..&#60;/div&#62;
   &#60;form action='$&#123;request.contextPath&#125;/j_spring_security_check' method='POST'
       id='ajaxLoginForm' name='ajaxLoginForm' class='cssform'&#62;
      &#60;p&#62;
         &#60;label <span class="java&#45;keyword">for</span>='username'&#62;Login ID&#60;/label&#62;
         &#60;input type='text' class='text_' name='j_username' id='username' /&#62;
      &#60;/p&#62;
      &#60;p&#62;
         &#60;label <span class="java&#45;keyword">for</span>='password'&#62;Password&#60;/label&#62;
         &#60;input type='password' class='text_' name='j_password' id='password' /&#62;
      &#60;/p&#62;
      &#60;p&#62;
         &#60;label <span class="java&#45;keyword">for</span>='remember_me'&#62;Remember me&#60;/label&#62;
         &#60;input type='checkbox' class='chk' id='remember_me'
                name='_spring_security_remember_me'/&#62;
      &#60;/p&#62;
      &#60;p&#62;
         &#60;a href='javascript:void(0)' onclick='authAjax(); <span class="java&#45;keyword">return</span> <span class="java&#45;keyword">false</span>;'&#62;Login&#60;/a&#62;
         &#60;a href='javascript:void(0)' onclick='cancelLogin(); <span class="java&#45;keyword">return</span> <span class="java&#45;keyword">false</span>;'&#62;Cancel&#60;/a&#62;
      &#60;/p&#62;
   &#60;/form&#62;
    &#60;div style='display: none; text&#45;align: left;' id='loginMessage'&#62;&#60;/div&#62;
   &#60;/div&#62;
&#60;/div&#62;<p class="paragraph"/>&#60;script type='text/javascript'&#62;<p class="paragraph"/>// center the form
Event.observe(window, 'load', function() &#123;
   <span class="java&#45;keyword">var</span> ajaxLogin = $('ajaxLogin');
   $('ajaxLogin').style.left = ((document.body.getDimensions().width &#45;
                                 ajaxLogin.getDimensions().width) / 2) + 'px';
   $('ajaxLogin').style.top = ((document.body.getDimensions().height &#45;
                                ajaxLogin.getDimensions().height) / 2) + 'px';
&#125;);<p class="paragraph"/>function showLogin() &#123;
   $('ajaxLogin').style.display = 'block';
&#125;<p class="paragraph"/>function cancelLogin() &#123;
   Form.enable(document.ajaxLoginForm);
   Element.hide('ajaxLogin');
&#125;<p class="paragraph"/>function authAjax() &#123;
   Form.enable(document.ajaxLoginForm);
   Element.update('loginMessage', 'Sending request ...');
   Element.show('loginMessage');<p class="paragraph"/>   <span class="java&#45;keyword">var</span> form = document.ajaxLoginForm;
   <span class="java&#45;keyword">var</span> params = Form.serialize(form);
   Form.disable(form);
   <span class="java&#45;keyword">new</span> Ajax.Request(form.action, &#123;
      method: 'POST',
      postBody: params,
      onSuccess: function(response) &#123;
         Form.enable(document.ajaxLoginForm);
         <span class="java&#45;keyword">var</span> responseText = response.responseText || '&#91;&#93;';
         <span class="java&#45;keyword">var</span> json = responseText.evalJSON();
         <span class="java&#45;keyword">if</span> (json.success) &#123;
            Element.hide('ajaxLogin');
            $('loginLink').update('Logged in as ' + json.username +
                                  ' (&#60;%=link(controller: 'logout') &#123; 'Logout' &#125;%&#62;)');
         &#125;
         <span class="java&#45;keyword">else</span> <span class="java&#45;keyword">if</span> (json.error) &#123;
            Element.update('loginMessage', <span class="java&#45;quote">"&#60;span class='errorMessage'&#62;"</span> +
                                           json.error + '&#60;/error&#62;');
         &#125;
         <span class="java&#45;keyword">else</span> &#123;
            Element.update('loginMessage', responseText);
         &#125;
      &#125;
   &#125;);
&#125;
&#60;/script&#62;</pre></div><p class="paragraph"/>The important aspects of this code are:
<ul class="star">
<li>The form posts to the same URL as the regular form, <code>j_spring_security_check</code>. In fact, the form is identical, including the remember-me checkbox, except that the submit button is replaced with a hyperlink.</li>
<li>Error messages are displayed within the popup &#60;div&#62;.</li>
<li>Because there is no page redirect after successful login, the Javascript replaces the login link to give a visual indication that the user is logged in.</li>
<li>Details of logout are not shown; you do this by redirecting the user to <code>/j_spring_security_logout</code>.</li>
</ul><p class="paragraph"/><h4>How Does Ajax login Work?</h4><p class="paragraph"/>Most Ajax libraries (Prototype, JQuery, and Dojo as of v2.1) include an <code>X-Requested-With</code> header that indicates that the request was made by <code>XMLHttpRequest</code> instead of being triggered by clicking a regular hyperlink or form submit button. The plugin uses this header to detect Ajax login requests, and uses subclasses of some of Spring Security's classes to use different redirect urls for Ajax requests than regular requests. Instead of showing full pages, <code>LoginController</code> has JSON-generating methods <code>ajaxSuccess()</code>, <code>ajaxDenied()</code>, and <code>authfail()</code> that generate JSON that the login Javascript code can use to appropriately display success or error messages.<p class="paragraph"/>You can see the Ajax-aware actions in <code>LoginController</code>, specifically <code>ajaxSuccess</code> and <code>ajaxDenied</code>, which send JSON responses that can be used by client JavaScript code. Also <code>authfail</code> will check whether the authentication request used Ajax and will render a JSON error response if it did.<p class="paragraph"/>To summarize, the typical flow would be
<ul class="star">
<li>click the link to display the login form</li>
<li>enter authentication details and click login</li>
<li>the form is submitted using an Ajax request</li>
<li>if the authentication succeeds:</li>
<ul class="star">
<li>a redirect to <code>/login/ajaxSuccess</code> occurs (this URL is configurable)</li>
<li>the rendered response is JSON and it contains two values, a boolean value <code>success</code> with the value <code>true</code> and a string value <code>username</code> with the authenticated user's login name</li>
<li>the client determines that the login was successful and updates the page to indicate the the user is logged in; this is necessary since there's no page redirect like there would be for a non-Ajax login</li>
</ul>
<li>if the authentication fails:</li>
<ul class="star">
<li>a redirect to <code>/login/authfail?ajax=true</code> occurs (this URL is configurable)</li>
<li>the rendered response is JSON and it contains one value, a string value <code>error</code> with the displayable error message; this will be different depending on why the login was unsuccessful (bad username or password, account locked, etc.)</li>
<li>the client determines that the login was not successful and displays the error message</li>
</ul>
<li>note that both a successful and an unsuccessful login will trigger the <code>onSuccess</code> Ajax callback; the <code>onError</code> callback will only be triggered if there's an exception or network issue</li>
</ul><p class="paragraph"/><h4>Triggering an Ajax login</h4><p class="paragraph"/>So far we've discussed explicit Ajax logins where the user can view some of the site's pages but you've added a link to an in-page login form. An attempt to load a secure page will trigger a redirect to the standard login page. But if you're using Ajax in your pages you should handle the case where the request is secure and requires being logged in. This will also handle session timeouts where the user doesn't have a remember-me cookie; you can pop up a login dialog in the page.<p class="paragraph"/>For example consider this Ajax form:<p class="paragraph"/><div class="code"><pre>&#60;g:form action=<span class="java&#45;quote">"ajaxAdd"</span>&#62;
   &#60;g:textArea id='postContent' name=<span class="java&#45;quote">"content"</span>
               rows=<span class="java&#45;quote">"3"</span> cols=<span class="java&#45;quote">"50"</span> onkeydown=<span class="java&#45;quote">"updateCounter()"</span> /&#62;
   &#60;br/&#62;
   &#60;g:submitToRemote value=<span class="java&#45;quote">"Post"</span>
      url=<span class="java&#45;quote">"&#91;controller: 'post', action: 'addPostAjax'&#93;"</span>
      update=<span class="java&#45;quote">"&#91;success: 'firstPost'&#93;"</span>
      onSuccess=<span class="java&#45;quote">"clearPost(e)"</span>
      onLoading=<span class="java&#45;quote">"showSpinner(<span class="java&#45;keyword">true</span>)"</span>
      onComplete=<span class="java&#45;quote">"showSpinner(<span class="java&#45;keyword">false</span>)"</span>
      on401=<span class="java&#45;quote">"showLogin();"</span>/&#62;
      &#60;img id=<span class="java&#45;quote">"spinner"</span> style=<span class="java&#45;quote">"display: none"</span>
           src=<span class="java&#45;quote">"&#60;g:createLinkTo dir='/images' file='spinner.gif'/&#62;"</span>
   /&#62;
&#60;/g:form&#62;</pre></div><p class="paragraph"/>Most of the attributes are typical, but the <code>on401</code> attribute is the key to making Ajax logins work. As long as the <code>LoginController</code> sends a 401 error code the need to authenticate can be easily handled.<p class="paragraph"/>Note that depending on the version of the plugin that you're using, you may need to add the <code>authAjax</code> method to your <code>LoginController</code>:<p class="paragraph"/><div class="code"><pre>def authAjax = &#123;
   response.setHeader 'Location', SpringSecurityUtils.securityConfig.auth.ajaxLoginFormUrl
   response.sendError HttpServletResponse.SC_UNAUTHORIZED
&#125;</pre></div><p class="paragraph"/>and this requires an import for <code>javax.servlet.http.HttpServletResponse</code>.
<h1><a name="10 Authentication Providers">10 Authentication Providers</a></h1>The plugin registers authentication providers that perform authentication by implementing the <a href="http://static.springsource.org/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/authentication/AuthenticationProvider.html" target="blank">AuthenticationProvider</a> interface.<p class="paragraph"/><table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th><strong class="bold">Property</strong></th><th><strong class="bold">Default Value</strong></th><th><strong class="bold">Meaning</strong></th></tr><tr class="table-odd"><td>providerNames</td><td>&#91;'daoAuthenticationProvider', 'anonymousAuthenticationProvider', 'rememberMeAuthenticationProvider'&#93;</td><td>Bean names of authentication providers.</td></tr></table><p class="paragraph"/>Use <code>daoAuthenticationProvider</code> to authenticate using the User and Role database tables, <code>rememberMeAuthenticationProvider</code> to log in with a rememberMe cookie, and <code>anonymousAuthenticationProvider</code> to create an 'anonymous' authentication if no other provider authenticates.<p class="paragraph"/>To customize this list, you define a <code>providerNames</code> attribute with a list of bean names. The beans must be declared either by the plugin, or yourself in <code>resources.groovy</code> or <code>resources.xml</code>. Suppose you have a custom <code>MyAuthenticationProvider</code> in <code>resources.groovy</code>:<p class="paragraph"/><div class="code"><pre>beans = &#123;
   myAuthenticationProvider(com.foo.MyAuthenticationProvider) &#123;
      // attributes
   &#125;
&#125;</pre></div><p class="paragraph"/>You register the provider in <code>grails-app/conf/Config.groovy</code> as:<p class="paragraph"/><div class="code"><pre>grails.plugins.springsecurity.providerNames = &#91;
   'myAuthenticationProvider',
   'anonymousAuthenticationProvider',
   'rememberMeAuthenticationProvider'&#93;</pre></div>
<h1><a name="11 Custom UserDetailsService">11 Custom UserDetailsService</a></h1>When you authenticate users from a database using <a href="http://static.springsource.org/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/authentication/dao/DaoAuthenticationProvider.html" target="blank">DaoAuthenticationProvider</a> (the default mode in the plugin if you have not enabled OpenID, LDAP, and so on), an implementation of <a href="http://static.springsource.org/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/core/userdetails/UserDetailsService.html" target="blank">UserDetailsService</a> is required. This class is responsible for returning a concrete implementation of <a href="http://static.springsource.org/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/core/userdetails/UserDetails.html" target="blank">UserDetails</a>. The plugin provides <code>org.codehaus.groovy.grails.plugins.springsecurity.GormUserDetailsService</code> as its <code>UserDetailsService</code> implementation and <code>org.codehaus.groovy.grails.plugins.springsecurity.GrailsUser</code> (which extends Spring Security's <a href="http://static.springsource.org/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/core/userdetails/User.html" target="blank">User</a>) as its <code>UserDetails</code> implementation.<p class="paragraph"/>You can extend or replace <code>GormUserDetailsService</code> with your own implementation by defining a bean in <code>grails-app/conf/spring/resources.groovy</code> (or <code>resources.xml</code>) with the same bean name, <code>userDetailsService</code>. This works because application beans are configured after plugin beans and there can only be one bean for each name. The plugin uses an extension of <code>UserDetailsService</code>, <code>org.codehaus.groovy.grails.plugins.springsecurity.GrailsUserDetailsService</code>, which adds the method <code>UserDetails loadUserByUsername(String username, boolean loadRoles)</code> to support use cases like in LDAP where you often infer all roles from LDAP but might keep application-specific user details in the database.<p class="paragraph"/>In the following example, the <code>UserDetails</code> and <code>GrailsUserDetailsService</code> implementation adds the full name of the user domain class in addition to the standard information. If you extract extra data from your domain class, you are less likely to need to reload the user from the database. Most of your common data can be kept along with your security credentials.<p class="paragraph"/>This example adds in a <code>fullName</code> field. Keeping the full name cached avoids hitting the database just for that lookup. <code>GrailsUser</code> already adds the <code>id</code> value from the domain class to so we can do a more efficient database load of the user. If all you have is the username, then you need to call <code>User.findByUsername(principal.username)</code>, but if you have the id you can call <code>User.get(principal.id)</code>. Even if you have a unique index on the <code>username</code> database column, loading by primary key is usually more efficient because it takes advantage of Hibernate's first-level and second-level caches.<p class="paragraph"/>There is not much to implement other than your application-specific lookup code:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> com.mycompany.myapp<p class="paragraph"/><span class="java&#45;keyword">import</span> org.codehaus.groovy.grails.plugins.springsecurity.GrailsUser<p class="paragraph"/><span class="java&#45;keyword">import</span> org.springframework.security.core.GrantedAuthority
<span class="java&#45;keyword">import</span> org.springframework.security.core.userdetails.User<p class="paragraph"/>class MyUserDetails <span class="java&#45;keyword">extends</span> GrailsUser &#123;<p class="paragraph"/>   <span class="java&#45;keyword">final</span> <span class="java&#45;object">String</span> fullName<p class="paragraph"/>   MyUserDetails(<span class="java&#45;object">String</span> username, <span class="java&#45;object">String</span> password, <span class="java&#45;object">boolean</span> enabled,
                 <span class="java&#45;object">boolean</span> accountNonExpired, <span class="java&#45;object">boolean</span> credentialsNonExpired,
                 <span class="java&#45;object">boolean</span> accountNonLocked,
                 Collection&#60;GrantedAuthority&#62; authorities,
                 <span class="java&#45;object">long</span> id, <span class="java&#45;object">String</span> fullName) &#123;
      <span class="java&#45;keyword">super</span>(username, password, enabled, accountNonExpired,
            credentialsNonExpired, accountNonLocked, authorities, id)<p class="paragraph"/>      <span class="java&#45;keyword">this</span>.fullName = fullName
   &#125;
&#125;</pre></div><p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> com.mycompany.myapp<p class="paragraph"/><span class="java&#45;keyword">import</span> org.codehaus.groovy.grails.plugins.springsecurity.GrailsUser
<span class="java&#45;keyword">import</span> org.codehaus.groovy.grails.plugins.springsecurity.GrailsUserDetailsService
<span class="java&#45;keyword">import</span> org.codehaus.groovy.grails.plugins.springsecurity.SpringSecurityUtils
<span class="java&#45;keyword">import</span> org.springframework.security.core.authority.GrantedAuthorityImpl
<span class="java&#45;keyword">import</span> org.springframework.security.core.userdetails.UserDetails
<span class="java&#45;keyword">import</span> org.springframework.security.core.userdetails.UsernameNotFoundException<p class="paragraph"/>class MyUserDetailsService <span class="java&#45;keyword">implements</span> GrailsUserDetailsService &#123;<p class="paragraph"/>   /&#42;&#42;
    &#42; Some Spring Security classes (e.g. RoleHierarchyVoter) expect at least one role, so
    &#42; we give a user with no granted roles <span class="java&#45;keyword">this</span> one which gets past that restriction but
    &#42; doesn't grant anything.
    &#42;/
   <span class="java&#45;keyword">static</span> <span class="java&#45;keyword">final</span> List NO_ROLES = &#91;<span class="java&#45;keyword">new</span> GrantedAuthorityImpl(SpringSecurityUtils.NO_ROLE)&#93;<p class="paragraph"/>   UserDetails loadUserByUsername(<span class="java&#45;object">String</span> username, <span class="java&#45;object">boolean</span> loadRoles)
            <span class="java&#45;keyword">throws</span> UsernameNotFoundException &#123;
      <span class="java&#45;keyword">return</span> loadUserByUsername(username)
   &#125;<p class="paragraph"/>   UserDetails loadUserByUsername(<span class="java&#45;object">String</span> username) <span class="java&#45;keyword">throws</span> UsernameNotFoundException &#123;<p class="paragraph"/>      User.withTransaction &#123; status &#45;&#62;<p class="paragraph"/>         User user = User.findByUsername(username)
         <span class="java&#45;keyword">if</span> (!user) <span class="java&#45;keyword">throw</span> <span class="java&#45;keyword">new</span> UsernameNotFoundException('User not found', username)<p class="paragraph"/>         def authorities = user.authorities.collect &#123;<span class="java&#45;keyword">new</span> GrantedAuthorityImpl(it.authority)&#125;<p class="paragraph"/>         <span class="java&#45;keyword">return</span> <span class="java&#45;keyword">new</span> MyUserDetails(user.username, user.password, user.enabled,
            !user.accountExpired, !user.passwordExpired,
            !user.accountLocked, authorities ?: NO_ROLES, user.id,
            user.firstName + <span class="java&#45;quote">" "</span> + user.lastName)
      &#125;
   &#125;
&#125;</pre></div><p class="paragraph"/>The lookup code is wrapped in a <code>withTransaction</code> block to avoid lazy loading exceptions when accessing the <code>authorities</code> collection. There are obviously no database updates here but this is a convenient way to keep the Hibernate <code>Session</code> open to enable accessing the roles.<p class="paragraph"/>To use your implementation, register it in <code>grails-app/conf/spring/resources.groovy</code> like this:<p class="paragraph"/><div class="code"><pre>beans = &#123;
   userDetailsService(com.mycompany.myapp.MyUserDetailsService)
&#125;</pre></div><p class="paragraph"/>Another option for loading users and roles from the database is to subclass <code>org.codehaus.groovy.grails.plugins.springsecurity.GormUserDetailsService</code> - the methods are all protected so you can override as needed.<p class="paragraph"/>This approach works with all beans defined in <code>SpringSecurityCoreGrailsPlugin.doWithSpring()</code> - you can replace or subclass any of the Spring beans to provide your own functionality when the standard extension mechanisms are insufficient.<p class="paragraph"/><h4>Flushing the Cached Authentication</h4>
If you store mutable data in your custom <code>UserDetails</code> implementation (such as full name in the preceding example), be sure to rebuild the <code>Authentication</code> if it changes. <code>springSecurityService</code> has a <code>reauthenticate</code> method that does this for you:<p class="paragraph"/><div class="code"><pre>class MyController &#123;<p class="paragraph"/>   def springSecurityService<p class="paragraph"/>   def someAction &#123;
      def user = &#8230;
      // update user data
      user.save()
      springSecurityService.reauthenticate user.username
      &#8230;
   &#125;
&#125;</pre></div>
<h1><a name="12 Password and Account Protection">12 Password and Account Protection</a></h1>The sections that follow discuss approaches to protecting passwords and user accounts.
<h2><a name="12.1 Password Encryption">12.1 Password Encryption</a></h2>By default the plugin uses the SHA-256 message digest algorithm to encrypt passwords. You can customize this with the <code>grails.plugins.springsecurity.password.algorithm</code> attribute as described below. In addition you can increase the security of your passwords by adding a salt, which can be a field of the <code>UserDetails</code> instance, a global static value, or any custom value you want.<p class="paragraph"/><a href="http://secure.wikimedia.org/wikipedia/en/wiki/Bcrypt" target="blank">BCrypt</a> is a much more secure alternative to the message digest approaches since it supports a customizable work level which when increased takes more computation time to hash the users' passwords, but also dramatically increases the cost of brute force attacks. Given how easy it is to <a href="http://www.google.com/search?q=gpu+password+cracking" target="blank">use GPUs to crack passwords</a>, you should definitely consider using BCrypt for new projects and switching to it for existing projects. Note that due to the approach used by BCrypt, you cannot add an additional salt like you can with the message digest algorithms.<p class="paragraph"/>Enable BCrypt by using the <code>'bcrypt'</code> value for the <code>algorithm</code> config attribute:<p class="paragraph"/><div class="code"><pre>grails.plugins.springsecurity.password.algorithm = 'bcrypt'</pre></div><p class="paragraph"/>and optionally changing the number of rekeying rounds (which will affect the time it takes to encrypt passwords), e.g.<p class="paragraph"/><div class="code"><pre>grails.plugins.springsecurity.password.bcrypt.logrounds = 15</pre></div><p class="paragraph"/>The table shows configurable password encryption attributes.<p class="paragraph"/><table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th><strong class="bold">Property</strong></th><th><strong class="bold">Default</strong></th><th><strong class="bold">Description</strong></th></tr><tr class="table-odd"><td>password.algorithm</td><td>'SHA-256'</td><td>passwordEncoder Message Digest algorithm. See <a href="http://java.sun.com/j2se/1.5.0/docs/guide/security/CryptoSpec.html#AppA" target="blank">this page</a> for options, or use the value 'bcrypt' to use BCrypt instead.</td></tr><tr class="table-even"><td>password.encodeHashAsBase64</td><td><code>false</code></td><td>If <code>true</code>, Base64-encode the hashed password.</td></tr><tr class="table-odd"><td>password.bcrypt.logrounds</td><td>10</td><td>the number of rekeying rounds to use when using BCrypt</td></tr></table>
<h2><a name="12.2 Salted Passwords">12.2 Salted Passwords</a></h2>The Spring Security plugin uses encrypted passwords and a digest algorithm that you specify. For enhanced protection against dictionary attacks, you should use a salt in addition to digest encryption.<p class="paragraph"/>There are two approaches to using salted passwords in the plugin - defining a field in the <code>UserDetails</code> class to access by reflection, or by directly implementing <a href="http://static.springsource.org/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/authentication/dao/SaltSource.html" target="blank">SaltSource</a> yourself.<p class="paragraph"/><h4>dao.reflectionSaltSourceProperty</h4>
Set the <code>dao.reflectionSaltSourceProperty</code> configuration property:<p class="paragraph"/><div class="code"><pre>grails.plugins.springsecurity.dao.reflectionSaltSourceProperty = 'username'</pre></div><p class="paragraph"/>This property belongs to the <code>UserDetails</code> class. By default it is an instance of <code>org.codehaus.groovy.grails.plugins.springsecurity.GrailsUser</code>, which extends the standard Spring Security <a href="http://static.springsource.org/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/core/userdetails/User.html" target="blank">User class</a> and not your 'person' domain class. This limits the available fields unless you use a <a href="../guide/single.html#11 Custom UserDetailsService" class="guide">custom <code>UserDetailsService</code></a>.<p class="paragraph"/>As long as the username does not change, this approach works well for the salt. If you choose a property that the user can change, the user cannot log in again after changing it unless you re-encrypt the password with the new value. So it's best to use a property that doesn't change.<p class="paragraph"/>Another option is to generate a random salt when creating users and store this in the database by adding a new field to the 'person' class. This approach requires a custom <code>UserDetailsService</code> because you need a custom <code>UserDetails</code> implementation that also has a 'salt' property, but this is more flexible and works in cases where users can change their username.<p class="paragraph"/><h4>SystemWideSaltSource and Custom SaltSource</h4><p class="paragraph"/>Spring Security supplies a simple <code>SaltSource</code> implementation, <a href="http://static.springsource.org/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/authentication/dao/SystemWideSaltSource.html" target="blank">SystemWideSaltSource</a>, which uses the same salt for each user. It's less robust than using a different value for each user but still better than no salt at all.<p class="paragraph"/>An example override of the salt source bean using SystemWideSaltSource would look like this:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> org.springframework.security.authentication.dao.SystemWideSaltSource
beans = &#123;
   saltSource(SystemWideSaltSource) &#123;
      systemWideSalt = 'the_salt_value'
   &#125;
&#125;</pre></div><p class="paragraph"/>To have full control over the process, you can implement the <code>SaltSource</code> interface and replace the plugin's implementation with your own by defining a bean in <code>grails-app/conf/spring/resources.groovy</code> with the name <code>saltSource</code>:<p class="paragraph"/><div class="code"><pre>beans = &#123;
   saltSource(com.foo.bar.MySaltSource) &#123;
      // set properties
   &#125;
&#125;</pre></div><p class="paragraph"/><h4>Encrypting Passwords</h4>
Regardless of the implementation, you need to be aware of what value to use for a salt when creating or updating users, for example, in a <code>UserController</code>'s <code>save</code> or <code>update</code> action. When encrypting the password, you use the two-parameter version of <code>springSecurityService.encodePassword()</code>:<p class="paragraph"/><div class="code"><pre>class UserController &#123;<p class="paragraph"/>   def springSecurityService<p class="paragraph"/>   def save = &#123;
      def userInstance = <span class="java&#45;keyword">new</span> User(params)
      userInstance.password = springSecurityService.encodePassword(
                    params.password, userInstance.username)
      <span class="java&#45;keyword">if</span> (!userInstance.save(flush: <span class="java&#45;keyword">true</span>)) &#123;
         render view: 'create', model: &#91;userInstance: userInstance&#93;
         <span class="java&#45;keyword">return</span>
      &#125;<p class="paragraph"/>      flash.message = <span class="java&#45;quote">"The user was created"</span>
      redirect action: show, id: userInstance.id
   &#125;<p class="paragraph"/>   def update = &#123;
      def userInstance = User.get(params.id)<p class="paragraph"/>      <span class="java&#45;keyword">if</span> (params.password) &#123;
         params.password = springSecurityService.encodePassword(
                    params.password, userInstance.username)
      &#125;
      userInstance.properties = params
      <span class="java&#45;keyword">if</span> (!userInstance.save(flush: <span class="java&#45;keyword">true</span>)) &#123;
         render view: 'edit', model: &#91;userInstance: userInstance&#93;
         <span class="java&#45;keyword">return</span>
      &#125;<p class="paragraph"/>      <span class="java&#45;keyword">if</span> (springSecurityService.loggedIn &#38;&#38;
               springSecurityService.principal.username == userInstance.username) &#123;
         springSecurityService.reauthenticate userInstance.username
      &#125;<p class="paragraph"/>      flash.message = <span class="java&#45;quote">"The user was updated"</span>
      redirect action: show, id: userInstance.id
   &#125;
&#125;</pre></div><p class="paragraph"/><blockquote class="note">
If you are encoding the password in the User domain class (using <code>beforeInsert</code> and <code>encodePassword</code>) then don't call <code>springSecurityService.encodePassword()</code> in your controller since you'll double-encrypt the password and users won't be able to log in. It's best to encapsulate the password handling logic in the domain class.
</blockquote>
<h2><a name="12.3 Account Locking and Forcing Password Change">12.3 Account Locking and Forcing Password Change</a></h2>Spring Security supports four ways of disabling a user account. When you attempt to log in, the <code>UserDetailsService</code> implementation creates an instance of <code>UserDetails</code> that uses these accessor methods:
<ul class="star">
<li><code>isAccountNonExpired()</code></li>
<li><code>isAccountNonLocked()</code></li>
<li><code>isCredentialsNonExpired()</code></li>
<li><code>isEnabled()</code></li>
</ul><p class="paragraph"/>If you use the <a href="../ref/Scripts/s2-quickstart.html" class="Scripts">s2-quickstart</a> script to create a user domain class, it creates a class with corresponding properties to manage this state.<p class="paragraph"/>When an accessor returns <code>true</code> for <code>accountExpired</code>, <code>accountLocked</code>, or <code>passwordExpired</code> or returns <code>false</code> for <code>enabled</code>, a corresponding exception is thrown:<p class="paragraph"/><table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th><strong class="bold">Accessor</strong></th><th><strong class="bold">Property</strong></th><th><strong class="bold">Exception</strong></th></tr><tr class="table-odd"><td><code>isAccountNonExpired()</code></td><td><code>accountExpired</code></td><td><a href="http://static.springsource.org/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/authentication/AccountExpiredException.html" target="blank">AccountExpiredException</a></td></tr><tr class="table-even"><td><code>isAccountNonLocked()</code></td><td><code>accountLocked</code></td><td><a href="http://static.springsource.org/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/authentication/LockedException.html" target="blank">LockedException</a></td></tr><tr class="table-odd"><td><code>isCredentialsNonExpired()</code></td><td><code>passwordExpired</code></td><td><a href="http://static.springsource.org/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/authentication/CredentialsExpiredException.html" target="blank">CredentialsExpiredException</a></td></tr><tr class="table-even"><td><code>isEnabled()</code></td><td><code>enabled</code></td><td><a href="http://static.springsource.org/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/authentication/DisabledException.html" target="blank">DisabledException</a></td></tr></table><p class="paragraph"/>You can configure an exception mapping in <code>Config.groovy</code> to associate a URL to any or all of these exceptions to determine where to redirect after a failure, for example:<p class="paragraph"/><div class="code"><pre>grails.plugins.springsecurity.failureHandler.exceptionMappings = &#91;
   'org.springframework.security.authentication.LockedException':             '/user/accountLocked',
   'org.springframework.security.authentication.DisabledException':           '/user/accountDisabled',
   'org.springframework.security.authentication.AccountExpiredException':     '/user/accountExpired',
   'org.springframework.security.authentication.CredentialsExpiredException': '/user/passwordExpired'
&#93;</pre></div><p class="paragraph"/>Without a mapping for a particular exception, the user is redirected to the standard login fail page (by default <code>/login/authfail</code>), which displays an error message from this table:<p class="paragraph"/><table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th><strong class="bold">Property</strong></th><th><strong class="bold">Default</strong></th></tr><tr class="table-odd"><td>errors.login.disabled</td><td>"Sorry, your account is disabled."</td></tr><tr class="table-even"><td>errors.login.expired</td><td>"Sorry, your account has expired."</td></tr><tr class="table-odd"><td>errors.login.passwordExpired</td><td>"Sorry, your password has expired."</td></tr><tr class="table-even"><td>errors.login.locked</td><td>"Sorry, your account is locked."</td></tr><tr class="table-odd"><td>errors.login.fail</td><td>"Sorry, we were not able to find a user with that username and password."</td></tr></table><p class="paragraph"/>You can customize these messages by setting the corresponding property in <code>Config.groovy</code>, for example:<p class="paragraph"/><div class="code"><pre>grails.plugins.springsecurity.errors.login.locked = <span class="java&#45;quote">"None shall pass."</span></pre></div><p class="paragraph"/>You can use this functionality to manually lock a user's account or expire the password, but you can automate the process. For example, use the <a href="http://grails.org/plugin/quartz" target="blank">Quartz plugin</a> to periodically expire everyone's password and force them to go to a page where they update it. Keep track of the date when users change their passwords and use a Quartz job to expire their passwords once the password is older than a fixed max age.<p class="paragraph"/>Here's an example for a password expired workflow. You'd need a simple action to display a password reset form (similar to the login form):<p class="paragraph"/><div class="code"><pre>def passwordExpired = &#123;
   &#91;username: session&#91;'SPRING_SECURITY_LAST_USERNAME'&#93;&#93;
&#125;</pre></div><p class="paragraph"/>and the form would look something like this:<p class="paragraph"/><div class="code"><pre>&#60;div id='login'&#62;
   &#60;div class='<span class="java&#45;keyword">inner</span>'&#62;
      &#60;g:<span class="java&#45;keyword">if</span> test='$&#123;flash.message&#125;'&#62;
      &#60;div class='login_message'&#62;$&#123;flash.message&#125;&#60;/div&#62;
      &#60;/g:<span class="java&#45;keyword">if</span>&#62;
      &#60;div class='fheader'&#62;Please update your password..&#60;/div&#62;
      &#60;g:form action='updatePassword' id='passwordResetForm' class='cssform' autocomplete='off'&#62;
         &#60;p&#62;
            &#60;label <span class="java&#45;keyword">for</span>='username'&#62;Username&#60;/label&#62;
            &#60;span class='text_'&#62;$&#123;username&#125;&#60;/span&#62;
         &#60;/p&#62;
         &#60;p&#62;
            &#60;label <span class="java&#45;keyword">for</span>='password'&#62;Current Password&#60;/label&#62;
            &#60;g:passwordField name='password' class='text_' /&#62;
         &#60;/p&#62;
         &#60;p&#62;
            &#60;label <span class="java&#45;keyword">for</span>='password'&#62;New Password&#60;/label&#62;
            &#60;g:passwordField name='password_new' class='text_' /&#62;
         &#60;/p&#62;
         &#60;p&#62;
            &#60;label <span class="java&#45;keyword">for</span>='password'&#62;New Password (again)&#60;/label&#62;
            &#60;g:passwordField name='password_new_2' class='text_' /&#62;
         &#60;/p&#62;
         &#60;p&#62;
            &#60;input type='submit' value='Reset' /&#62;
         &#60;/p&#62;
      &#60;/g:form&#62;
   &#60;/div&#62;
&#60;/div&#62;</pre></div><p class="paragraph"/>It's important that you not allow the user to specify the username (it's available in the HTTP session) but that you require the current password, otherwise it would be simple to forge a password reset.<p class="paragraph"/>The GSP form would submit to an action like this one:<p class="paragraph"/><div class="code"><pre>def updatePassword = &#123;
   <span class="java&#45;object">String</span> username = session&#91;'SPRING_SECURITY_LAST_USERNAME'&#93;
   <span class="java&#45;keyword">if</span> (!username) &#123;
      flash.message = 'Sorry, an error has occurred'
      redirect controller: 'login', action: 'auth'
      <span class="java&#45;keyword">return</span>
   &#125;<p class="paragraph"/>   <span class="java&#45;object">String</span> password = params.password
   <span class="java&#45;object">String</span> newPassword = params.password_new
   <span class="java&#45;object">String</span> newPassword2 = params.password_new_2
   <span class="java&#45;keyword">if</span> (!password || !newPassword || !newPassword2 || newPassword != newPassword2) &#123;
      flash.message = 'Please enter your current password and a valid <span class="java&#45;keyword">new</span> password'
      render view: 'passwordExpired', model: &#91;username: session&#91;'SPRING_SECURITY_LAST_USERNAME'&#93;&#93;
      <span class="java&#45;keyword">return</span>
   &#125;<p class="paragraph"/>   User user = User.findByUsername(username)
   <span class="java&#45;keyword">if</span> (!passwordEncoder.isPasswordValid(user.password, password, <span class="java&#45;keyword">null</span> /&#42;salt&#42;/)) &#123;
      flash.message = 'Current password is incorrect'
      render view: 'passwordExpired', model: &#91;username: session&#91;'SPRING_SECURITY_LAST_USERNAME'&#93;&#93;
      <span class="java&#45;keyword">return</span>
   &#125;<p class="paragraph"/>   <span class="java&#45;keyword">if</span> (passwordEncoder.isPasswordValid(user.password, newPassword, <span class="java&#45;keyword">null</span> /&#42;salt&#42;/)) &#123;
      flash.message = 'Please choose a different password from your current one'
      render view: 'passwordExpired', model: &#91;username: session&#91;'SPRING_SECURITY_LAST_USERNAME'&#93;&#93;
      <span class="java&#45;keyword">return</span>
   &#125;<p class="paragraph"/>   user.password = newPassword
   user.passwordExpired = <span class="java&#45;keyword">false</span>
   user.save() // <span class="java&#45;keyword">if</span> you have password constraints check them here<p class="paragraph"/>   redirect controller: 'login', action: 'auth'
&#125;</pre></div><p class="paragraph"/><h4>User Cache</h4>
If the <code>cacheUsers</code> configuration property is set to <code>true</code>, Spring Security caches <code>UserDetails</code> instances to save trips to the database. (The default is <code>false</code>.) This optimization is minor, because typically only two small queries occur during login -- one to load the user, and one to load the authorities.<p class="paragraph"/>If you enable this feature, you must remove any cached instances after making a change that affects login. If you do not remove cached instances, even though a user's account is locked or disabled, logins succeed because the database is bypassed. By removing the cached data, you force at trip to the database to retrieve the latest updates.<p class="paragraph"/>Here is a sample Quartz job that demonstrates how to find and disable users with passwords that are too old:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> com.mycompany.myapp<p class="paragraph"/>class ExpirePasswordsJob  &#123;<p class="paragraph"/>   <span class="java&#45;keyword">static</span> triggers = &#123;
      cron name: 'myTrigger', cronExpression: '0 0 0 &#42; &#42; ?' // midnight daily
   &#125;<p class="paragraph"/>   def userCache<p class="paragraph"/>   void execute() &#123;<p class="paragraph"/>      def users = User.executeQuery(
            'from User u where u.passwordChangeDate &#60;= :cutoffDate',
            &#91;cutoffDate: <span class="java&#45;keyword">new</span> Date() &#45; 180&#93;)<p class="paragraph"/>      <span class="java&#45;keyword">for</span> (user in users) &#123;
         // flush each separately so one failure doesn't rollback all of the others
         <span class="java&#45;keyword">try</span> &#123;
            user.passwordExpired = <span class="java&#45;keyword">true</span>
            user.save(flush: <span class="java&#45;keyword">true</span>)
            userCache.removeUserFromCache user.username
         &#125;
         <span class="java&#45;keyword">catch</span> (e) &#123;
            log.error <span class="java&#45;quote">"problem expiring password <span class="java&#45;keyword">for</span> user $user.username : $e.message"</span>, e
         &#125;
      &#125;
   &#125;
&#125;</pre></div>
<h1><a name="13 URL Properties">13 URL Properties</a></h1>The table shows configurable URL-related properties.<p class="paragraph"/><table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th><strong class="bold">Property</strong></th><th><strong class="bold">Default Value</strong></th><th><strong class="bold">Meaning</strong></th></tr><tr class="table-odd"><td>apf.filterProcessesUrl</td><td>'/j_spring_security_check'</td><td>Login form post URL, intercepted by Spring Security filter.</td></tr><tr class="table-even"><td>apf.usernameParameter</td><td>'j_username'</td><td>Login form username parameter.</td></tr><tr class="table-odd"><td>apf.passwordParameter</td><td>'j_password'</td><td>Login form password parameter.</td></tr><tr class="table-even"><td>apf.allowSessionCreation</td><td><code>true</code></td><td>Whether to allow authentication to create an HTTP session.</td></tr><tr class="table-odd"><td>apf.postOnly</td><td><code>true</code></td><td>Whether to allow only POST login requests.</td></tr><tr class="table-even"><td>failureHandler.defaultFailureUrl</td><td>'/login/authfail?login_error=1'</td><td>Redirect URL for failed logins.</td></tr><tr class="table-odd"><td>failureHandler.ajaxAuthFailUrl</td><td>'/login/authfail?ajax=true'</td><td>Redirect URL for failed Ajax logins.</td></tr><tr class="table-even"><td>failureHandler.exceptionMappings</td><td>none</td><td>Map of exception class name (subclass of <a href="http://static.springsource.org/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/core/AuthenticationException.html" target="blank">AuthenticationException</a>) to which the URL will redirect for that exception type after authentication failure.</td></tr><tr class="table-odd"><td>failureHandler.useForward</td><td><code>false</code></td><td>Whether to render the error page (<code>true</code>) or redirect (<code>false</code>).</td></tr><tr class="table-even"><td>successHandler.defaultTargetUrl</td><td>'/'</td><td>Default post-login URL if there is no saved request that triggered the login.</td></tr><tr class="table-odd"><td>successHandler.alwaysUseDefault</td><td><code>false</code></td><td>If <code>true</code>, always redirects to the value of <code>successHandler.defaultTargetUrl</code> after successful authentication; otherwise redirects to to originally-requested page.</td></tr><tr class="table-even"><td>successHandler.targetUrlParameter</td><td>'spring-security-redirect'</td><td>Name of optional login form parameter that specifies destination after successful login.</td></tr><tr class="table-odd"><td>successHandler.useReferer</td><td><code>false</code></td><td>Whether to use the HTTP <code>Referer</code> header to determine post-login destination.</td></tr><tr class="table-even"><td>successHandler.ajaxSuccessUrl</td><td>'/login/ajaxSuccess'</td><td>URL for redirect after successful Ajax login.</td></tr><tr class="table-odd"><td>auth.loginFormUrl</td><td>'/login/auth'</td><td>URL of login page.</td></tr><tr class="table-even"><td>auth.forceHttps</td><td><code>false</code></td><td>If <code>true</code>, redirects login page requests to HTTPS.</td></tr><tr class="table-odd"><td>auth.ajaxLoginFormUrl</td><td>'/login/authAjax'</td><td>URL of Ajax login page.</td></tr><tr class="table-even"><td>auth.useForward</td><td>false</td><td>Whether to render the login page (<code>true</code>) or redirect (<code>false</code>).</td></tr><tr class="table-odd"><td>logout.afterLogoutUrl</td><td>'/'</td><td>URL for redirect after logout.</td></tr><tr class="table-even"><td>logout.filterProcessesUrl</td><td>'/j_spring_security_logout'</td><td>Logout URL, intercepted by Spring Security filter.</td></tr><tr class="table-odd"><td>logout.handlerNames</td><td>&#91;'rememberMeServices', 'securityContextLogoutHandler'&#93;</td><td>Logout handler bean names. See <a href="../guide/single.html#20 Logout Handlers" class="guide">Logout Handlers</a></td></tr><tr class="table-even"><td>adh.errorPage</td><td>'/login/denied'</td><td>Location of the 403 error page.</td></tr><tr class="table-odd"><td>adh.ajaxErrorPage</td><td>'/login/ajaxDenied'</td><td>Location of the 403 error page for Ajax requests.</td></tr><tr class="table-even"><td>ajaxHeader</td><td>'X-Requested-With'</td><td>Header name sent by Ajax library, used to detect Ajax.</td></tr><tr class="table-odd"><td>redirectStrategy.contextRelative</td><td><code>false</code></td><td>If <code>true</code>, the redirect URL will be the value after the request context path. This results in the loss of protocol information (HTTP or HTTPS), so causes problems if a redirect is being performed to change from HTTP to HTTPS or vice versa.</td></tr><tr class="table-even"><td>switchUser URLs</td><td>&#160;</td><td>See <a href="../guide/single.html#15 Switch User" class="guide">Switch User</a>, under <strong class="bold">Customizing URLs</strong>.</td></tr></table>
<h1><a name="14 Hierarchical Roles">14 Hierarchical Roles</a></h1>Hierarchical roles are a convenient way to reduce clutter in your request mappings.<p class="paragraph"/><table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th><strong class="bold">Property</strong></th><th><strong class="bold">Default Value</strong></th><th><strong class="bold">Meaning</strong></th></tr><tr class="table-odd"><td>roleHierarchy</td><td>none</td><td>Hierarchical role definition.</td></tr></table><p class="paragraph"/>For example, if you have several types of 'admin' roles that can be used to access a URL pattern and you do not use hierarchical roles, you need to specify all the admin roles:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> com.mycompany.myapp<p class="paragraph"/><span class="java&#45;keyword">import</span> grails.plugins.springsecurity.Secured<p class="paragraph"/>class SomeController &#123;<p class="paragraph"/>   @Secured(&#91;'ROLE_ADMIN', 'ROLE_FINANCE_ADMIN', 'ROLE_SUPERADMIN'&#93;)
   def someAction = &#123;
      &#8230;
   &#125;
&#125;</pre></div><p class="paragraph"/>However, if you have a business rule that says <code>ROLE_FINANCE_ADMIN</code> implies being granted <code>ROLE_ADMIN</code>, and that <code>ROLE_SUPERADMIN</code> implies being granted <code>ROLE_FINANCE_ADMIN</code>, you can express that hierarchy as:<p class="paragraph"/><div class="code"><pre>grails.plugins.springsecurity.roleHierarchy = '''
   ROLE_SUPERADMIN &#62; ROLE_FINANCE_ADMIN
   ROLE_FINANCE_ADMIN &#62; ROLE_ADMIN
'''</pre></div><p class="paragraph"/>Then you can simplify your mappings by specifying only the roles that are required:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> com.mycompany.myapp<p class="paragraph"/><span class="java&#45;keyword">import</span> grails.plugins.springsecurity.Secured<p class="paragraph"/>class SomeController &#123;<p class="paragraph"/>   @Secured(&#91;'ROLE_ADMIN'&#93;)
   def someAction = &#123;
      &#8230;
   &#125;
&#125;</pre></div><p class="paragraph"/>You can also reduce the number of granted roles in the database. Where previously you had to grant <code>ROLE_SUPERADMIN</code>, <code>ROLE_FINANCE_ADMIN</code>, and <code>ROLE_ADMIN</code>, now you only need to grant <code>ROLE_SUPERADMIN</code>.
<h1><a name="15 Switch User">15 Switch User</a></h1>To enable a user to switch from the current <code>Authentication</code> to another user's, set the <code>useSwitchUserFilter</code> attribute to <code>true</code>. This feature is similar to the 'su' command in Unix. It enables, for example, an admin to act as a regular user to perform some actions, and then switch back.<p class="paragraph"/><blockquote class="warning">
This feature is very powerful; it allows full access to everything the switched-to user can access without requiring the user's password. Limit who can use this feature by guarding the user switch URL with a role, for example, <code>ROLE_SWITCH_USER</code>, <code>ROLE_ADMIN</code>, and so on.
</blockquote><p class="paragraph"/><h4>Switching to Another User</h4><p class="paragraph"/>To switch to another user, typically you create a form that submits to <code>/j_spring_security_switch_user</code>:<p class="paragraph"/><div class="code"><pre>&#60;sec:ifAllGranted roles='ROLE_SWITCH_USER'&#62;<p class="paragraph"/>   &#60;form action='/j_spring_security_switch_user' method='POST'&#62;
      Switch to user: &#60;input type='text' name='j_username'/&#62; &#60;br/&#62;
      &#60;input type='submit' value='Switch'/&#62;
   &#60;/form&#62;<p class="paragraph"/>&#60;/sec:ifAllGranted&#62;</pre></div><p class="paragraph"/>Here the form is guarded by a check that the logged-in user has <code>ROLE_SWITCH_USER</code> and is not shown otherwise. You also need to guard the user switch URL, and the approach depends on your mapping scheme. If you use annotations, add a rule to the <code>controllerAnnotations.staticRules</code> attribute:<p class="paragraph"/><div class="code"><pre>grails.plugins.springsecurity.controllerAnnotations.staticRules = &#91;
   &#8230;
   '/j_spring_security_switch_user': &#91;'ROLE_SWITCH_USER', 'IS_AUTHENTICATED_FULLY'&#93;
&#93;</pre></div><p class="paragraph"/>If you use <code>Requestmap</code>s, create a rule like this (for example, in <code>BootStrap</code>):<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">new</span> Requestmap(url: '/j_spring_security_switch_user',
               configAttribute: 'ROLE_SWITCH_USER,IS_AUTHENTICATED_FULLY').save(flush: <span class="java&#45;keyword">true</span>)</pre></div><p class="paragraph"/>If you use the <code>Config.groovy</code> map, add the rule there:<p class="paragraph"/><div class="code"><pre>grails.plugins.springsecurity.interceptUrlMap = &#91;
   &#8230;
   '/j_spring_security_switch_user': &#91;'ROLE_SWITCH_USER', 'IS_AUTHENTICATED_FULLY'&#93;
&#93;</pre></div><p class="paragraph"/><h4>Switching Back to Original User</h4>
To resume as the original user, navigate to <code>/j_spring_security_exit_user</code>.<p class="paragraph"/><div class="code"><pre>&#60;sec:ifSwitched&#62;
&#60;a href='$&#123;request.contextPath&#125;/j_spring_security_exit_user'&#62;
   Resume as &#60;sec:switchedUserOriginalUsername/&#62;
&#60;/a&#62;
&#60;/sec:ifSwitched&#62;</pre></div><p class="paragraph"/><h4>Customizing URLs</h4>
You can customize the URLs that are used for this feature, although it is rarely necessary:<p class="paragraph"/><div class="code"><pre>grails.plugins.springsecurity.switchUser.switchUserUrl = &#8230;
grails.plugins.springsecurity.switchUser.exitUserUrl = &#8230;
grails.plugins.springsecurity.switchUser.targetUrl = &#8230;
grails.plugins.springsecurity.switchUser.switchFailureUrl = ...</pre></div><p class="paragraph"/><table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th><strong class="bold">Property</strong></th><th><strong class="bold">Default</strong></th><th><strong class="bold">Meaning</strong></th></tr><tr class="table-odd"><td>useSwitchUserFilter</td><td><code>false</code></td><td>Whether to use the switch user filter.</td></tr><tr class="table-even"><td>switchUser.switchUserUrl</td><td>'/j_spring_security_switch_user'</td><td>URL to access (via GET or POST) to switch to another user.</td></tr><tr class="table-odd"><td>switchUser.exitUserUrl</td><td>'/j_spring_security_exit_user'</td><td>URL to access to switch to another user.</td></tr><tr class="table-even"><td>switchUser.targetUrl</td><td>Same as <code>successHandler.defaultTargetUrl</code></td><td>URL for redirect after switching.</td></tr><tr class="table-odd"><td>switchUser.switchFailureUrl</td><td>Same as <code>failureHandler.defaultFailureUrl</code></td><td>URL for redirect after an error during an attempt to switch.</td></tr></table><p class="paragraph"/><h4>GSP Code</h4><p class="paragraph"/>One approach to supporting the switch user feature is to add code to one or more of your GSP templates. In this example the current username is displayed, and if the user has switched from another (using the <code>sec:ifSwitched</code> tag) then a 'resume' link is displayed. If not, and the user has the required role, a form is displayed to allow input of the username to switch to:<p class="paragraph"/><div class="code"><pre>&#60;sec:ifLoggedIn&#62;
Logged in as &#60;sec:username/&#62;
&#60;/sec:ifLoggedIn&#62;<p class="paragraph"/>&#60;sec:ifSwitched&#62;
&#60;a href='$&#123;request.contextPath&#125;/j_spring_security_exit_user'&#62;
   Resume as &#60;sec:switchedUserOriginalUsername/&#62;
&#60;/a&#62;
&#60;/sec:ifSwitched&#62;<p class="paragraph"/>&#60;sec:ifNotSwitched&#62;
   &#60;sec:ifAllGranted roles='ROLE_SWITCH_USER'&#62;<p class="paragraph"/>   &#60;form action='$&#123;request.contextPath&#125;/j_spring_security_switch_user' method='POST'&#62;
      Switch to user: &#60;input type='text' name='j_username'/&#62;&#60;br/&#62;
      &#60;input type='submit' value='Switch'/&#62;
   &#60;/form&#62;<p class="paragraph"/>   &#60;/sec:ifAllGranted&#62;
&#60;/sec:ifNotSwitched&#62;</pre></div>
<h1><a name="16 Filters">16 Filters</a></h1>There are a few different approaches to configuring filter chain(s).<p class="paragraph"/><h4>Default Approach to Configuring Filter Chains</h4>
The default is to use configuration attributes to determine which extra filters to use (for example, Basic Auth, Switch User, etc.) and add these to the 'core' filters. For example, setting <code>grails.plugins.springsecurity.useSwitchUserFilter = true</code> adds <code>switchUserProcessingFilter</code> to the filter chain (and in the correct order). The filter chain built here is applied to all URLs. If you need more flexibility, you can use <code>filterChain.chainMap</code> as discussed in <strong class="bold">chainMap</strong> below.<p class="paragraph"/><h4>filterNames</h4>
To define custom filters, to remove a core filter from the chain (not recommended), or to otherwise have control over the filter chain, you can specify the <code>filterNames</code> property as a list of strings. As with the default approach, the filter chain built here is applied to all URLs.<p class="paragraph"/>For example:<p class="paragraph"/><div class="code"><pre>grails.plugins.springsecurity.filterChain.filterNames = &#91;
   'securityContextPersistenceFilter', 'logoutFilter', 'authenticationProcessingFilter',
   'myCustomProcessingFilter', 'rememberMeAuthenticationFilter', 'anonymousAuthenticationFilter',
   'exceptionTranslationFilter', 'filterInvocationInterceptor'
&#93;</pre></div><p class="paragraph"/>This example creates a filter chain corresponding to the Spring beans with the specified names.<p class="paragraph"/><h4>chainMap</h4>
Use the <code>filterChain.chainMap</code> attribute to define which filters are applied to different URL patterns. You define a Map that specifies one or more lists of filter bean names, each with a corresponding URL pattern.<p class="paragraph"/><div class="code"><pre>grails.plugins.springsecurity.filterChain.chainMap = &#91;
   '/urlpattern1/&#42;&#42;': 'filter1,filter2,filter3,filter4',
   '/urlpattern2/&#42;&#42;': 'filter1,filter3,filter5',
   '/&#42;&#42;': 'JOINED_FILTERS',
&#93;</pre></div><p class="paragraph"/>In this example, four filters are applied to URLs matching <code>/urlpattern1/&#42;&#42;</code> and three different filters are applied to URLs matching <code>/urlpattern2/&#42;&#42;</code>. In addition the special token <code>JOINED_FILTERS</code> is applied to all URLs. This is a conventient way to specify that all defined filters (configured either with configuration rules like <code>useSwitchUserFilter</code> or explicitly using <code>filterNames</code>) should apply to this pattern.<p class="paragraph"/>The order of the mappings is important. Each URL will be tested in order from top to bottom to find the first matching one. So you need a <code>/&#42;&#42;</code> catch-all rule at the end for URLs that do not match one of the earlier rules.<p class="paragraph"/>There's also a filter negation syntax that can be very convenient. Rather than specifying all of the filter names (and risking forgetting one or putting them in the wrong order), you can use the <code>JOINED_FILTERS</code> keyword and one or more filter names prefixed with a <code>-</code>. This means to use all configured filters except for the excluded ones. For example, if you had a web service that uses Basic Auth for <code>/webservice/&#42;&#42;</code> URLs, you would configure that using:<p class="paragraph"/><div class="code"><pre>grails.plugins.springsecurity.filterChain.chainMap = &#91;
   '/webservice/&#42;&#42;': 'JOINED_FILTERS,&#45;exceptionTranslationFilter',
   '/&#42;&#42;': 'JOINED_FILTERS,&#45;basicAuthenticationFilter,&#45;basicExceptionTranslationFilter'
&#93;</pre></div><p class="paragraph"/>For the <code>/webservice/&#42;&#42;</code> URLs, we want all filters except for the standard <code>ExceptionTranslationFilter</code> since we want to use just the one configured for Basic Auth. And for the <code>/&#42;&#42;</code> URLs (everything else) we want everything except for the Basic Auth filter and its configured <code>ExceptionTranslationFilter</code>.<p class="paragraph"/><h4>clientRegisterFilter</h4>
An alternative to setting the <code>filterNames</code> property is <code>org.codehaus.groovy.grails.plugins.springsecurity.SpringSecurityUtils.clientRegisterFilter()</code>. This property allows you to add a custom filter to the chain at a specified position. Each standard filter has a corresponding position in the chain (see <code>org.codehaus.groovy.grails.plugins.springsecurity.SecurityFilterPosition</code> for details). So if you have created an application-specific filter, register it in <code>grails-app/conf/spring/resources.groovy</code>:<p class="paragraph"/><div class="code"><pre>beans = &#123;
   myFilter(com.mycompany.myapp.MyFilter) &#123;
      // properties
   &#125;
&#125;</pre></div><p class="paragraph"/>and then register it in <code>grails-app/conf/BootStrap.groovy</code>:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> org.codehaus.groovy.grails.plugins.springsecurity.SecurityFilterPosition
<span class="java&#45;keyword">import</span> org.codehaus.groovy.grails.plugins.springsecurity.SpringSecurityUtils<p class="paragraph"/>class BootStrap &#123;<p class="paragraph"/>   def init = &#123; servletContext &#45;&#62;
      SpringSecurityUtils.clientRegisterFilter(
          'myFilter', SecurityFilterPosition.OPENID_FILTER.order + 10)
   &#125;
&#125;</pre></div><p class="paragraph"/>This bootstrap code registers your filter just after the Open ID filter (if it's configured). You cannot register a filter in the same position as another, so it's a good idea to add a small delta to its position to put it after or before a filter that it should be next to in the chain. The Open ID filter position is just an example - add your filter in the position that makes sense.
<h1><a name="17 Channel Security">17 Channel Security</a></h1>Use channel security to configure which URLs require HTTP and which require HTTPS.<p class="paragraph"/><table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th><strong class="bold">Property</strong></th><th><strong class="bold">Default Value</strong></th><th><strong class="bold">Meaning</strong></th></tr><tr class="table-odd"><td>portMapper.httpPort</td><td>8080</td><td>HTTP port your application uses.</td></tr><tr class="table-even"><td>portMapper.httpsPort</td><td>8443</td><td>HTTPS port your application uses.</td></tr><tr class="table-odd"><td>secureChannel.definition</td><td>none</td><td>Map of URL pattern to channel rule</td></tr></table><p class="paragraph"/>Build a Map under the <code>secureChannel.definition</code> key, where the keys are URL patterns, and the values are one of <code>REQUIRES_SECURE_CHANNEL</code>, <code>REQUIRES_INSECURE_CHANNEL</code>, or <code>ANY_CHANNEL</code>:<p class="paragraph"/><div class="code"><pre>grails.plugins.springsecurity.secureChannel.definition = &#91;
   '/login/&#42;&#42;':         'REQUIRES_SECURE_CHANNEL',
   '/maps/&#42;&#42;':          'REQUIRES_INSECURE_CHANNEL',
   '/images/login/&#42;&#42;':  'REQUIRES_SECURE_CHANNEL'
   '/images/&#42;&#42;':        'ANY_CHANNEL'
&#93;</pre></div><p class="paragraph"/>URLs are checked in order, so be sure to put more specific rules before less specific. In the preceding example, <code>/images/login/&#42;&#42;</code> is more specific than <code>/images/&#42;&#42;</code>, so it appears first in the configuration.
<h1><a name="18 IP Address Restrictions">18 IP Address Restrictions</a></h1>Ordinarily you can guard URLs sufficiently with roles, but the plugin provides an extra layer of security with its ability to restrict by IP address.<p class="paragraph"/><table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th><strong class="bold">Property</strong></th><th><strong class="bold">Default Value</strong></th><th><strong class="bold">Meaning</strong></th></tr><tr class="table-odd"><td>ipRestrictions</td><td>none</td><td>Map of URL patterns to IP address patterns.</td></tr></table><p class="paragraph"/>For example, make an admin-only part of your site accessible only from IP addresses of the local LAN or VPN, such as 192.168.1.xxx or 10.xxx.xxx.xxx. You can also set this up at your firewall and/or routers, but it is convenient to encapsulate it within your application.<p class="paragraph"/>To use this feature, specify an <code>ipRestrictions</code> configuration map, where the keys are URL patterns, and the values are IP address patterns that can access those URLs. The IP patterns can be single-value strings, or multi-value lists of strings. They can use <a href="http://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing" target="blank">CIDR</a> masks, and can specify either IPv4 or IPv6 patterns. For example, given this configuration:<p class="paragraph"/><div class="code"><pre>grails.plugins.springsecurity.ipRestrictions = &#91;
   '/pattern1/&#42;&#42;': '123.234.345.456',
   '/pattern2/&#42;&#42;': '10.0.0.0/8',
   '/pattern3/&#42;&#42;': &#91;'10.10.200.42', '10.10.200.63'&#93;
&#93;</pre></div><p class="paragraph"/><code>pattern1</code> URLs can be accessed only from the external address 123.234.345.456, <code>pattern2</code> URLs can be accessed only from a 10.xxx.xxx.xxx intranet address, and <code>pattern3</code> URLs can be accessed only from 10.10.200.42 or 10.10.200.63. All other URL patterns are accessible from any IP address.<p class="paragraph"/>All addresses can always be accessed from localhost regardless of IP pattern, primarily to support local development mode.<p class="paragraph"/><blockquote class="note">
You cannot compare IPv4 and IPv6 addresses, so if your server supports both, you need to specify the IP patterns using the address format that is actually being used. Otherwise the filter throws exceptions. One option is to set the <code>java.net.preferIPv4Stack</code> system property, for example, by adding it to <code>JAVA_OPTS</code> or <code>GRAILS_OPTS</code> as <code>-Djava.net.preferIPv4Stack=true</code>.
</blockquote>
<h1><a name="19 Session Fixation Prevention">19 Session Fixation Prevention</a></h1>To guard against <a href="http://en.wikipedia.org/wiki/Session_fixation" target="blank">session-fixation attacks</a> set the <code>useSessionFixationPrevention</code> attribute to <code>true</code>:<p class="paragraph"/><div class="code"><pre>grails.plugins.springsecurity.useSessionFixationPrevention = <span class="java&#45;keyword">true</span></pre></div><p class="paragraph"/>Upon successful authentication a new HTTP session is created and the previous session's attributes are copied into it. If you start your session by clicking a link that was generated by someone trying to hack your account, which contained an active session id, you are no longer sharing the previous session after login. You have your own session.<p class="paragraph"/>Session fixation is less of a problem now that Grails by default does not include jsessionid in URLs (see <a href="http://jira.codehaus.org/browse/GRAILS-3364" target="blank">this JIRA issue</a>), but it's still a good idea to use this feature.<p class="paragraph"/>The table shows configuration options for session fixation.<p class="paragraph"/><table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th><strong class="bold">Property</strong></th><th><strong class="bold">Default Value</strong></th><th><strong class="bold">Meaning</strong></th></tr><tr class="table-odd"><td>useSessionFixationPrevention</td><td><code>false</code></td><td>Whether to use session fixation prevention.</td></tr><tr class="table-even"><td>sessionFixationPrevention.migrate</td><td><code>true</code></td><td>Whether to copy the session attributes of the existing session to the new session after login.</td></tr><tr class="table-odd"><td>sessionFixationPrevention.alwaysCreateSession</td><td><code>false</code></td><td>Whether to always create a session even if one did not exist at the start of the request.</td></tr></table>
<h1><a name="20 Logout Handlers">20 Logout Handlers</a></h1>You register a list of logout handlers by implementing the <a href="http://static.springsource.org/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/web/authentication/logout/LogoutHandler.html" target="blank">LogoutHandler</a> interface. The list is called when a user explicitly logs out.<p class="paragraph"/>By default, a <code>securityContextLogoutHandler</code> bean is registered to clear the <a href="http://static.springsource.org/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/core/context/SecurityContextHolder.html" target="blank">SecurityContextHolder</a>. Also, unless you are using Facebook or OpenID, <code>rememberMeServices</code> bean is registered to reset your cookie. (Facebook and OpenID authenticate externally so we don't have access to the password to create a remember-me cookie.) If you are using Facebook, a <code>facebookLogoutHandler</code> is registered to reset its session cookies.<p class="paragraph"/>To customize this list, you define a <code>logout.handlerNames</code> attribute with a list of bean names.<p class="paragraph"/><table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th><strong class="bold">Property</strong></th><th><strong class="bold">Default Value</strong></th><th><strong class="bold">Meaning</strong></th></tr><tr class="table-odd"><td>logout.handlerNames</td><td>&#91;'rememberMeServices', 'securityContextLogoutHandler'&#93;</td><td>Logout handler bean names.</td></tr></table><p class="paragraph"/>The beans must be declared either by the plugin or by you in <code>resources.groovy</code> or <code>resources.xml</code>. For example, suppose you have a custom <code>MyLogoutHandler</code> in <code>resources.groovy</code>:<p class="paragraph"/><div class="code"><pre>beans = &#123;
   myLogoutHandler(com.foo.MyLogoutHandler) &#123;
      // attributes
   &#125;
&#125;</pre></div><p class="paragraph"/>You register it in <code>grails-app/conf/Config.groovy</code> as:<p class="paragraph"/><div class="code"><pre>grails.plugins.springsecurity.logout.handlerNames = &#91;
   'rememberMeServices', 'securityContextLogoutHandler', 'myLogoutHandler'
&#93;</pre></div>
<h1><a name="21 Voters">21 Voters</a></h1>You can register a list of voters by implementing the <a href="http://static.springsource.org/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/access/AccessDecisionVoter.html" target="blank">AccessDecisionVoter</a> interface. The list confirms whether a successful authentication is applicable for the current request.<p class="paragraph"/><table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th><strong class="bold">Property</strong></th><th><strong class="bold">Default Value</strong></th><th><strong class="bold">Meaning</strong></th></tr><tr class="table-odd"><td>voterNames</td><td>&#91;'authenticatedVoter', 'roleVoter'&#93;</td><td>Bean names of voters.</td></tr></table><p class="paragraph"/>By default a <code>roleVoter</code> bean is registered to ensure users have the required roles for the request, and an <code>authenticatedVoter</code> bean is registered to support <code>IS_AUTHENTICATED_FULLY</code>, <code>IS_AUTHENTICATED_REMEMBERED</code>, and <code>IS_AUTHENTICATED_ANONYMOUSLY</code> tokens.<p class="paragraph"/>To customize this list, you define a <code>voterNames</code> attribute with a list of bean names. The beans must be declared either by the plugin, or yourself in resources.groovy or resources.xml. Suppose you have a custom MyAccessDecisionVoter in resources.groovy:<p class="paragraph"/><div class="code"><pre>beans = &#123;
   myAccessDecisionVoter(com.foo.MyAccessDecisionVoter) &#123;
      // attributes
   &#125;
&#125;</pre></div><p class="paragraph"/>You register it in <code>grails-app/conf/Config.groovy</code> as:<p class="paragraph"/><div class="code"><pre>grails.plugins.springsecurity.voterNames = &#91;
   'authenticatedVoter', 'roleVoter', 'myAccessDecisionVoter'
&#93;</pre></div>
<h1><a name="22 Miscellaneous Properties">22 Miscellaneous Properties</a></h1><table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th><strong class="bold">Property</strong></th><th><strong class="bold">Default Value</strong></th><th><strong class="bold">Meaning</strong></th></tr><tr class="table-odd"><td>active</td><td><code>true</code></td><td>Whether the plugin is enabled.</td></tr><tr class="table-even"><td>rejectIfNoRule</td><td><code>false</code></td><td>'strict' mode where an explicit grant is required to access any resource; if <code>true</code> make sure to allow <code>IS_AUTHENTICATED_ANONYMOUSLY</code> for '/', '/js/&#42;&#42;', '/css/&#42;&#42;', '/images/&#42;&#42;', '/login/&#42;&#42;', '/logout/&#42;&#42;', and so on.</td></tr><tr class="table-odd"><td>anon.key</td><td>'foo'</td><td>anonymousProcessingFilter key.</td></tr><tr class="table-even"><td>anon.userAttribute</td><td>'anonymousUser, ROLE_ANONYMOUS'</td><td>anonymousProcessingFilter username and role.</td></tr><tr class="table-odd"><td>atr.anonymousClass</td><td><a href="http://static.springsource.org/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/authentication/AnonymousAuthenticationToken.html" target="blank">AnonymousAuthenticationToken</a></td><td>Anonymous token class.</td></tr><tr class="table-even"><td>useHttpSessionEventPublisher</td><td><code>false</code></td><td>If <code>true</code>, an <a href="http://static.springsource.org/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/web/session/HttpSessionEventPublisher.html" target="blank">HttpSessionEventPublisher</a> will be configured.</td></tr><tr class="table-odd"><td>cacheUsers</td><td><code>false</code></td><td>If <code>true</code>, logins are cached using an <code>EhCache</code>. See <a href="../guide/single.html#12.3 Account Locking and Forcing Password Change" class="guide">Account Locking and Forcing Password Change, under User Cache</a>.</td></tr><tr class="table-even"><td>useSecurityEventListener</td><td><code>false</code></td><td>If <code>true</code>, configure <code>SecurityEventListener</code>. See <a href="../guide/single.html#7 Events" class="guide">Events</a>.</td></tr><tr class="table-odd"><td>dao.reflectionSaltSourceProperty</td><td>none</td><td>Which property to use for the reflection-based salt source. See <a href="../guide/single.html#12.2 Salted Passwords" class="guide">Salted Passwords</a></td></tr><tr class="table-even"><td>dao.hideUserNotFoundExceptions</td><td><code>true</code></td><td>if <code>true</code>, throws a new <code>BadCredentialsException</code> if a username is not found or the password is incorrect, but if <code>false</code> re-throws the <code>UsernameNotFoundException</code> thrown by <code>UserDetailsService</code> (considered less secure than throwing <code>BadCredentialsException</code> for both exceptions)</td></tr><tr class="table-odd"><td>requestCache.onlyOnGet</td><td><code>false</code></td><td>Whether to cache only a <a href="http://static.springsource.org/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/web/savedrequest/SavedRequest.html" target="blank">SavedRequest</a> on GET requests.</td></tr><tr class="table-even"><td>requestCache.createSession</td><td><code>true</code></td><td>Whether caching <code>SavedRequest</code> can trigger the creation of a session.</td></tr><tr class="table-odd"><td>authenticationDetails.authClass</td><td><a href="http://static.springsource.org/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/web/authentication/WebAuthenticationDetails.html" target="blank">WebAuthenticationDetails</a></td><td>The <code>Authentication</code> details class to use.</td></tr><tr class="table-even"><td>roleHierarchy</td><td>none</td><td>Hierarchical role definition. See <a href="../guide/single.html#14 Hierarchical Roles" class="guide">Hierarchical Role Definition</a>.</td></tr><tr class="table-odd"><td>voterNames</td><td>&#91;'authenticatedVoter', 'roleVoter'&#93;</td><td>Bean names of voters. See <a href="../guide/single.html#21 Voters" class="guide">Voters</a>.</td></tr><tr class="table-even"><td>providerNames</td><td>&#91;'daoAuthenticationProvider', 'anonymousAuthenticationProvider', 'rememberMeAuthenticationProvider'&#93;</td><td>Bean names of authentication providers. See <a href="../guide/single.html#10 Authentication Providers" class="guide">Authentication Providers</a>.</td></tr><tr class="table-odd"><td>securityConfigType</td><td>Type of request mapping to use</td><td>One of "Annotation", "Requestmap", or "InterceptUrlMap" (or the corresponding enum value from <code>SecurityConfigType</code>). See <a href="../guide/single.html#5 Configuring Request Mappings to Secure URLs" class="guide">Configuring Request Mappings to Secure URLs</a>.</td></tr><tr class="table-even"><td>controllerAnnotations.matcher</td><td>'ant'</td><td>Use an Ant-style URL matcher ('ant') or Regex ('regex').</td></tr><tr class="table-odd"><td>controllerAnnotations.lowercase</td><td><code>true</code></td><td>Whether to do URL comparisons using lowercase.</td></tr><tr class="table-even"><td>controllerAnnotations.staticRules</td><td>none</td><td>Extra rules that cannot be mapped using annotations.</td></tr><tr class="table-odd"><td>interceptUrlMap</td><td>none</td><td>Request mapping definition when using "InterceptUrlMap". See <a href="../guide/single.html#5.2 Simple Map in Config.groovy" class="guide">Simple Map in Config.groovy</a>.</td></tr><tr class="table-even"><td>registerLoggerListener</td><td><code>false</code></td><td>If <code>true</code>, registers a <a href="http://static.springsource.org/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/access/event/LoggerListener.html" target="blank">LoggerListener</a> that logs interceptor-related application events.</td></tr></table>
<h1><a name="23 Tutorials">23 Tutorials</a></h1><h2><a name="23.1 Using Controller Annotations to Secure URLs">23.1 Using Controller Annotations to Secure URLs</a></h2><h4>1. Create your Grails application.</h4><p class="paragraph"/><div class="code"><pre>$ grails create&#45;app bookstore
$ cd bookstore</pre></div>
<h4>2. Install the plugin.</h4>
<div class="code"><pre>$ grails install&#45;plugin spring&#45;security&#45;core</pre></div>
<h4>3. Create the User and Role domain classes.</h4>
<div class="code"><pre>$ grails s2&#45;quickstart com.testapp User Role</pre></div><p class="paragraph"/>You can choose your names for your domain classes and package; these are just examples.<p class="paragraph"/><blockquote class="note">
Depending on your database, some domain class names might not be valid, especially those relating to security. Before you create names like "User" or "Group", make sure they are not reserved keywords in your database.
</blockquote><p class="paragraph"/>The script creates this User class:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> com.testapp<p class="paragraph"/><span class="java&#45;keyword">package</span> test<p class="paragraph"/>class User &#123;<p class="paragraph"/>   <span class="java&#45;keyword">transient</span> springSecurityService<p class="paragraph"/>   <span class="java&#45;object">String</span> username
   <span class="java&#45;object">String</span> password
   <span class="java&#45;object">boolean</span> enabled
   <span class="java&#45;object">boolean</span> accountExpired
   <span class="java&#45;object">boolean</span> accountLocked
   <span class="java&#45;object">boolean</span> passwordExpired<p class="paragraph"/>   <span class="java&#45;keyword">static</span> constraints = &#123;
      username blank: <span class="java&#45;keyword">false</span>, unique: <span class="java&#45;keyword">true</span>
      password blank: <span class="java&#45;keyword">false</span>
   &#125;<p class="paragraph"/>   <span class="java&#45;keyword">static</span> mapping = &#123;
      password column: '`password`'
   &#125;<p class="paragraph"/>   Set&#60;Role&#62; getAuthorities() &#123;
      UserRole.findAllByUser(<span class="java&#45;keyword">this</span>).collect &#123; it.role &#125; as Set
   &#125;<p class="paragraph"/>   def beforeInsert() &#123;
      encodePassword()
   &#125;<p class="paragraph"/>   def beforeUpdate() &#123;
      <span class="java&#45;keyword">if</span> (isDirty('password')) &#123;
         encodePassword()
      &#125;
   &#125;<p class="paragraph"/>   <span class="java&#45;keyword">protected</span> void encodePassword() &#123;
      password = springSecurityService.encodePassword(password)
   &#125;
&#125;</pre></div><p class="paragraph"/><blockquote class="note">
Earlier versions of the plugin didn't include password encryption logic in the domain class, but it makes the code a lot cleaner.
</blockquote><p class="paragraph"/>and this Role class:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> com.testapp<p class="paragraph"/>class Role &#123;<p class="paragraph"/>   <span class="java&#45;object">String</span> authority<p class="paragraph"/>   <span class="java&#45;keyword">static</span> mapping = &#123;
      cache <span class="java&#45;keyword">true</span>
   &#125;<p class="paragraph"/>   <span class="java&#45;keyword">static</span> constraints = &#123;
      authority blank: <span class="java&#45;keyword">false</span>, unique: <span class="java&#45;keyword">true</span>
   &#125;
&#125;</pre></div><p class="paragraph"/>and a domain class that maps the many-to-many join class, <code>UserRole</code>:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> com.testapp<p class="paragraph"/><span class="java&#45;keyword">import</span> org.apache.commons.lang.builder.HashCodeBuilder<p class="paragraph"/>class UserRole <span class="java&#45;keyword">implements</span> Serializable &#123;<p class="paragraph"/>   User user
   Role role<p class="paragraph"/>   <span class="java&#45;object">boolean</span> equals(other) &#123;
      <span class="java&#45;keyword">if</span> (!(other <span class="java&#45;keyword">instanceof</span> UserRole)) &#123;
         <span class="java&#45;keyword">return</span> <span class="java&#45;keyword">false</span>
      &#125;<p class="paragraph"/>      other.user?.id == user?.id &#38;&#38;
         other.role?.id == role?.id
   &#125;<p class="paragraph"/>   <span class="java&#45;object">int</span> hashCode() &#123;
      def builder = <span class="java&#45;keyword">new</span> HashCodeBuilder()
      <span class="java&#45;keyword">if</span> (user) builder.append(user.id)
      <span class="java&#45;keyword">if</span> (role) builder.append(role.id)
      builder.toHashCode()
   &#125;<p class="paragraph"/>   <span class="java&#45;keyword">static</span> UserRole get(<span class="java&#45;object">long</span> userId, <span class="java&#45;object">long</span> roleId) &#123;
      find 'from UserRole where user.id=:userId and role.id=:roleId',
         &#91;userId: userId, roleId: roleId&#93;
   &#125;<p class="paragraph"/>   <span class="java&#45;keyword">static</span> UserRole create(User user, Role role, <span class="java&#45;object">boolean</span> flush = <span class="java&#45;keyword">false</span>) &#123;
      <span class="java&#45;keyword">new</span> UserRole(user: user, role: role).save(flush: flush, insert: <span class="java&#45;keyword">true</span>)
   &#125;<p class="paragraph"/>   <span class="java&#45;keyword">static</span> <span class="java&#45;object">boolean</span> remove(User user, Role role, <span class="java&#45;object">boolean</span> flush = <span class="java&#45;keyword">false</span>) &#123;
      UserRole instance = UserRole.findByUserAndRole(user, role)
      <span class="java&#45;keyword">if</span> (!instance) &#123;
         <span class="java&#45;keyword">return</span> <span class="java&#45;keyword">false</span>
      &#125;<p class="paragraph"/>      instance.delete(flush: flush)
      <span class="java&#45;keyword">true</span>
   &#125;<p class="paragraph"/>   <span class="java&#45;keyword">static</span> void removeAll(User user) &#123;
      executeUpdate 'DELETE FROM UserRole WHERE user=:user', &#91;user: user&#93;
   &#125;<p class="paragraph"/>   <span class="java&#45;keyword">static</span> mapping = &#123;
      id composite: &#91;'role', 'user'&#93;
      version <span class="java&#45;keyword">false</span>
   &#125;
&#125;</pre></div><p class="paragraph"/>It also creates some UI controllers and GSPs:
<ul class="star">
<li><code>grails-app/controllers/LoginController.groovy</code></li>
<li><code>grails-app/controllers/LogoutController.groovy</code></li>
<li><code>grails-app/views/auth.gsp</code></li>
<li><code>grails-app/views/denied.gsp</code></li>
</ul><p class="paragraph"/>The script has edited <code>grails-app/conf/Config.groovy</code> and added the configuration for your domain classes. Make sure that the changes are correct.<p class="paragraph"/><blockquote class="note">
These generated files are not part of the plugin - these are your application files. They are examples to get you started, so you can edit them as you please. They contain the minimum needed for the plugin.
</blockquote><p class="paragraph"/>The plugin has no support for CRUD actions and GSPs for your domain classes; the <code>spring-security-ui</code> plugin will supply a UI for those. So for now you will create roles and users in <code>grails-app/conf/BootStrap.groovy</code>. (See step 7.)<p class="paragraph"/><h4>4. Create a controller that will be restricted by role.</h4>
<div class="code"><pre>$ grails create&#45;controller com.testapp.Secure</pre></div><p class="paragraph"/>This command creates <code>grails-app/controllers/com/testapp/SecureController.groovy</code>. Add some output so you can verify that things are working:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> com.testapp<p class="paragraph"/>class SecureController &#123;
   def index = &#123;
      render 'Secure access only'
   &#125;
&#125;</pre></div><p class="paragraph"/><h4>5. Start the server.</h4>
<div class="code"><pre>$ grails run&#45;app</pre></div><p class="paragraph"/><h4>6. Before you secure the page, navigate to <a href="http://localhost:8080/bookstore/secure" target="blank">http://localhost:8080/bookstore/secure</a> to verify that you can see the page without being logged in.</h4><p class="paragraph"/><h4>7. Shut down the app (using CTRL-C) and edit grails-app/conf/BootStrap.groovy to add the security objects that you need.</h4><p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> com.testapp.Role
<span class="java&#45;keyword">import</span> com.testapp.User
<span class="java&#45;keyword">import</span> com.testapp.UserRole<p class="paragraph"/>class BootStrap &#123;<p class="paragraph"/>   def init = &#123; servletContext &#45;&#62;<p class="paragraph"/>      def adminRole = <span class="java&#45;keyword">new</span> Role(authority: 'ROLE_ADMIN').save(flush: <span class="java&#45;keyword">true</span>)
      def userRole = <span class="java&#45;keyword">new</span> Role(authority: 'ROLE_USER').save(flush: <span class="java&#45;keyword">true</span>)<p class="paragraph"/>      def testUser = <span class="java&#45;keyword">new</span> User(username: 'me', enabled: <span class="java&#45;keyword">true</span>, password: 'password')
      testUser.save(flush: <span class="java&#45;keyword">true</span>)<p class="paragraph"/>      UserRole.create testUser, adminRole, <span class="java&#45;keyword">true</span><p class="paragraph"/>      assert User.count() == 1
      assert Role.count() == 2
      assert UserRole.count() == 1
   &#125;
&#125;</pre></div><p class="paragraph"/>Some things to note about the preceding <code>BootStrap.groovy</code>:
<ul class="star">
<li>The example does not use a traditional GORM many-to-many mapping for the User&#60;-&#62;Role relationship; instead you are mapping the join table with the <code>UserRole</code> class. This performance optimization helps significantly when many users have one or more common roles.</li>
<li>We explicitly flushed the creates because <code>BootStrap</code> does not run in a transaction or OpenSessionInView.</li>
</ul><p class="paragraph"/><h4>8. Edit grails-app/controllers/SecureController.groovy to import the annotation class and apply the annotation to restrict access.</h4><p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> com.testapp<p class="paragraph"/><span class="java&#45;keyword">import</span> grails.plugins.springsecurity.Secured<p class="paragraph"/>class SecureController &#123;<p class="paragraph"/>   @Secured(&#91;'ROLE_ADMIN'&#93;)
   def index = &#123;
      render 'Secure access only'
   &#125;
&#125;</pre></div><p class="paragraph"/>or<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> com.testapp<p class="paragraph"/><span class="java&#45;keyword">import</span> grails.plugins.springsecurity.Secured<p class="paragraph"/>@Secured(&#91;'ROLE_ADMIN'&#93;)
class SecureController &#123;
   def index = &#123;
      render 'Secure access only'
   &#125;
&#125;</pre></div><p class="paragraph"/>You can annotate the entire controller or individual actions. In this case you have only one action, so you can do either.<p class="paragraph"/><h4>9. Run grails run-app again and navigate to <a href="http://localhost:8080/bookstore/secure" target="blank">http://localhost:8080/bookstore/secure</a>.</h4><p class="paragraph"/>This time, you should be presented with the login page. Log in with the username and password you used for the test user, and you should again be able to see the secure page.<p class="paragraph"/><h4>10. Test the Remember Me functionality.</h4>
Check the checkbox, and once you've tested the secure page, close your browser and reopen it. Navigate again the the secure page. Because a is cookie stored, you should not need to log in again. Logout at any time by navigating to <a href="http://localhost:8080/bookstore/logout" target="blank">http://localhost:8080/bookstore/logout</a>.<p class="paragraph"/><h4>11. Optionally, create a CRUD UI to work with users and roles.</h4><p class="paragraph"/><h5>Run grails generate-all for the domain classes:</h5><p class="paragraph"/><div class="code"><pre>$ grails generate&#45;all com.testapp.User</pre></div><p class="paragraph"/><div class="code"><pre>$ grails generate&#45;all com.testapp.Role</pre></div><p class="paragraph"/>Since the User domain class handles password encryption, there are no changes required in the generated controllers.
<h2><a name="23.2 Migration From the Acegi Plugin">23.2 Migration From the Acegi Plugin</a></h2>In this tutorial we'll discuss the general steps required to migrate from the Acegi plugin to the Spring Security Core plugin. A lot of the material here comes from <a href="http://grails.1312388.n4.nabble.com/Migrating-Acegi-plugin-to-new-Security-plugin-td2290399.html" target="blank">an email</a> that Lubos Pochman sent to the <a href="http://www.grails.org/Mailing+lists" target="blank">User mailing list</a> documenting the steps he took to upgrade from the Acegi plugin.<p class="paragraph"/>This isn't a standard step-by-step tutorial since every application is different and the steps required will vary from project to project. Instead these are guidelines and things to keep in mind. You should also read <a href="../guide/single.html#2 Differences Between the Spring Security and Acegi Plugins" class="guide">Section 2</a> and <a href="../guide/single.html#3 Migrating from the Acegi Plugin" class="guide">Section 3</a>.<p class="paragraph"/>The first thing to do is uninstall the Acegi plugin
<div class="code"><pre>$ grails uninstall&#45;plugin acegi</pre></div>
and install Spring Security Core
<div class="code"><pre>$ grails install&#45;plugin spring&#45;security&#45;core</pre></div><p class="paragraph"/>If this were a new project the next step would be to run the <a href="../ref/Scripts/s2-quickstart.html" class="Scripts">s2-quickstart</a> script but you wouldn't do this for an existing project where you already have a User and Role class, so it's a good idea to work through the <a href="../guide/single.html#23.1 Using Controller Annotations to Secure URLs" class="guide">bookstore tutorial</a> and use the files generated in that project. The files that the script generates are
<ul class="star">
<li><code>grails-app/domain/com/testapp/User.groovy</code></li>
<li><code>grails-app/domain/com/testapp/Role.groovy</code></li>
<li><code>grails-app/domain/com/testapp/UserRole.groovy</code></li>
<li><code>grails-app/controllers/LoginController.groovy</code></li>
<li><code>grails-app/controllers/LogoutController.groovy</code></li>
<li><code>grails-app/views/login/auth.gsp</code></li>
<li><code>grails-app/views/login/denied.gsp</code></li>
</ul><p class="paragraph"/>Migrate any changes you made in <code>LoginController.groovy</code>, <code>LogoutController.groovy</code>, <code>auth.gsp</code> and <code>denied.gsp</code>, and overwrite your files with those. Do the same for <code>User.groovy</code> and <code>Role.groovy</code>, and move <code>UserRole.groovy</code> into your project.<p class="paragraph"/><h4>User and Role UI</h4><p class="paragraph"/>You can use the standard Grails <code>generate-all</code> script to create a UI to manage Users and Roles as described in the previous tutorial, or for a more complete solution use the <a href="http://grails.org/plugin/spring-security-ui" target="blank">Spring Security UI</a> plugin.<p class="paragraph"/><h4>authenticateService</h4><p class="paragraph"/>The utility service in Spring Security Core is <code>SpringSecurityService</code>, so you need to replace <code>def authenticateService</code> with <code>def springSecurityService</code>. Many of the methods have the same names and signatures but there are some differences:
<ul class="star">
<li><code>principal()</code> was renamed to <code>getPrincipal()</code></li>
<li><code>ifAllGranted()</code>, <code>ifNotGranted()</code>, and <code>ifAnyGranted()</code> were removed; use <code>org.codehaus.groovy.grails.plugins.springsecurity.SpringSecurityUtils.ifAllGranted()</code>, <code>ifNotGranted()</code>, and <code>ifAnyGranted()</code> instead</li>
<li><code>getSecurityConfig()</code> was removed, use <code>SpringSecurityUtils.getSecurityConfig()</code> instead</li>
</ul><p class="paragraph"/>One significant change between the plugins is that the <code>UserDetails</code> implementation (<code>GrailsUser</code>) no longer has a reference to the domain class instance. This was intended to make it easy to access User class data that's not available in the <code>Principal</code> but it has frustrating side effects due to being a disconnected Hibernate object. Instead <code>GrailsUser</code> stores the user's id so you can conveniently retrieve the instance when needed. So instead of<p class="paragraph"/><div class="code"><pre>def user = authenticateService.userDomain()
user = User.get(user.id)</pre></div><p class="paragraph"/>use this instead:<p class="paragraph"/><div class="code"><pre>def user = User.get(springSecurityService.principal.id)</pre></div><p class="paragraph"/><h4>Role granting</h4><p class="paragraph"/>The Acegi plugin uses a standard Grails many-to-many relationship (i.e. using <code>hasMany</code> and <code>belongsTo</code>) between User and Role but this will have performance problems if you have many users. Spring Security Core also uses a many-to-many relationship but maps the join table as a domain class instead of using collections. In the Acegi plugin you would grant a role to a user using
<div class="code"><pre>Role role = &#8230;
User user = &#8230;
role.addToPeople(user)</pre></div><p class="paragraph"/>and remove the grant with
<div class="code"><pre>Role role = &#8230;
User user = &#8230;
role.removeFromPeople(user)</pre></div><p class="paragraph"/>In Spring Security Core you use the helper methods in <code>UserRole</code>
<div class="code"><pre>Role role = &#8230;
User user = &#8230;
UserRole.create user, role</pre></div><p class="paragraph"/>and<p class="paragraph"/><div class="code"><pre>Role role = &#8230;
User user = &#8230;
UserRole.remove user, role</pre></div><p class="paragraph"/>which directly insert or delete rows in the User/Role join table.<p class="paragraph"/><h4>SecurityConfig.groovy</h4><p class="paragraph"/>Configuration settings are now stored in <code>grails-app/conf/Config.groovy</code> along with the rest of the application configuration. The primary motiviation for this change is to easily support environment-specific security settings. Migrate settings from <code>SecurityConfig.groovy</code> to <code>Config.groovy</code> (see <a href="../guide/single.html#3 Migrating from the Acegi Plugin" class="guide">this summary</a> for the new names.<p class="paragraph"/>In particular it's important that the following properties be configured (replace class and package names to match your domain classes):
<div class="code"><pre>grails.plugins.springsecurity.userLookup.userDomainClassName = 'com.yourcompany.yourapp.User'
grails.plugins.springsecurity.userLookup.authorityJoinClassName = 'com.yourcompany.yourapp.UserRole'
grails.plugins.springsecurity.authority.className = 'com.yourcompany.yourapp.Role'</pre></div><p class="paragraph"/>Delete <code>SecurityConfig.groovy</code> when you're finished.<p class="paragraph"/><h4>Controller annotations</h4><p class="paragraph"/>The <code>Secured</code> annotation changed from <code>org.codehaus.groovy.grails.plugins.springsecurity.Secured</code> to <code>grails.plugins.springsecurity.Secured</code>. Consider using <a href="../guide/single.html#5.4 Using Expressions to Create Descriptive, Fine-Grained Rules" class="guide">SpEL expressions</a> since they're a lot more powerful and expressive than simple role names.<p class="paragraph"/><h4>Security tags</h4>
<ul class="star">
<li>tag names now start with 'if' instead of 'is', and the <code>role</code> attribute changed to <code>roles</code>, so for example change <code>&#60;g:ifAnyGranted role='...'&#62;</code> to <code>&#60;sec:ifAnyGranted roles='...'&#62;</code></li>
<li>use <code>&#60;sec:username/&#62;</code> instead of <code>&#60;g:loggedInUserInfo(field:'username')}/&#62;</code> - use <code>&#60;sec:loggedInUserInfo&#62;</code> to render other <code>GrailsUser</code> attributes</li>
</ul><p class="paragraph"/>See more details about the taglibs in <a href="../guide/single.html#6 Helper Classes" class="guide">Section 6</a>.
<h1><a name="24 Controller MetaClass Methods">24 Controller MetaClass Methods</a></h1>The plugin registers some convenience methods into all controllers in your application. All are accessor methods, so they can be called as methods or properties. They include:<p class="paragraph"/><h4>isLoggedIn</h4><p class="paragraph"/>Returns <code>true</code> if there is an authenticated user.<p class="paragraph"/><div class="code"><pre>class MyController &#123;<p class="paragraph"/>   def someAction = &#123;
      <span class="java&#45;keyword">if</span> (isLoggedIn()) &#123;
         &#8230;
      &#125;<p class="paragraph"/>      ...<p class="paragraph"/>      <span class="java&#45;keyword">if</span> (!isLoggedIn()) &#123;
         &#8230;
      &#125;<p class="paragraph"/>      // or<p class="paragraph"/>      <span class="java&#45;keyword">if</span> (loggedIn) &#123;
         &#8230;
      &#125;<p class="paragraph"/>      <span class="java&#45;keyword">if</span> (!loggedIn) &#123;
         &#8230;
      &#125;
   &#125;
&#125;</pre></div><p class="paragraph"/><h4>getPrincipal</h4><p class="paragraph"/>Retrieves the current authenticated user's Principal (a <code>GrailsUser</code> instance unless you've customized this) or <code>null</code> if not authenticated.<p class="paragraph"/><div class="code"><pre>class MyController &#123;<p class="paragraph"/>   def someAction = &#123;
      <span class="java&#45;keyword">if</span> (isLoggedIn()) &#123;
         <span class="java&#45;object">String</span> username = getPrincipal().username
         &#8230;
      &#125;<p class="paragraph"/>      // or<p class="paragraph"/>      <span class="java&#45;keyword">if</span> (isLoggedIn()) &#123;
         <span class="java&#45;object">String</span> username = principal.username
         &#8230;
      &#125;
   &#125;
&#125;</pre></div><p class="paragraph"/><h4>getAuthenticatedUser</h4><p class="paragraph"/>Loads the user domain class instance from the database that corresponds to the currently authenticated user, or <code>null</code> if not authenticated. This is the equivalent of adding a dependency injection for <code>springSecurityService</code> and calling <code>PersonDomainClassName.get(springSecurityService.principal.id)</code> (the typical way that this is often done).<p class="paragraph"/><div class="code"><pre>class MyController &#123;<p class="paragraph"/>   def someAction = &#123;
      <span class="java&#45;keyword">if</span> (isLoggedIn()) &#123;
         <span class="java&#45;object">String</span> email = getAuthenticatedUser().email
         &#8230;
      &#125;<p class="paragraph"/>      // or<p class="paragraph"/>      <span class="java&#45;keyword">if</span> (isLoggedIn()) &#123;
         <span class="java&#45;object">String</span> email = authenticatedUser.email
         &#8230;
      &#125;
   &#125;
&#125;</pre></div>
<h1><a name="25 Internationalization">25 Internationalization</a></h1>Spring Security Core plugin is provided with English and French i18n messages.<p class="paragraph"/>If you want to customize or translate the texts then add messages for the following keys to your i18n resource bundle(s) for each exception:<p class="paragraph"/><table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th><strong class="bold">Message</strong></th><th><strong class="bold">Default Value</strong></th><th><strong class="bold">Exception</strong></th></tr><tr class="table-odd"><td>springSecurity.errors.login.expired</td><td>"Sorry, your account is disabled."</td><td>AccountExpiredException</td></tr><tr class="table-even"><td>springSecurity.errors.login.passwordExpired</td><td>"Sorry, your account has expired."</td><td>CredentialsExpiredException</td></tr><tr class="table-odd"><td>springSecurity.errors.login.disabled</td><td>"Sorry, your password has expired."</td><td>DisabledException</td></tr><tr class="table-even"><td>springSecurity.errors.login.locked</td><td>"Sorry, your account is locked."</td><td>LockedException</td></tr><tr class="table-odd"><td>springSecurity.errors.login.fail</td><td>"Sorry, we were not able to find a user with that username and password."</td><td>Other exceptions</td></tr></table><p class="paragraph"/>You can customize all messages in auth.gsp and denied.gsp:<p class="paragraph"/><table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th><strong class="bold">Message</strong></th><th><strong class="bold">Default Value</strong></th></tr><tr class="table-odd"><td>springSecurity.login.title</td><td>Login</td></tr><tr class="table-even"><td>springSecurity.login.header</td><td>Please Login..</td></tr><tr class="table-odd"><td>springSecurity.login.button</td><td>Login</td></tr><tr class="table-even"><td>springSecurity.login.username.label</td><td>Login ID</td></tr><tr class="table-odd"><td>springSecurity.login.password.label</td><td>Password</td></tr><tr class="table-even"><td>springSecurity.login.remember.me.label</td><td>Remember me</td></tr><tr class="table-odd"><td>springSecurity.denied.title</td><td>Denied</td></tr><tr class="table-even"><td>springSecurity.denied.message</td><td>Sorry, you're not authorized to view this page.</td></tr></table>

        </div>
        <div id="footer">
             
        </div>
    
<script type="text/javascript">
	var _gaq = _gaq || [];
	_gaq.push(['_setAccount', 'UA-16219500-1']);
	_gaq.push(['_trackPageview']);

	(function() {
		var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
		ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
	})();
</script>
</body>
</html>
