<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
                      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <title>22.1 Using Controller Annotations to Secure URLs 2.0-RC2</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <link rel="stylesheet" href="../css/main.css" type="text/css" media="screen, print" title="Style" charset="utf-8"/>
    <link rel="stylesheet" href="../css/pdf.css" type="text/css" media="print" title="PDF" charset="utf-8"/>
    <script type="text/javascript">
function addJsClass() {
    var classes = document.body.className.split(" ");
    classes.push("js");
    document.body.className = classes.join(" ");
}
    </script>
</head>

<body class="body" onload="addJsClass();">
<div id="navigation">
    <ul>
        <li>
            <div id="nav-summary" onmouseover="toggleNavSummary(false)" onmouseout="toggleNavSummary(true)">
                <a href="../../guide/index.html" class="button">Table of contents</a>

                <div id="nav-summary-childs" style="display:none;">
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/introduction.html"><strong>1</strong><span>Introduction to the Spring Security Plugin</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/newInV2.html"><strong>2</strong><span>What's New in Version 2.0</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/domainClasses.html"><strong>3</strong><span>Required and Optional Domain Classes</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/requestMappings.html"><strong>4</strong><span>Configuring Request Mappings to Secure URLs</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/helperClasses.html"><strong>5</strong><span>Helper Classes</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/events.html"><strong>6</strong><span>Events</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/domainClassProperties.html"><strong>7</strong><span>User, Authority (Role), and Requestmap Properties</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/authentication.html"><strong>8</strong><span>Authentication</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/authenticationProviders.html"><strong>9</strong><span>Authentication Providers</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/userDetailsService.html"><strong>10</strong><span>Custom UserDetailsService</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/passwords.html"><strong>11</strong><span>Password and Account Protection</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/urlProperties.html"><strong>12</strong><span>URL Properties</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/hierarchicalRoles.html"><strong>13</strong><span>Hierarchical Roles</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/switchUser.html"><strong>14</strong><span>Switch User</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/filters.html"><strong>15</strong><span>Filters</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/channelSecurity.html"><strong>16</strong><span>Channel Security</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/ip.html"><strong>17</strong><span>IP Address Restrictions</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/sessionFixation.html"><strong>18</strong><span>Session Fixation Prevention</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/logoutHandlers.html"><strong>19</strong><span>Logout Handlers</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/voters.html"><strong>20</strong><span>Voters</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/miscProperties.html"><strong>21</strong><span>Miscellaneous Properties</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/tutorials.html"><strong>22</strong><span>Tutorials</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/controllerMetaClassMethods.html"><strong>23</strong><span>Controller MetaClass Methods</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/i18n.html"><strong>24</strong><span>Internationalization</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/acegi.html"><strong>25</strong><span>Migrating from the Acegi plugin</span></a>
                    </div>
                    
                </div>
            </div>
        </li>
        <li class="separator selected">
            <a id="ref-button" onclick="localToggle(); return false;" href="#">Quick Reference</a>
        </li>
    </ul>
</div>
<div id="header">
    <div class="images clearfix">
        
        
    </div>
    <p>Spring Security Core plugin</p>
</div>


<table id="colset" border="0" cellpadding="0" cellspacing="0">
    <tr>
        <td id="col1">
            <div id="main" class="corner-all">

                
                    <div class="toc-item prev-left"><a href="../../guide/miscProperties.html">&lt;&lt; <strong>21</strong><span>Miscellaneous Properties</span></a></div>
                

                <span id='toggle-col1' class="toggle">(<a href="#" onclick="localToggle(); return false;">Quick Reference</a>)</span>

                
                    <div class="toc-item next-right"><a href="../../guide/controllerMetaClassMethods.html"><strong>23</strong><span>Controller MetaClass Methods</span> >></a></div>
                


                <div class="project">
                    <h1>22.1 Using Controller Annotations to Secure URLs - Reference Documentation</h1>

                    <p><strong>Authors:</strong> Burt Beckwith, Beverley Talbott</p>

                    <p><strong>Version:</strong> 2.0-RC2</p>

                    
                </div>

                

                

<h2 id="usingControllerAnnotations">22.1 Using Controller Annotations to Secure URLs</h2>
<h4>1. Create your Grails application.</h4><p class="paragraph"/><div class="code"><pre>$ grails create&#45;app bookstore
$ cd bookstore</pre></div><p class="paragraph"/><h4>2. Install the plugin by adding it to BuildConfig.groovy</h4>
<div class="code"><pre>plugins &#123;
   &#8230;
   compile ':spring&#45;security&#45;core:2.0&#45;RC2'
&#125;</pre></div><p class="paragraph"/>Note that until the 2.0 version of the plugin is officially released, you'll also need to add a custom repository:<p class="paragraph"/><div class="code"><pre>repositories &#123;
   &#8230;
   mavenRepo 'http://repo.spring.io/milestone'
&#125;</pre></div><p class="paragraph"/>Run the compile script to resolve the dependencies and ensure everything is correct:<p class="paragraph"/><div class="code"><pre>$ grails compile</pre></div><p class="paragraph"/><h4>3. Create the User and Role domain classes.</h4>
<div class="code"><pre>$ grails s2&#45;quickstart com.testapp User Role</pre></div><p class="paragraph"/>You can choose your names for your domain classes and package; these are just examples.<p class="paragraph"/><blockquote class="note">
Depending on your database, some domain class names might not be valid, especially those relating to security. Before you create names like "User" or "Group", make sure they are not reserved keywords in your database.
</blockquote><p class="paragraph"/>The script creates this User class:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> com.testapp<p class="paragraph"/><span class="java&#45;keyword">package</span> test<p class="paragraph"/>class User &#123;<p class="paragraph"/>   <span class="java&#45;keyword">transient</span> springSecurityService<p class="paragraph"/>   <span class="java&#45;object">String</span> username
   <span class="java&#45;object">String</span> password
   <span class="java&#45;object">boolean</span> enabled = <span class="java&#45;keyword">true</span>
   <span class="java&#45;object">boolean</span> accountExpired
   <span class="java&#45;object">boolean</span> accountLocked
   <span class="java&#45;object">boolean</span> passwordExpired<p class="paragraph"/>   <span class="java&#45;keyword">static</span> constraints = &#123;
      username blank: <span class="java&#45;keyword">false</span>, unique: <span class="java&#45;keyword">true</span>
      password blank: <span class="java&#45;keyword">false</span>
   &#125;<p class="paragraph"/>   <span class="java&#45;keyword">static</span> mapping = &#123;
      password column: '`password`'
   &#125;<p class="paragraph"/>   Set&#60;Role&#62; getAuthorities() &#123;
      UserRole.findAllByUser(<span class="java&#45;keyword">this</span>).collect &#123; it.role &#125; as Set
   &#125;<p class="paragraph"/>   def beforeInsert() &#123;
      encodePassword()
   &#125;<p class="paragraph"/>   def beforeUpdate() &#123;
      <span class="java&#45;keyword">if</span> (isDirty('password')) &#123;
         encodePassword()
      &#125;
   &#125;<p class="paragraph"/>   <span class="java&#45;keyword">protected</span> void encodePassword() &#123;
      password = springSecurityService.encodePassword(password)
   &#125;
&#125;</pre></div><p class="paragraph"/><blockquote class="note">
Earlier versions of the plugin didn't include password hashing logic in the domain class, but it makes the code a lot cleaner.
</blockquote><p class="paragraph"/>and this Role class:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> com.testapp<p class="paragraph"/>class Role &#123;<p class="paragraph"/>   <span class="java&#45;object">String</span> authority<p class="paragraph"/>   <span class="java&#45;keyword">static</span> mapping = &#123;
      cache <span class="java&#45;keyword">true</span>
   &#125;<p class="paragraph"/>   <span class="java&#45;keyword">static</span> constraints = &#123;
      authority blank: <span class="java&#45;keyword">false</span>, unique: <span class="java&#45;keyword">true</span>
   &#125;
&#125;</pre></div><p class="paragraph"/>and a domain class that maps the many-to-many join class, <code>UserRole</code>:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> com.testapp<p class="paragraph"/><span class="java&#45;keyword">import</span> org.apache.commons.lang.builder.HashCodeBuilder<p class="paragraph"/>class UserRole <span class="java&#45;keyword">implements</span> Serializable &#123;<p class="paragraph"/>   <span class="java&#45;keyword">private</span> <span class="java&#45;keyword">static</span> <span class="java&#45;keyword">final</span> <span class="java&#45;object">long</span> serialVersionUID = 1<p class="paragraph"/>   User user
   Role role<p class="paragraph"/>   <span class="java&#45;object">boolean</span> equals(other) &#123;
      <span class="java&#45;keyword">if</span> (!(other <span class="java&#45;keyword">instanceof</span> UserRole)) &#123;
         <span class="java&#45;keyword">return</span> <span class="java&#45;keyword">false</span>
      &#125;<p class="paragraph"/>      other.user?.id == user?.id &#38;&#38;
         other.role?.id == role?.id
   &#125;<p class="paragraph"/>   <span class="java&#45;object">int</span> hashCode() &#123;
      def builder = <span class="java&#45;keyword">new</span> HashCodeBuilder()
      <span class="java&#45;keyword">if</span> (user) builder.append(user.id)
      <span class="java&#45;keyword">if</span> (role) builder.append(role.id)
      builder.toHashCode()
   &#125;<p class="paragraph"/>   <span class="java&#45;keyword">static</span> UserRole get(<span class="java&#45;object">long</span> userId, <span class="java&#45;object">long</span> roleId) &#123;
      UserRole.where &#123;
         user == User.load(userId) &#38;&#38;
         role == Role.load(roleId)
      &#125;.get()
   &#125;<p class="paragraph"/>   <span class="java&#45;keyword">static</span> UserRole create(User user, Role role, <span class="java&#45;object">boolean</span> flush = <span class="java&#45;keyword">false</span>) &#123;
      <span class="java&#45;keyword">new</span> UserRole(user: user, role: role).save(flush: flush, insert: <span class="java&#45;keyword">true</span>)
   &#125;<p class="paragraph"/>   <span class="java&#45;keyword">static</span> <span class="java&#45;object">boolean</span> remove(User u, Role r, <span class="java&#45;object">boolean</span> flush = <span class="java&#45;keyword">false</span>) &#123;
      <span class="java&#45;object">int</span> rowCount = UserRole.where &#123;
         user == User.load(u.id) &#38;&#38;
         role == Role.load(r.id)
      &#125;.deleteAll()<p class="paragraph"/>      rowCount &#62; 0
   &#125;<p class="paragraph"/>   <span class="java&#45;keyword">static</span> void removeAll(User u) &#123;
      UserRole.where &#123;
         user == User.load(u.id)
      &#125;.deleteAll()
   &#125;<p class="paragraph"/>   <span class="java&#45;keyword">static</span> void removeAll(Role r) &#123;
      UserRole.where &#123;
         role == Role.load(r.id)
      &#125;.deleteAll()
   &#125;<p class="paragraph"/>   <span class="java&#45;keyword">static</span> mapping = &#123;
      id composite: &#91;'role', 'user'&#93;
      version <span class="java&#45;keyword">false</span>
   &#125;
&#125;</pre></div><p class="paragraph"/>The script has edited <code>grails-app/conf/Config.groovy</code> and added the configuration for your domain classes. Make sure that the changes are correct.<p class="paragraph"/><blockquote class="note">
These generated files are not part of the plugin - these are your application files. They are examples to get you started, so you can edit them as you please. They contain the minimum needed for the plugin.
</blockquote><p class="paragraph"/>The plugin has no support for CRUD actions and GSPs for your domain classes; the <code>spring-security-ui</code> plugin supplies a UI for those. So for now you will create roles and users in <code>grails-app/conf/BootStrap.groovy</code>. (See step 7.)<p class="paragraph"/><h4>4. Create a controller that will be restricted by role.</h4>
<div class="code"><pre>$ grails create&#45;controller com.testapp.Secure</pre></div><p class="paragraph"/>This command creates <code>grails-app/controllers/com/testapp/ SecureController.groovy</code>. Add some output so you can verify that things are working:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> com.testapp<p class="paragraph"/>class SecureController &#123;
   def index() &#123;
      render 'Secure access only'
   &#125;
&#125;</pre></div><p class="paragraph"/><h4>5. Start the server.</h4>
<div class="code"><pre>$ grails run&#45;app</pre></div><p class="paragraph"/><h4>6. Before you secure the page, navigate to <a href="http://localhost:8080/bookstore/secure" target="blank">http://localhost:8080/bookstore/secure</a> to verify that you can see the page without being logged in.</h4><p class="paragraph"/><h4>7. Shut down the app (using CTRL-C) and edit grails-app/conf/BootStrap.groovy to add the security objects that you need.</h4><p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> com.testapp.Role
<span class="java&#45;keyword">import</span> com.testapp.User
<span class="java&#45;keyword">import</span> com.testapp.UserRole<p class="paragraph"/>class BootStrap &#123;<p class="paragraph"/>   def init = &#123; servletContext &#45;&#62;<p class="paragraph"/>      def adminRole = <span class="java&#45;keyword">new</span> Role(authority: 'ROLE_ADMIN').save(flush: <span class="java&#45;keyword">true</span>)
      def userRole = <span class="java&#45;keyword">new</span> Role(authority: 'ROLE_USER').save(flush: <span class="java&#45;keyword">true</span>)<p class="paragraph"/>      def testUser = <span class="java&#45;keyword">new</span> User(username: 'me', password: 'password')
      testUser.save(flush: <span class="java&#45;keyword">true</span>)<p class="paragraph"/>      UserRole.create testUser, adminRole, <span class="java&#45;keyword">true</span><p class="paragraph"/>      assert User.count() == 1
      assert Role.count() == 2
      assert UserRole.count() == 1
   &#125;
&#125;</pre></div><p class="paragraph"/>Some things to note about the preceding <code>BootStrap.groovy</code>:
<ul class="star">
<li>The example does not use a traditional GORM many-to-many mapping for the User&#60;-&#62;Role relationship; instead you are mapping the join table with the <code>UserRole</code> class. This performance optimization helps significantly when many users have one or more common roles.</li>
<li>We explicitly flushed the creates because <code>BootStrap</code> does not run in a transaction or OpenSessionInView.</li>
</ul><p class="paragraph"/><h4>8. Edit grails-app/controllers/SecureController.groovy to import the annotation class and apply the annotation to restrict access.</h4><p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> com.testapp<p class="paragraph"/><span class="java&#45;keyword">import</span> grails.plugin.springsecurity.annotation.Secured<p class="paragraph"/>class SecureController &#123;<p class="paragraph"/>   @Secured(&#91;'ROLE_ADMIN'&#93;)
   def index() &#123;
      render 'Secure access only'
   &#125;
&#125;</pre></div><p class="paragraph"/>or<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> com.testapp<p class="paragraph"/><span class="java&#45;keyword">import</span> grails.plugin.springsecurity.annotation.Secured<p class="paragraph"/>@Secured(&#91;'ROLE_ADMIN'&#93;)
class SecureController &#123;
   def index() &#123;
      render 'Secure access only'
   &#125;
&#125;</pre></div><p class="paragraph"/>You can annotate the entire controller or individual actions. In this case you have only one action, so you can do either.<p class="paragraph"/><h4>9. Run grails run-app again and navigate to <a href="http://localhost:8080/bookstore/secure" target="blank">http://localhost:8080/bookstore/secure</a>.</h4><p class="paragraph"/>This time, you should be presented with the login page. Log in with the username and password you used for the test user, and you should again be able to see the secure page.<p class="paragraph"/><h4>10. Test the Remember Me functionality.</h4>
Check the checkbox, and once you've tested the secure page, close your browser and reopen it. Navigate again the the secure page. Because a is cookie stored, you should not need to log in again. Logout at any time by navigating to <a href="http://localhost:8080/bookstore/logout" target="blank">http://localhost:8080/bookstore/logout</a>.<p class="paragraph"/><h4>11. Optionally, create a CRUD UI to work with users and roles.</h4><p class="paragraph"/><h5>Run grails generate-all for the domain classes:</h5><p class="paragraph"/><div class="code"><pre>$ grails generate&#45;all com.testapp.User</pre></div><p class="paragraph"/><div class="code"><pre>$ grails generate&#45;all com.testapp.Role</pre></div><p class="paragraph"/>Since the User domain class handles password hashing, there are no changes required in the generated controllers.



                <div style="clear:both;margin-top:15px;"></div>
                
                    <div class="toc-item prev-left"><a href="../../guide/miscProperties.html">&lt;&lt; <strong>21</strong><span>Miscellaneous Properties</span></a></div>
                
                    <div class="toc-item next-right"><a href="../../guide/controllerMetaClassMethods.html"><strong>23</strong><span>Controller MetaClass Methods</span> >></a></div>
                
                <div style="clear:both"></div>
            </div>
        </td>
        <td id="col2">
            <div class="local clearfix">
                <div class="local-title">
                    <a href="../../guide/index.html" target="mainFrame">Quick Reference</a>
                    <span class="toggle">(<a href="#" onclick="localToggle(); return false;">hide</a>)</span>
                </div>
                <div class="menu">
                    
                    <div class="menu-block"><h1 class="menu-title" onclick="toggleRef(this.parentNode.childNodes[1])">Scripts</h1><div class="menu-sub">
                        
                            
                            <div class="menu-item"><a href="../../ref/Scripts/s2-create-persistent-token.html">s2-create-persistent-token</a>
                            </div>
                            
                            <div class="menu-item"><a href="../../ref/Scripts/s2-quickstart.html">s2-quickstart</a>
                            </div>
                            
                            </div>
                    </div>
                    
                </div>
            </div>
        </td>
    </tr>
</table>

<div id="footer">
    
    
</div>

<script type="text/javascript" src="../js/docs.js"></script>


<script type="text/javascript">
	var _gaq = _gaq || [];
	_gaq.push(['_setAccount', 'UA-16219500-1']);
	_gaq.push(['_trackPageview']);

	(function() {
		var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
		ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
	})();
</script>
</body>
</html>
